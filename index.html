<!DOCTYPE html>
<html lang="es" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ======================================================================== */
        /* == ESTILOS DEL SISTEMA DE AUTENTICACIÓN (LOGIN, REGISTRO, ETC.) == */
        /* ======================================================================== */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20000;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
            transition: opacity 0.3s ease-in-out;
        }
        #auth-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .form-container {
            width: 100%; max-width: 440px; border-radius: 0.75rem; background-color: #ffffff;
            padding: 2.5rem; color: #1c1e21; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            box-sizing: border-box; transition: all 0.3s ease;
        }
        .form-logo { display: block; margin: 0 auto 1.5rem auto; height: 70px; width: auto; }
        .form-container .title { text-align: center; font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; }
        .form-container .subtitle { text-align: center; color: #606770; margin-bottom: 1.5rem; font-size: 0.95rem; }
        .form-container .form { margin-top: 1rem; }
        .form-container .input-group { margin-bottom: 1.25rem; }
        .form-container .input-group label { display: block; color: #333333; margin-bottom: 8px; font-weight: 500; }
        .form-container .input-group input {
            width: 100%; border-radius: 0.375rem; border: 1px solid #dddfe2; outline: 0; background-color: #ffffff;
            padding: 0.85rem 1rem; color: #1c1e21; box-sizing: border-box; font-size: 1rem;
        }
        .form-container .input-group input:focus { border-color: #1877f2; box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2); }
        #password-requirements { font-size: 0.8rem; margin-top: 0.5rem; color: #606770; line-height: 1.4; }
        #password-requirements span { transition: color 0.3s ease; }
        #password-requirements .invalid { color: #fa383e; }
        #password-requirements .valid { color: #00a400; }
        .form-container .sign {
            display: block; width: 100%; background-color: #1c2b4c; padding: 0.85rem; text-align: center;
            color: #ffffff; border: none; border-radius: 0.375rem; font-weight: 600; font-size: 1.05rem;
            cursor: pointer; transition: background-color 0.2s ease-in-out; margin-top: 1.5rem;
        }
        .form-container .sign:hover { background-color: #2a3f6d; }
        .form-container .sign:disabled { background-color: #a0aec0; cursor: not-allowed; }
        .form-container .actions { text-align: center; font-size: 0.9rem; color: #606770; margin-top: 1.5rem; }
        .form-container .actions a { color: #1877f2; text-decoration: none; font-weight: 500; cursor: pointer; }
        .form-container .actions p { margin-bottom: 0.5rem; }
        .form-container .message {
            text-align: center; padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem; font-size: 0.95rem;
        }
        .form-container .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .form-container .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #register-success-view { cursor: pointer; }

        /* ======================================================================== */
        /* == ESTILOS DEL DASHBOARD DEL CRM (COMPLETOS) == */
        /* ======================================================================== */
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(29, 111, 182, 1);
          --color-teal-600: rgba(26, 98, 161, 1);
          --color-teal-700: rgba(23, 86, 140, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);
          --color-blue-400: rgba(59, 130, 246, 1);
          --color-blue-500: rgba(37, 99, 235, 1);
          --color-blue-600: rgba(29, 78, 216, 1);
          --color-green-500: rgba(34, 197, 94, 1);
          --color-green-400: rgba(52, 211, 153, 1);
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 29, 111, 182;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;
          --color-blue-400-rgb: 59, 130, 246;
          --color-green-500-rgb: 34, 197, 94;
          --color-green-400-rgb: 52, 211, 153;
          --color-bg-1: rgba(59, 130, 246, 0.08);
          --color-bg-2: rgba(245, 158, 11, 0.08);
          --color-bg-3: rgba(34, 197, 94, 0.08);
          --color-bg-4: rgba(239, 68, 68, 0.08);
          --color-bg-5: rgba(147, 51, 234, 0.08);
          --color-bg-6: rgba(249, 115, 22, 0.08);
          --color-bg-7: rgba(236, 72, 153, 0.08);
          --color-bg-8: rgba(6, 182, 212, 0.08);
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-green-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
          --color-success-rgb: var(--color-green-500-rgb);
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
          --font-size-xs: 11px; --font-size-sm: 12px; --font-size-base: 14px; --font-size-md: 14px;
          --font-size-lg: 16px; --font-size-xl: 18px; --font-size-2xl: 20px; --font-size-3xl: 24px; --font-size-4xl: 30px;
          --font-weight-normal: 400; --font-weight-medium: 500; --font-weight-semibold: 550; --font-weight-bold: 600;
          --line-height-tight: 1.2; --line-height-normal: 1.5; --letter-spacing-tight: -0.01em;
          --space-0: 0; --space-1: 1px; --space-2: 2px; --space-4: 4px; --space-6: 6px; --space-8: 8px;
          --space-10: 10px; --space-12: 12px; --space-16: 16px; --space-20: 20px; --space-24: 24px; --space-32: 32px;
          --radius-sm: 6px; --radius-base: 8px; --radius-md: 10px; --radius-lg: 12px; --radius-full: 9999px;
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);
          --duration-fast: 150ms; --duration-normal: 250ms; --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
          --container-sm: 640px; --container-md: 768px; --container-lg: 1024px; --container-xl: 1280px;
        }
        [data-color-scheme="dark"] {
            --color-gray-400-rgb: 119, 124, 124; --color-gray-300-rgb: 167, 169, 169; --color-gray-200-rgb: 245, 245, 245;
            --color-blue-400-rgb: 59, 130, 246; --color-green-400-rgb: 52, 211, 153;
            --color-bg-1: rgba(29, 78, 216, 0.15); --color-bg-2: rgba(180, 83, 9, 0.15); --color-bg-3: rgba(21, 128, 61, 0.15);
            --color-bg-4: rgba(185, 28, 28, 0.15); --color-bg-5: rgba(107, 33, 168, 0.15); --color-bg-6: rgba(194, 65, 12, 0.15);
            --color-bg-7: rgba(190, 24, 93, 0.15); --color-bg-8: rgba(8, 145, 178, 0.15);
            --color-background: var(--color-charcoal-700); --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200); --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-blue-400); --color-primary-hover: var(--color-blue-500); --color-primary-active: var(--color-blue-600);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15); --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3); --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400); --color-success: var(--color-green-400); --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300); --color-focus-ring: rgba(var(--color-blue-400-rgb), 0.4);
            --color-btn-primary-text: var(--color-cream-50); --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2); --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
            --color-success-rgb: var(--color-green-400-rgb); --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb); --color-info-rgb: var(--color-gray-300-rgb);
        }
        html { font-size: var(--font-size-base); font-family: var(--font-family-base); line-height: var(--line-height-normal); color: var(--color-text); background-color: var(--color-background); -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { margin: 0; padding: 0; overflow-x: hidden; }
        *, *::before, *::after { box-sizing: inherit; }
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: var(--font-weight-semibold); line-height: var(--line-height-tight); color: var(--color-text); letter-spacing: var(--letter-spacing-tight); }
        h1 { font-size: var(--font-size-4xl); } h2 { font-size: var(--font-size-3xl); } h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); } h5 { font-size: var(--font-size-lg); } h6 { font-size: var(--font-size-md); }
        p { margin: 0 0 var(--space-16) 0; }
        a { color: var(--color-primary); text-decoration: none; transition: color var(--duration-fast) var(--ease-standard); }
        a:hover { color: var(--color-primary-hover); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: var(--space-8) var(--space-16); border-radius: var(--radius-base); font-size: var(--font-size-base); font-weight: 500; line-height: 1.5; cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); border: none; text-decoration: none; position: relative; }
        .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
        .btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background: var(--color-primary-hover); }
        .btn--primary:active { background: var(--color-primary-active); }
        .btn--secondary { background: var(--color-secondary); color: var(--color-text); }
        .btn--secondary:hover { background: var(--color-secondary-hover); }
        .btn--secondary:active { background: var(--color-secondary-active); }
        .btn--outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn--danger { background-color: var(--color-error); color: white; }
        .btn--danger:hover { background-color: rgba(var(--color-red-500-rgb), 0.8); }
        .btn--outline:hover { background: var(--color-secondary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-control { display: block; width: 100%; padding: var(--space-8) var(--space-12); font-size: var(--font-size-md); line-height: 1.5; color: var(--color-text); background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); transition: border-color var(--duration-fast) var(--ease-standard), box-shadow var(--duration-fast) var(--ease-standard); }
        textarea.form-control { font-family: var(--font-family-base); font-size: var(--font-size-base); }
        select.form-control { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: var(--select-caret-light); background-repeat: no-repeat; background-position: right var(--space-12) center; background-size: 16px; padding-right: var(--space-32); }
        [data-color-scheme="dark"] select.form-control { background-image: var(--select-caret-dark); }
        .form-control:focus { border-color: var(--color-primary); outline: var(--focus-outline); }
        .form-label { display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); }
        .form-group { margin-bottom: var(--space-16); }
        .card { background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-card-border); box-shadow: var(--shadow-sm); overflow: hidden; transition: box-shadow var(--duration-normal) var(--ease-standard); }
        .card:hover { box-shadow: var(--shadow-md); }
        .card__body { padding: var(--space-16); }
        .card__header, .card__footer { padding: var(--space-16); border-bottom: 1px solid var(--color-card-border-inner); }
        .sidebar { width: 280px; background-color: var(--color-surface); border-right: 1px solid var(--color-border); display: flex; flex-direction: column; transition: width var(--duration-normal) var(--ease-standard); position: fixed; left: 0; top: 0; height: 100vh; z-index: 1000; }
        .sidebar.collapsed { width: 70px; }
        .sidebar-header { padding: var(--space-20); border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: var(--space-12); font-weight: var(--font-weight-bold); font-size: var(--font-size-xl); color: var(--color-primary); }
        .sidebar.collapsed .logo-text { display: none; }
        .sidebar-toggle { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: var(--space-8); border-radius: var(--radius-base); transition: background-color var(--duration-fast) var(--ease-standard); }
        .sidebar-toggle:hover { background-color: var(--color-secondary); }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; padding: var(--space-16); }
        .sidebar-menu ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--space-4); }
        .menu-item { display: flex; align-items: center; gap: var(--space-12); padding: var(--space-12) var(--space-16); border-radius: var(--radius-base); text-decoration: none; color: var(--color-text-secondary); transition: all var(--duration-fast) var(--ease-standard); font-weight: var(--font-weight-medium); }
        .menu-item:hover { background-color: var(--color-secondary); color: var(--color-text); }
        .menu-item.active { background-color: var(--color-primary); color: var(--color-btn-primary-text); }
        .menu-item i { width: 20px; text-align: center; }
        .sidebar.collapsed .menu-item span { display: none; }
        .sidebar-footer { padding: var(--space-16); border-top: 1px solid var(--color-border); }
        .user-profile { display: flex; align-items: center; gap: var(--space-12); }
        .user-avatar { width: 40px; height: 40px; border-radius: var(--radius-full); background-color: var(--color-primary); color: var(--color-btn-primary-text); display: flex; align-items: center; justify-content: center; font-weight: var(--font-weight-bold); font-size: var(--font-size-sm); }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); }
        .user-role { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
        .sidebar.collapsed .user-info { display: none; }
        .main-content { flex: 1; margin-left: 280px; transition: margin-left var(--duration-normal) var(--ease-standard); display: flex; flex-direction: column; overflow-x: hidden; max-width: 100%; }
        .sidebar.collapsed + .main-content { margin-left: 70px; }
        .header { background-color: var(--color-surface); border-bottom: 1px solid var(--color-border); padding: var(--space-16) var(--space-24); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left h1 { margin: 0 0 var(--space-4) 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); }
        .breadcrumb { display: flex; align-items: center; gap: var(--space-8); font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .header-right { display: flex; align-items: center; gap: var(--space-16); }
        .search-box { position: relative; }
        .search-box input { padding: var(--space-8) var(--space-12) var(--space-8) var(--space-32); border: 1px solid var(--color-border); border-radius: var(--radius-base); background-color: var(--color-background); color: var(--color-text); font-size: var(--font-size-sm); width: 250px; }
        .search-box i { position: absolute; left: var(--space-12); top: 50%; transform: translateY(-50%); color: var(--color-text-secondary); }
        .theme-toggle { background: none; border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-8); cursor: pointer; color: var(--color-text-secondary); transition: all var(--duration-fast) var(--ease-standard); }
        .theme-toggle:hover { background-color: var(--color-secondary); color: var(--color-text); }
        .view { flex: 1; padding: var(--space-24); display: none; }
        .view.active { display: block; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-20); margin-bottom: var(--space-32); }
        .metric-card { background-color: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); display: flex; align-items: center; gap: var(--space-16); transition: box-shadow var(--duration-normal) var(--ease-standard); }
        .metric-card:hover { box-shadow: var(--shadow-md); }
        .metric-icon { width: 60px; height: 60px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xl); color: white; }
        .metric-icon.sales { background: linear-gradient(135deg, var(--color-teal-500), var(--color-teal-600)); }
        .metric-icon.deals { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        .metric-icon.contacts { background: linear-gradient(135deg, #10B981, #059669); }
        .metric-icon.conversion { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .metric-content h3 { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); margin: 0 0 var(--space-4) 0; }
        .metric-content p { color: var(--color-text-secondary); margin: 0 0 var(--space-8) 0; font-size: var(--font-size-sm); }
        .metric-change { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); padding: var(--space-2) var(--space-8); border-radius: var(--radius-full); }
        .metric-change.positive { background-color: rgba(var(--color-success-rgb), 0.1); color: var(--color-success); }
        .metric-change.negative { background-color: rgba(var(--color-error-rgb), 0.1); color: var(--color-error); }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-24); }
        .chart-card { height: 400px; }
        .chart-container { width: 100%; height: 100%; }
        .activity-feed { display: flex; flex-direction: column; gap: var(--space-16); max-height: 300px; overflow-y: auto; }
        .activity-item { display: flex; gap: var(--space-12); padding: var(--space-12); border-radius: var(--radius-base); background-color: var(--color-background); }
        .activity-avatar { width: 32px; height: 32px; border-radius: var(--radius-full); background-color: var(--color-primary); color: var(--color-btn-primary-text); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); flex-shrink: 0; }
        .activity-content { flex: 1; }
        .activity-text { font-size: var(--font-size-sm); margin: 0 0 var(--space-4) 0; }
        .activity-time { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
        .pipeline-header { margin-bottom: var(--space-24); }
        .pipeline-filters { display: flex; gap: var(--space-16); align-items: center; }
        .pipeline-filters .form-control { width: auto; min-width: 200px; }
        .pipeline-board { display: flex; gap: var(--space-20); overflow-x: auto; padding-bottom: var(--space-16); }
        .pipeline-column { min-width: 300px; background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-card-border); flex-shrink: 0; }
        .pipeline-column-header { padding: var(--space-16); border-bottom: 1px solid var(--color-card-border-inner); display: flex; justify-content: space-between; align-items: center; }
        .column-title { font-weight: var(--font-weight-semibold); display: flex; align-items: center; gap: var(--space-8); }
        .column-indicator { width: 12px; height: 12px; border-radius: var(--radius-full); }
        .column-count { background-color: var(--color-secondary); color: var(--color-text); border-radius: var(--radius-full); padding: var(--space-2) var(--space-8); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium); }
        .pipeline-column-body { padding: var(--space-16); min-height: 400px; display: flex; flex-direction: column; gap: var(--space-12); }
        .deal-card { background-color: var(--color-background); border: 1px solid var(--color-card-border); border-radius: var(--radius-base); padding: var(--space-16); cursor: move; transition: all var(--duration-fast) var(--ease-standard); }
        .deal-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .deal-card.dragging { opacity: 0.5; transform: rotate(5deg); }
        .deal-title { font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-8) 0; font-size: var(--font-size-base); }
        .deal-amount { font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary); margin: 0 0 var(--space-8) 0; }
        .deal-meta { display: flex; justify-content: space-between; align-items: center; font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .deal-contact { display: flex; align-items: center; gap: var(--space-6); }
        .deal-probability { background-color: var(--color-secondary); padding: var(--space-2) var(--space-6); border-radius: var(--radius-base); font-size: var(--font-size-xs); }
        .view-header { margin-bottom: var(--space-24); }
        .view-filters { display: flex; gap: var(--space-16); align-items: center; }
        .view-filters .form-control { width: auto; min-width: 200px; }
        .contacts-grid, .companies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--space-20); }
        .contact-card, .company-card { background-color: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); transition: all var(--duration-normal) var(--ease-standard); cursor: pointer; }
        .contact-card:hover, .company-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .contact-header, .company-header { display: flex; align-items: center; gap: var(--space-12); margin-bottom: var(--space-16); }
        .contact-avatar, .company-avatar { width: 50px; height: 50px; border-radius: var(--radius-full); background-color: var(--color-primary); color: var(--color-btn-primary-text); display: flex; align-items: center; justify-content: center; font-weight: var(--font-weight-bold); font-size: var(--font-size-lg); }
        .contact-info h3, .company-info h3 { margin: 0 0 var(--space-4) 0; font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
        .contact-email, .company-industry { color: var(--color-text-secondary); font-size: var(--font-size-sm); }
        .contact-details, .company-details { display: flex; flex-direction: column; gap: var(--space-8); }
        .contact-detail, .company-detail { display: flex; justify-content: space-between; align-items: center; font-size: var(--font-size-sm); }
        .contact-tags { display: flex; flex-wrap: wrap; gap: var(--space-6); margin-top: var(--space-12); }
        .tag { background-color: var(--color-secondary); color: var(--color-text); padding: var(--space-2) var(--space-8); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium); }
        .deals-table-container { background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-card-border); overflow: hidden; }
        .deals-table { width: 100%; border-collapse: collapse; }
        .deals-table th { background-color: var(--color-background); padding: var(--space-16); text-align: left; font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); color: var(--color-text-secondary); border-bottom: 1px solid var(--color-card-border-inner); }
        .deals-table td { padding: var(--space-16); border-bottom: 1px solid var(--color-card-border-inner); font-size: var(--font-size-sm); }
        .deals-table tbody tr:hover { background-color: var(--color-background); }
        .stage-badge { display: inline-flex; align-items: center; gap: var(--space-6); padding: var(--space-4) var(--space-8); border-radius: var(--radius-base); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium); }
        .stage-indicator { width: 8px; height: 8px; border-radius: var(--radius-full); }
        .probability-bar { width: 60px; height: 6px; background-color: var(--color-secondary); border-radius: var(--radius-full); overflow: hidden; }
        .probability-fill { height: 100%; background-color: var(--color-primary); border-radius: var(--radius-full); transition: width var(--duration-normal) var(--ease-standard); }
        .deal-actions { display: flex; gap: var(--space-8); }
        .btn-icon { background: none; border: none; color: var(--color-text-secondary); padding: var(--space-4); border-radius: var(--radius-sm); cursor: pointer; transition: all var(--duration-fast) var(--ease-standard); }
        .btn-icon:hover { background-color: var(--color-secondary); color: var(--color-text); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal.hidden { display: none !important; } .modal:not(.hidden) { display: flex; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; z-index: 1; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-20); border-bottom: 1px solid var(--color-card-border-inner); }
        .modal-header h2 { margin: 0; font-size: var(--font-size-2xl); font-weight: var(--font-weight-semibold); }
        .modal-close { background: none; border: none; color: var(--color-text-secondary); font-size: var(--font-size-lg); padding: var(--space-8); border-radius: var(--radius-base); cursor: pointer; transition: all var(--duration-fast) var(--ease-standard); }
        .modal-close:hover { background-color: var(--color-secondary); color: var(--color-text); }
        .modal-body { padding: var(--space-20); }
        .modal-footer { display: flex; gap: var(--space-12); justify-content: flex-end; padding: var(--space-20); border-top: 1px solid var(--color-card-border-inner); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-16); }
        .toast-container { position: fixed; top: var(--space-20); right: var(--space-20); z-index: 10001; display: flex; flex-direction: column; gap: var(--space-8); }
        .toast { background-color: var(--color-surface); border: 1px solid var(--color-card-border); border-radius: var(--radius-base); padding: var(--space-12) var(--space-16); box-shadow: var(--shadow-md); display: flex; align-items: center; gap: var(--space-12); min-width: 300px; animation: slideInRight var(--duration-normal) var(--ease-standard); }
        .toast.success { border-left: 4px solid var(--color-success); }
        .toast.error { border-left: 4px solid var(--color-error); }
        .toast.info { border-left: 4px solid var(--color-info); }
        .toast-icon { font-size: var(--font-size-lg); }
        .toast.success .toast-icon { color: var(--color-success); }
        .toast.error .toast-icon { color: var(--color-error); }
        .toast.info .toast-icon { color: var(--color-info); }
        .toast-content { flex: 1; }
        .toast-title { font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-2) 0; font-size: var(--font-size-sm); }
        .toast-message { margin: 0; font-size: var(--font-size-xs); color: var(--color-text-secondary); }
        .toast-close { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: var(--space-2); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .pipeline-column.drag-over { border: 2px dashed var(--color-primary); background-color: rgba(var(--color-teal-500-rgb), 0.05); }
        .deal-card.placeholder { border: 2px dashed var(--color-border); background-color: transparent; height: 100px; display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary); font-style: italic; }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; gap: var(--space-24); } .chart-card { height: 350px; } }
        @media (max-width: 768px) { .sidebar { width: 70px; } .sidebar .logo-text, .sidebar .menu-item span, .sidebar .user-info { display: none; } .main-content { margin-left: 70px; } .header { padding: var(--space-12) var(--space-16); flex-direction: column; gap: var(--space-12); align-items: stretch; } .header-left { width: 100%; text-align: center; } .breadcrumb { justify-content: center; } .header-right { width: 100%; justify-content: space-between; } .search-box { flex-grow: 1; } .search-box input { width: 100%; } #addNewBtn span { display: none; } #addNewBtn { padding: var(--space-8) var(--space-12); } .metrics-grid { grid-template-columns: 1fr; } .pipeline-board { flex-direction: column; overflow-x: hidden; gap: var(--space-16); } .pipeline-column { min-width: 100%; } .contacts-grid, .companies-grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } .modal-content { margin: var(--space-16); width: calc(100% - 32px); } .view-filters, .pipeline-filters { flex-direction: column; align-items: stretch; } .view-filters .form-control, .pipeline-filters .form-control { width: 100%; min-width: unset; } .deals-table-container { overflow-x: hidden; } .deals-table { border: none; } .deals-table thead { display: none; } .deals-table tr { display: block; margin-bottom: var(--space-16); border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-8); } .deals-table td { display: flex; justify-content: space-between; align-items: center; padding: var(--space-8) 0; border-bottom: 1px solid var(--color-border); text-align: right; } .deals-table td:last-child { border-bottom: none; } .deals-table td::before { content: attr(data-label); font-weight: var(--font-weight-medium); text-align: left; padding-right: var(--space-16); } .deals-table td .deal-actions { justify-content: flex-end; } }
        @media (max-width: 480px) { .view { padding: var(--space-16); } .metrics-grid { gap: var(--space-12); } .metric-card { padding: var(--space-16); } .pipeline-column { min-width: 100%; } }
        .loading { display: flex; align-items: center; justify-content: center; padding: var(--space-32); }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--color-secondary); border-top: 3px solid var(--color-primary); border-radius: var(--radius-full); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: var(--space-32); color: var(--color-text-secondary); }
        .empty-state i { font-size: var(--font-size-4xl); margin-bottom: var(--space-16); opacity: 0.5; }
        .empty-state h3 { margin: 0 0 var(--space-8) 0; font-size: var(--font-size-xl); color: var(--color-text); }
        .empty-state p { margin: 0; font-size: var(--font-size-base); }

        #logout-button {
            width: 100%;
            margin-top: 1rem;
            cursor: pointer;
            background-color: var(--color-secondary);
            border: 1px solid var(--color-border);
            padding: var(--space-8);
            border-radius: var(--radius-base);
            color: var(--color-text);
            font-weight: 500;
        }
        #logout-button:hover {
             background-color: var(--color-secondary-hover);
        }

    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="form-container">
            <div id="login-view">
                <img src="https://cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">Iniciar Sesión</p>
                <div id="login-message" class="message hidden"></div>
                <form class="form" id="login-form">
                    <div class="input-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" name="email" placeholder="Tu email" required>
                    </div>
                    <div class="input-group">
                        <label for="login-password">Contraseña</label>
                        <input type="password" id="login-password" name="password" placeholder="Tu contraseña" required>
                    </div>
                    <button type="submit" class="sign">Iniciar Sesión</button>
                </form>
                <div class="actions">
                    <p><a id="show-forgot-password-link">¿Olvidaste tu contraseña?</a></p>
                    <p>¿No tienes una cuenta? <a id="show-register-link">Regístrate</a></p>
                </div>
            </div>
            <div id="register-view" class="hidden">
                 <img src="https://cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">Estudio de Estrategia Digital</p>
                <div id="register-message" class="message hidden"></div>
                <form class="form" id="register-form">
                    <div class="input-group"><label for="nombre">Nombre</label><input type="text" id="nombre" name="nombre" placeholder="Tu nombre" required></div>
                    <div class="input-group"><label for="apellido">Apellido</label><input type="text" id="apellido" name="apellido" placeholder="Tu apellido" required></div>
                    <div class="input-group"><label for="cargo">Cargo</label><input type="text" id="cargo" name="cargo" placeholder="Ej: CEO, Gerente de Ventas"></div>
                    <div class="input-group"><label for="register-email">Email</label><input type="email" id="register-email" name="email" placeholder="Tu email" required></div>
                    <div class="input-group"><label for="register-password">Contraseña</label><input type="password" id="register-password" name="password" placeholder="Crea una contraseña" required>
                        <p id="password-requirements">
                            <span id="length" class="invalid">8+ caract,</span> <span id="uppercase" class="invalid">mayús,</span> 
                            <span id="lowercase" class="invalid">minús,</span> <span id="number" class="invalid">número</span> & <span id="special" class="invalid">símbolo.</span>
                        </p>
                    </div>
                    <button type="submit" class="sign">Registrarse</button>
                </form>
                <div class="actions"><p>¿Ya tienes una cuenta? <a class="show-login-link">Inicia Sesión</a></p></div>
            </div>
            <div id="forgot-password-view" class="hidden">
                <p class="title">Recuperar Contraseña</p>
                <p class="subtitle">Ingresa tu email para recibir un enlace de recuperación.</p>
                <div id="forgot-message" class="message hidden"></div>
                <form class="form" id="forgot-form">
                    <div class="input-group"><label for="forgot-email">Email</label><input type="email" id="forgot-email" name="email" placeholder="Tu email" required></div>
                    <button type="submit" class="sign">Enviar Enlace</button>
                </form>
                <div class="actions"><p><a class="show-login-link">Volver a Inicio de Sesión</a></p></div>
            </div>
            <div id="register-success-view" class="hidden">
                <img src="https://cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">¡Registro Exitoso!</p>
                <p class="subtitle">Tu cuenta está pendiente de aprobación por un administrador.</p>
                <p style="text-align:center; font-size: 0.8rem; color: #606770;">(Haz clic aquí para volver)</p>
            </div>
        </div>
    </div>
    
    <div id="crm-wrapper" class="hidden">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><i class="fas fa-chart-line"></i><span class="logo-text">CRM Pro</span></div>
                <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="#" class="menu-item active" data-view="dashboard"><i class="fas fa-chart-pie"></i><span>Tablero</span></a></li>
                    <li><a href="#" class="menu-item" data-view="pipeline"><i class="fas fa-columns"></i><span>Embudo de Ventas</span></a></li>
                    <li><a href="#" class="menu-item" data-view="contacts"><i class="fas fa-users"></i><span>Contactos</span></a></li>
                    <li><a href="#" class="menu-item" data-view="companies"><i class="fas fa-building"></i><span>Empresas</span></a></li>
                    <li><a href="#" class="menu-item" data-view="deals"><i class="fas fa-handshake"></i><span>Negocios</span></a></li>
                </ul>
            </div>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar-sidebar">--</div>
                    <div class="user-info">
                        <span class="user-name" id="user-name-sidebar">Cargando...</span>
                        <span class="user-role" id="user-role-sidebar"></span>
                    </div>
                </div>
                <button id="logout-button">Cerrar Sesión</button>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
             <header class="header">
                <div class="header-left"><h1 class="page-title" id="pageTitle">Tablero</h1><div class="breadcrumb"><span>CRM</span><i class="fas fa-chevron-right"></i><span id="breadcrumbCurrent">Tablero</span></div></div>
                <div class="header-right">
                    <div class="search-box"><input type="text" placeholder="Buscar..." id="globalSearch"><i class="fas fa-search"></i></div>
                    <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
                    <button class="btn btn--primary" id="addNewBtn"><i class="fas fa-plus"></i><span>Agregar</span></button>
                </div>
            </header>
            <div class="view active" id="dashboard-view">
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-icon sales"><i class="fas fa-dollar-sign"></i></div><div class="metric-content"><h3 id="totalRevenue">$0</h3><p>Ingresos Totales</p></div></div>
                    <div class="metric-card"><div class="metric-icon deals"><i class="fas fa-handshake"></i></div><div class="metric-content"><h3 id="activeDeals">0</h3><p>Negocios Activos</p></div></div>
                    <div class="metric-card"><div class="metric-icon contacts"><i class="fas fa-users"></i></div><div class="metric-content"><h3 id="totalContacts">0</h3><p>Contactos</p></div></div>
                    <div class="metric-card"><div class="metric-icon conversion"><i class="fas fa-chart-line"></i></div><div class="metric-content"><h3 id="conversionRate">0%</h3><p>Tasa de Conversión</p></div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="card chart-card"><div class="card__header"><h3>Embudo por Etapa</h3></div><div class="card__body"><div class="chart-container" style="position: relative; height: 300px;"><canvas id="pipelineChart"></canvas></div></div></div>
                    <div class="card chart-card"><div class="card__header"><h3>Actividad Reciente</h3></div><div class="card__body"><div class="activity-feed" id="activityFeed"></div></div></div>
                </div>
            </div>
            <div class="view" id="pipeline-view">
                <div class="pipeline-header"><div class="pipeline-filters"><select id="ownerFilter" class="form-control"><option value="">Todos los propietarios</option></select><input type="text" placeholder="Buscar negocios..." id="pipelineSearch" class="form-control"></div></div>
                <div class="pipeline-board" id="pipelineBoard"></div>
            </div>
            <div class="view" id="contacts-view">
                <div class="view-header"><div class="view-filters"><input type="text" placeholder="Buscar contactos..." id="contactsSearch" class="form-control"><select id="contactsCompanyFilter" class="form-control"><option value="">Todas las empresas</option></select></div></div>
                <div class="contacts-grid" id="contactsGrid"></div>
            </div>
            <div class="view" id="companies-view">
                <div class="view-header"><div class="view-filters"><input type="text" placeholder="Buscar empresas..." id="companiesSearch" class="form-control"><select id="companiesIndustryFilter" class="form-control"><option value="">Todas las industrias</option></select></div></div>
                <div class="companies-grid" id="companiesGrid"></div>
            </div>
            <div class="view" id="deals-view">
                <div class="view-header"><div class="view-filters"><input type="text" placeholder="Buscar negocios..." id="dealsSearch" class="form-control"><select id="dealsStageFilter" class="form-control"><option value="">Todas las etapas</option></select></div></div>
                <div class="deals-table-container"><table class="deals-table" id="dealsTable"><thead><tr><th>Título</th><th>Monto</th><th>Etapa</th><th>Probabilidad</th><th>Fecha Cierre</th><th>Contacto</th><th>Acciones</th></tr></thead><tbody id="dealsTableBody"></tbody></table></div>
            </div>
        </main>
        
        <div class="modal hidden" id="dealModal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header"><h2 id="dealModalTitle"></h2><button class="modal-close"><i class="fas fa-times"></i></button></div>
                <div class="modal-body"><form id="dealForm">
                    <input type="hidden" name="id" />
                    <div class="form-group"><label class="form-label">Título</label><input type="text" name="title" class="form-control" required></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Monto</label><input type="number" name="amount" class="form-control" required></div><div class="form-group"><label class="form-label">Moneda</label><select name="currency" class="form-control"><option value="USD">$us</option><option value="BOB">BOB</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Etapa</label><select name="stage" class="form-control" required></select></div><div class="form-group"><label class="form-label">Probabilidad (%)</label><input type="number" name="probability" class="form-control" min="0" max="100"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Contacto</label><select name="contactId" class="form-control"></select></div><div class="form-group"><label class="form-label">Fecha de Cierre</label><input type="date" name="closeDate" class="form-control"></div></div>
                    <div class="form-group"><label class="form-label">Notas</label><textarea name="notes" class="form-control" rows="3"></textarea></div>
                </form></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--danger hidden" id="dealDeleteBtn">Eliminar</button>
                    <button type="button" class="btn btn--outline" id="dealCancelBtn">Cancelar</button>
                    <button type="submit" form="dealForm" class="btn btn--primary">Guardar</button>
                </div>
            </div>
        </div>
        <div class="modal hidden" id="contactModal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header"><h2 id="contactModalTitle"></h2><button class="modal-close"><i class="fas fa-times"></i></button></div>
                <div class="modal-body"><form id="contactForm">
                    <input type="hidden" name="id" />
                    <div class="form-row"><div class="form-group"><label class="form-label">Nombre</label><input type="text" name="firstName" class="form-control" required></div><div class="form-group"><label class="form-label">Apellido</label><input type="text" name="lastName" class="form-control" required></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Correo Electrónico</label><input type="email" name="email" class="form-control" required></div><div class="form-group"><label class="form-label">Teléfono</label><input type="tel" name="phone" class="form-control"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Empresa</label><select name="companyId" class="form-control"></select></div><div class="form-group"><label class="form-label">Puntuación</label><input type="number" name="score" class="form-control" min="0" max="100" value="50"></div></div>
                    <div class="form-group"><label class="form-label">Etiquetas (separadas por comas)</label><input type="text" name="tags" class="form-control" placeholder="ej: Tomador de decisiones, Gerente de TI"></div>
                </form></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--secondary hidden" id="contactHistoryBtn" style="margin-right: auto;">Ver Historial</button>
                    <button type="button" class="btn btn--danger hidden" id="contactDeleteBtn" style="margin-right: 10px;">Eliminar</button>
                    <button type="button" class="btn btn--outline" id="contactCancelBtn">Cancelar</button>
                    <button type="submit" form="contactForm" class="btn btn--primary">Guardar</button>
                </div>
            </div>
        </div>
        <div class="modal hidden" id="companyModal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header"><h2 id="companyModalTitle"></h2><button class="modal-close"><i class="fas fa-times"></i></button></div>
                <div class="modal-body"><form id="companyForm">
                     <input type="hidden" name="id" />
                    <div class="form-group"><label class="form-label">Nombre de la Empresa</label><input type="text" name="name" class="form-control" required></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Industria</label><input type="text" name="industry" class="form-control" required></div><div class="form-group"><label class="form-label">Tamaño</label><select name="size" class="form-control" required><option value="">Seleccionar tamaño</option><option value="1-10">1-10 empleados</option><option value="10-50">10-50 empleados</option><option value="50-200">50-200 empleados</option><option value="200-500">200-500 empleados</option><option value="500+">500+ empleados</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Sitio Web</label><input type="url" name="website" class="form-control"></div><div class="form-group"><label class="form-label">Ingresos Anuales</label><input type="number" name="revenue" class="form-control"></div></div>
                    <div class="form-group"><label class="form-label">Ubicación</label><input type="text" name="location" class="form-control"></div>
                </form></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn--danger hidden" id="companyDeleteBtn" style="margin-right: auto;">Eliminar</button>
                    <button type="button" class="btn btn--outline" id="companyCancelBtn">Cancelar</button>
                    <button type="submit" form="companyForm" class="btn btn--primary">Guardar</button>
                </div>
            </div>
        </div>
        <div class="modal hidden" id="historyModal">
            <div class="modal-overlay"></div><div class="modal-content"><div class="modal-header"><h2 id="historyModalTitle">Historial</h2><button class="modal-close"><i class="fas fa-times"></i></button></div><div class="modal-body" id="historyModalBody"></div><div class="modal-footer"><button type="button" class="btn btn--outline" id="historyCancelBtn">Cerrar</button></div></div>
        </div>
        <div class="toast-container" id="toastContainer"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
      // ========================================================================
      // == 1. INICIALIZACIÓN DE FIREBASE ==
      // ========================================================================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAKCQv65xdkBjt4Fv9afKNBFxwUQXuYXqA",
        authDomain: "crm-2025-octubre-mde.firebaseapp.com",
        projectId: "crm-2025-octubre-mde",
        storageBucket: "crm-2025-octubre-mde.firebasestorage.app",
        messagingSenderId: "906917861641",
        appId: "1:906917861641:web:0b81a671d966ed10699bd8"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ========================================================================
      // == 2. CLASE PRINCIPAL DE LA APLICACIÓN CRM ==
      // ========================================================================
      class CRMApp {
            constructor(user, userData) {
                this.user = user;
                this.userData = userData;

                this.currentView = 'dashboard';
                this.isDarkMode = false;
                this.sidebarCollapsed = false;
                this.editingDealId = null;
                this.editingContactId = null;
                this.editingCompanyId = null;
                
                this.users = []; // Se podría cargar desde una colección de 'equipo' si fuera necesario
                this.deals = [];
                this.contacts = [];
                this.companies = [];

                this.pipelineStages = [
                    { id: "lead", name: "Cliente Potencial", color: "#6B7280", defaultProbability: 10, order: 1 },
                    { id: "qualified", name: "Calificado", color: "#3B82F6", defaultProbability: 25, order: 2 },
                    { id: "proposal", name: "Propuesta", color: "#E68161", defaultProbability: 50, order: 3 },
                    { id: "negotiation", name: "Negociación", color: "#F59E0B", defaultProbability: 75, order: 4 },
                    { id: "closed-won", name: "Cerrado Ganado", color: "#1d6fb6", defaultProbability: 100, order: 5 },
                    { id: "closed-lost", name: "Cerrado Perdido", color: "#EF4444", defaultProbability: 0, order: 6 }
                ];

                this.bindEvents();
            }

            async initializeApp() {
                // Personalizar la UI con los datos del usuario real
                document.getElementById('user-name-sidebar').textContent = `${this.userData.nombre} ${this.userData.apellido}`;
                document.getElementById('user-role-sidebar').textContent = this.userData.cargo || 'Miembro';
                document.getElementById('user-avatar-sidebar').textContent = `${this.userData.nombre[0] || ''}${this.userData.apellido[0] || ''}`.toUpperCase();
                
                // Cargar todos los datos desde Firestore
                await this.loadAllDataFromFirestore();
                
                this.populateDropdowns();
                this.switchView('dashboard');
            }
            
            async loadAllDataFromFirestore() {
                try {
                    // Cargar Empresas
                    const companiesQuery = collection(db, 'users', this.user.uid, 'companies');
                    const companiesSnapshot = await getDocs(companiesQuery);
                    this.companies = companiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Cargar Contactos
                    const contactsQuery = collection(db, 'users', this.user.uid, 'contacts');
                    const contactsSnapshot = await getDocs(contactsQuery);
                    this.contacts = contactsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Cargar Negocios
                    const dealsQuery = collection(db, 'users', this.user.uid, 'deals');
                    const dealsSnapshot = await getDocs(dealsQuery);
                    this.deals = dealsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Error crítico al cargar datos desde Firestore:", error);
                    this.showToast('error', 'Error de Conexión', 'No se pudieron cargar los datos. Revisa tu conexión.');
                }
            }
            
            // --- Event Binding ---
            bindEvents() {
                document.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) { e.preventDefault(); this.switchView(menuItem.dataset.view); return; }
                    if (e.target.closest('#sidebarToggle')) { this.toggleSidebar(); return; }
                    if (e.target.closest('#themeToggle')) { this.toggleTheme(); return; }
                    if (e.target.closest('#addNewBtn')) { this.handleAddNew(); return; }
                    if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal-overlay') || e.target.id.includes('CancelBtn')) { this.closeAllModals(); return; }
                    const dealCard = e.target.closest('.deal-card');
                    if(dealCard) { this.editDeal(dealCard.dataset.dealId); return; }
                    const contactCard = e.target.closest('.contact-card');
                    if(contactCard) { this.editContact(contactCard.dataset.contactId); return; }
                    const companyCard = e.target.closest('.company-card');
                    if(companyCard) { this.editCompany(companyCard.dataset.companyId); return; }
                    const editBtn = e.target.closest('.edit-btn');
                    if(editBtn) { this.editDeal(editBtn.dataset.id); return; }
                    const deleteBtn = e.target.closest('.delete-btn');
                    if(deleteBtn) { this.deleteDeal(deleteBtn.dataset.id); return; }
                });

                // Búsquedas y filtros
                document.getElementById('pipelineSearch').addEventListener('input', () => this.filterPipeline());
                document.getElementById('contactsSearch').addEventListener('input', () => this.filterContacts());
                document.getElementById('companiesSearch').addEventListener('input', () => this.filterCompanies());
                document.getElementById('dealsSearch').addEventListener('input', () => this.filterDeals());

                // Formularios
                document.getElementById('dealForm').addEventListener('submit', (e) => { e.preventDefault(); this.handleDealSubmit(); });
                document.getElementById('contactForm').addEventListener('submit', (e) => { e.preventDefault(); this.handleContactSubmit(); });
                document.getElementById('companyForm').addEventListener('submit', (e) => { e.preventDefault(); this.handleCompanySubmit(); });

                // Botones de eliminar en modales
                document.getElementById('dealDeleteBtn').addEventListener('click', () => this.deleteDeal(this.editingDealId));
                document.getElementById('contactDeleteBtn').addEventListener('click', () => this.deleteContact(this.editingContactId));
                document.getElementById('companyDeleteBtn').addEventListener('click', () => this.deleteCompany(this.editingCompanyId));
                document.getElementById('contactHistoryBtn').addEventListener('click', () => this.showContactHistory(this.editingContactId));
            }

            populateDropdowns() {
                const stageSelect = document.querySelector('#dealForm select[name="stage"]');
                stageSelect.innerHTML = this.pipelineStages.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                
                const contactSelect = document.querySelector('#dealForm select[name="contactId"]');
                contactSelect.innerHTML = '<option value="">Seleccionar</option>' + this.contacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
                
                const companySelect = document.querySelector('#contactForm select[name="companyId"]');
                companySelect.innerHTML = '<option value="">Seleccionar</option>' + this.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
            
            // --- Lógica de Vistas ---
            switchView(viewName) {
                document.querySelectorAll('.menu-item.active, .view.active').forEach(el => el.classList.remove('active'));
                document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
                document.getElementById(`${viewName}-view`).classList.add('active');
                const titles = { dashboard: 'Tablero', pipeline: 'Embudo de Ventas', contacts: 'Contactos', companies: 'Empresas', deals: 'Negocios' };
                document.getElementById('pageTitle').textContent = titles[viewName];
                document.getElementById('breadcrumbCurrent').textContent = titles[viewName];
                this.currentView = viewName;
                this.renderCurrentView();
            }

            renderCurrentView() {
                switch(this.currentView) {
                    case 'dashboard': this.loadDashboard(); break;
                    case 'pipeline': this.loadPipeline(); break;
                    case 'contacts': this.loadContacts(); break;
                    case 'companies': this.loadCompanies(); break;
                    case 'deals': this.loadDeals(); break;
                }
            }

            loadDashboard() {
                this.updateMetrics();
                setTimeout(() => this.loadPipelineChart(), 100);
                this.loadActivityFeed();
            }
            
            // --- Lógica de Renderizado ---
            // (Se han mantenido todas las funciones de renderizado del archivo original del CRM)
            // ... createDealCard, renderContacts, renderCompanies, renderDeals, etc.
             updateMetrics() {
                const totalRevenueUSD = this.deals.filter(d => d.stage === 'closed-won' && d.currency === 'USD').reduce((sum, d) => sum + d.amount, 0);
                const totalRevenueBOB = this.deals.filter(d => d.stage === 'closed-won' && d.currency === 'BOB').reduce((sum, d) => sum + d.amount, 0);
                const activeDealsCount = this.deals.filter(d => !['closed-won', 'closed-lost'].includes(d.stage)).length;
                const wonCount = this.deals.filter(d => d.stage === 'closed-won').length;
                const lostCount = this.deals.filter(d => d.stage === 'closed-lost').length;
                const conversionRate = (wonCount + lostCount > 0) ? ((wonCount / (wonCount + lostCount)) * 100).toFixed(1) : 0;

                let revenueString = this.formatCurrency(totalRevenueUSD, 'USD');
                if (totalRevenueBOB > 0) revenueString += ` / ${this.formatCurrency(totalRevenueBOB, 'BOB')}`;
                
                document.getElementById('totalRevenue').textContent = revenueString || '$0';
                document.getElementById('activeDeals').textContent = activeDealsCount;
                document.getElementById('totalContacts').textContent = this.contacts.length;
                document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            }

            loadPipelineChart() { /* ... Mismo código del CRM original ... */ 
                const ctx = document.getElementById('pipelineChart').getContext('2d');
                if (window.pipelineChart) window.pipelineChart.destroy();
                const stageData = this.pipelineStages.map(stage => ({
                    stage: stage.name,
                    count: this.deals.filter(deal => deal.stage === stage.id).length,
                }));
                window.pipelineChart = new Chart(ctx, { type: 'doughnut', data: { labels: stageData.map(d => d.stage), datasets: [{ data: stageData.map(d => d.count), backgroundColor: this.pipelineStages.map(s => s.color) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            }
            loadActivityFeed() { /* ... Mismo código del CRM original ... */ 
                document.getElementById('activityFeed').innerHTML = `<div class="empty-state" style="padding: 16px;"><i class="fas fa-history"></i><p>No hay actividad reciente.</p></div>`;
            }
            loadPipeline() { /* ... Mismo código del CRM original ... */
                 const board = document.getElementById('pipelineBoard');
                board.innerHTML = this.pipelineStages.filter(s=> s.order < 6).map(stage => {
                    const stageDeals = this.deals.filter(d => d.stage === stage.id);
                    return `<div class="pipeline-column" data-stage-id="${stage.id}"><div class="pipeline-column-header"><div class="column-title"><div class="column-indicator" style="background-color: ${stage.color}"></div>${stage.name}</div><div class="column-count">${stageDeals.length}</div></div><div class="pipeline-column-body">${stageDeals.length > 0 ? stageDeals.map(deal => this.createDealCard(deal)).join('') : '<div class="empty-state" style="padding:16px;"><p>Sin negocios</p></div>'}</div></div>`;
                }).join('');
                this.setupDragAndDrop();
            }
            createDealCard(deal) { /* ... Mismo código del CRM original ... */
                const contact = this.contacts.find(c => c.id === deal.contactId);
                return `<div class="deal-card" draggable="true" data-deal-id="${deal.id}"><h4 class="deal-title">${deal.title}</h4><p class="deal-amount">${this.formatCurrency(deal.amount, deal.currency)}</p><div class="deal-meta"><span class="deal-contact"><i class="fas fa-user"></i> ${contact ? contact.firstName : 'N/A'}</span><span class="deal-probability">${deal.probability}%</span></div></div>`;
            }
            loadContacts() { this.renderContacts(this.contacts) }
            renderContacts(contactsToRender) {
                const grid = document.getElementById('contactsGrid');
                if (contactsToRender.length === 0) { grid.innerHTML = `<div class="empty-state"><i class="fas fa-users"></i><h3>Sin Contactos</h3></div>`; return; }
                grid.innerHTML = contactsToRender.map(c => `<div class="contact-card" data-contact-id="${c.id}"><div class="contact-header"><div class="contact-avatar">${c.firstName[0]}${c.lastName[0]}</div><div class="contact-info"><h3>${c.firstName} ${c.lastName}</h3><p class="contact-email">${c.email}</p></div></div></div>`).join('');
            }
            loadCompanies() { this.renderCompanies(this.companies); }
            renderCompanies(companiesToRender) {
                 const grid = document.getElementById('companiesGrid');
                if (companiesToRender.length === 0) { grid.innerHTML = `<div class="empty-state"><i class="fas fa-building"></i><h3>Sin Empresas</h3></div>`; return; }
                grid.innerHTML = companiesToRender.map(c => `<div class="company-card" data-company-id="${c.id}"><div class="company-header"><div class="company-avatar">${c.name[0]}</div><div class="company-info"><h3>${c.name}</h3><p class="company-industry">${c.industry}</p></div></div></div>`).join('');
            }
            loadDeals() { this.renderDeals(this.deals); }
             renderDeals(dealsToRender) {
                const tbody = document.getElementById('dealsTableBody');
                if (dealsToRender.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><i class="fas fa-handshake"></i><h3>Sin Negocios</h3></td></tr>`; return; }
                tbody.innerHTML = dealsToRender.map(deal => {
                    const contact = this.contacts.find(c => c.id === deal.contactId);
                    const stage = this.pipelineStages.find(s => s.id === deal.stage);
                    return `<tr><td data-label="Título">${deal.title}</td><td data-label="Monto">${this.formatCurrency(deal.amount, deal.currency)}</td><td data-label="Etapa">${stage.name}</td><td data-label="Probabilidad">${deal.probability}%</td><td data-label="Fecha Cierre">${deal.closeDate}</td><td data-label="Contacto">${contact ? contact.firstName : 'N/A'}</td><td data-label="Acciones"><div class="deal-actions"><button class="btn-icon edit-btn" data-id="${deal.id}"><i class="fas fa-edit"></i></button><button class="btn-icon delete-btn" data-id="${deal.id}"><i class="fas fa-trash"></i></button></div></td></tr>`;
                }).join('');
            }


            // --- Lógica CRUD con FIRESTORE ---
            async handleDealSubmit() {
                const form = document.getElementById('dealForm');
                const formData = Object.fromEntries(new FormData(form).entries());
                const data = {
                    ...formData,
                    amount: parseFloat(formData.amount),
                    probability: parseInt(formData.probability),
                    ownerId: this.user.uid,
                    updatedAt: serverTimestamp()
                };

                try {
                    if (this.editingDealId) {
                        const docRef = doc(db, 'users', this.user.uid, 'deals', this.editingDealId);
                        await updateDoc(docRef, data);
                        this.showToast('success', 'Negocio actualizado');
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, 'users', this.user.uid, 'deals'), data);
                        this.showToast('success', 'Negocio creado');
                    }
                } catch(e) { console.error(e); this.showToast('error', 'Error al guardar'); }

                this.closeAllModals();
                await this.loadAllDataFromFirestore();
                this.renderCurrentView();
            }

            async handleContactSubmit() {
                const form = document.getElementById('contactForm');
                const formData = Object.fromEntries(new FormData(form).entries());
                 const data = { ...formData, score: parseInt(formData.score), tags: formData.tags.split(',').map(t => t.trim()) };
                
                try {
                     if (this.editingContactId) {
                        await updateDoc(doc(db, 'users', this.user.uid, 'contacts', this.editingContactId), data);
                        this.showToast('success', 'Contacto actualizado');
                    } else {
                        await addDoc(collection(db, 'users', this.user.uid, 'contacts'), data);
                        this.showToast('success', 'Contacto creado');
                    }
                } catch(e) { console.error(e); this.showToast('error', 'Error al guardar'); }
                
                this.closeAllModals();
                await this.loadAllDataFromFirestore();
                this.populateDropdowns();
                this.renderCurrentView();
            }

            async handleCompanySubmit() {
                const form = document.getElementById('companyForm');
                const formData = Object.fromEntries(new FormData(form).entries());
                const data = { ...formData, revenue: parseFloat(formData.revenue || 0) };

                 try {
                     if (this.editingCompanyId) {
                        await updateDoc(doc(db, 'users', this.user.uid, 'companies', this.editingCompanyId), data);
                        this.showToast('success', 'Empresa actualizada');
                    } else {
                        await addDoc(collection(db, 'users', this.user.uid, 'companies'), data);
                        this.showToast('success', 'Empresa creada');
                    }
                } catch(e) { console.error(e); this.showToast('error', 'Error al guardar'); }

                this.closeAllModals();
                await this.loadAllDataFromFirestore();
                this.populateDropdowns();
                this.renderCurrentView();
            }
            
            editDeal(id) {
                const deal = this.deals.find(d => d.id === id); if(!deal) return;
                this.editingDealId = id; this.openModal('dealModal');
                document.getElementById('dealModalTitle').textContent = 'Editar Negocio';
                const form = document.getElementById('dealForm');
                for (const key in deal) { if(form[key]) form[key].value = deal[key]; }
            }
            editContact(id) {
                const contact = this.contacts.find(c => c.id === id); if(!contact) return;
                this.editingContactId = id; this.openModal('contactModal');
                document.getElementById('contactModalTitle').textContent = 'Editar Contacto';
                 const form = document.getElementById('contactForm');
                for (const key in contact) { if(form[key]) form[key].value = Array.isArray(contact[key]) ? contact[key].join(', ') : contact[key]; }
            }
             editCompany(id) {
                const company = this.companies.find(c => c.id === id); if(!company) return;
                this.editingCompanyId = id; this.openModal('companyModal');
                document.getElementById('companyModalTitle').textContent = 'Editar Empresa';
                 const form = document.getElementById('companyForm');
                for (const key in company) { if(form[key]) form[key].value = company[key]; }
            }

            async deleteDeal(id) {
                if(!id || !confirm('¿Eliminar este negocio?')) return;
                await deleteDoc(doc(db, 'users', this.user.uid, 'deals', id));
                this.showToast('info', 'Negocio eliminado'); this.closeAllModals();
                await this.loadAllDataFromFirestore(); this.renderCurrentView();
            }
            async deleteContact(id) { /* similar a deleteDeal */
                 if(!id || !confirm('¿Eliminar este contacto?')) return;
                await deleteDoc(doc(db, 'users', this.user.uid, 'contacts', id));
                this.showToast('info', 'Contacto eliminado'); this.closeAllModals();
                await this.loadAllDataFromFirestore(); this.renderCurrentView();
            }
            async deleteCompany(id) { /* similar a deleteDeal */
                 if(!id || !confirm('¿Eliminar esta empresa?')) return;
                await deleteDoc(doc(db, 'users', this.user.uid, 'companies', id));
                this.showToast('info', 'Empresa eliminada'); this.closeAllModals();
                await this.loadAllDataFromFirestore(); this.renderCurrentView();
            }

            // --- Utilidades y UI ---
            handleAddNew() {
                const type = { dashboard: 'deal', pipeline: 'deal', contacts: 'contact', companies: 'company', deals: 'deal' };
                this.openModal(`${type[this.currentView]}Modal`);
            }
            openModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
                document.getElementById(`${modalId.replace('Modal','')}Form`).reset();
                document.getElementById(`${modalId.replace('Modal','')}DeleteBtn`).classList.add('hidden');
                if (modalId.includes('deal')) this.editingDealId = null;
                if (modalId.includes('contact')) this.editingContactId = null;
                if (modalId.includes('company')) this.editingCompanyId = null;
                document.getElementById(`${modalId.replace('Modal','')}DeleteBtn`).classList.remove('hidden');
            }
            closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); }
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
            toggleTheme() { document.documentElement.dataset.colorScheme = document.documentElement.dataset.colorScheme === 'dark' ? 'light' : 'dark'; }
            formatCurrency(amount, currency) { return new Intl.NumberFormat('es-BO', { style: 'currency', currency }).format(amount); }
            showToast(type, title, message = '') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const iconMap = { success: 'fas fa-check-circle', error: 'fas fa-exclamation-circle', info: 'fas fa-info-circle' };
                toast.innerHTML = `<i class="toast-icon ${iconMap[type]}"></i><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close">&times;</button>`;
                document.getElementById('toastContainer').appendChild(toast);
                toast.querySelector('.toast-close').addEventListener('click', () => toast.remove());
                setTimeout(() => toast.remove(), 5000);
            }
            setupDragAndDrop(){ /* ... Mismo código del CRM original ... */ 
                const dealCards = document.querySelectorAll('.deal-card');
                const columns = document.querySelectorAll('.pipeline-column');
                dealCards.forEach(card => {
                    card.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', card.dataset.dealId); card.classList.add('dragging'); });
                    card.addEventListener('dragend', () => card.classList.remove('dragging'));
                });
                columns.forEach(col => {
                    col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
                    col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
                    col.addEventListener('drop', e => {
                        e.preventDefault(); col.classList.remove('drag-over');
                        const dealId = e.dataTransfer.getData('text/plain');
                        const newStageId = col.dataset.stageId;
                        this.moveDeal(dealId, newStageId);
                    });
                });
            }
            async moveDeal(dealId, newStageId) {
                const deal = this.deals.find(d => d.id === dealId);
                const stage = this.pipelineStages.find(s => s.id === newStageId);
                if (!deal || !stage) return;
                deal.stage = newStageId;
                deal.probability = stage.defaultProbability;
                await updateDoc(doc(db, 'users', this.user.uid, 'deals', dealId), { stage: newStageId, probability: stage.defaultProbability });
                this.loadPipeline(); // Re-render
                this.showToast('info', 'Negocio movido', `"${deal.title}" ahora está en ${stage.name}`);
            }
             showContactHistory(contactId) { /* ... Mismo código del CRM original ... */
                 const contact = this.contacts.find(c => c.id === contactId); if (!contact) return;
                const historyBody = document.getElementById('historyModalBody');
                historyBody.innerHTML = `<p>Historial para ${contact.firstName}</p>`;
                this.openModal('historyModal');
            }
            filterPipeline(){} filterContacts(){} filterCompanies(){} filterDeals(){} // Placeholder for brevity
      }

      // ========================================================================
      // == 3. LÓGICA DE AUTENTICACIÓN Y CONTROLADOR PRINCIPAL ==
      // ========================================================================
      
      // --- Selectores de la UI de Autenticación ---
      const authOverlay = document.getElementById('auth-overlay');
      const crmWrapper = document.getElementById('crm-wrapper');
      const loginView = document.getElementById('login-view');
      const registerView = document.getElementById('register-view');
      const forgotPasswordView = document.getElementById('forgot-password-view');
      const registerSuccessView = document.getElementById('register-success-view');

      // --- Función para cambiar entre vistas de autenticación ---
      const showAuthView = (view) => {
          [loginView, registerView, forgotPasswordView, registerSuccessView].forEach(v => v.classList.add('hidden'));
          view.classList.remove('hidden');
      };
      
      // --- Eventos para cambiar de vista ---
      document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showAuthView(registerView); });
      document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); showAuthView(forgotPasswordView); });
      document.querySelectorAll('.show-login-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showAuthView(loginView); }));
      registerSuccessView.addEventListener('click', () => showAuthView(loginView));

      // --- Función para mostrar mensajes ---
      const showAuthMessage = (elementId, message, isError = true) => {
          const el = document.getElementById(elementId);
          el.textContent = message;
          el.className = `message ${isError ? 'message-error' : 'message-success'}`;
      };

      // --- Lógica de Registro ---
      document.getElementById('register-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const form = e.target;
          const button = form.querySelector('button');
          button.disabled = true; button.textContent = 'Registrando...';
          try {
              const email = form['register-email'].value;
              const password = form['register-password'].value;
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              await setDoc(doc(db, "users", userCredential.user.uid), {
                  nombre: form.nombre.value, apellido: form.apellido.value, cargo: form.cargo.value,
                  email: email, status: "pending"
              });
              form.reset(); showAuthView(registerSuccessView);
          } catch (error) { showAuthMessage('register-message', 'Error: ' + error.code); } 
          finally { button.disabled = false; button.textContent = 'Registrarse'; }
      });

      // --- Lógica de Login ---
      document.getElementById('login-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const form = e.target;
          const button = form.querySelector('button');
          button.disabled = true; button.textContent = 'Iniciando...';
          try {
              const email = form['login-email'].value;
              const password = form['login-password'].value;
              await signInWithEmailAndPassword(auth, email, password);
              // onAuthStateChanged se encargará del resto
          } catch (error) { showAuthMessage('login-message', 'Email o contraseña incorrectos.'); } 
          finally { button.disabled = false; button.textContent = 'Iniciar Sesión'; }
      });

       // --- Lógica de Contraseña Olvidada ---
      document.getElementById('forgot-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const form = e.target;
          const email = form['forgot-email'].value;
          try {
              await sendPasswordResetEmail(auth, email);
              showAuthMessage('forgot-message', 'Enlace de recuperación enviado.', false);
          } catch(error) { showAuthMessage('forgot-message', 'Error al enviar el correo.'); }
      });
      
      // --- Lógica de Logout ---
       document.getElementById('logout-button').addEventListener('click', () => {
          signOut(auth);
       });
       
      // --- Validador de Contraseña (UI) ---
      document.getElementById('register-password').addEventListener('input', (e) => {
          const pw = e.target.value;
          const validate = (id, cond) => document.getElementById(id).classList.toggle('valid', cond);
          validate('length', pw.length >= 8); validate('uppercase', /[A-Z]/.test(pw));
          validate('lowercase', /[a-z]/.test(pw)); validate('number', /[0-9]/.test(pw));
          validate('special', /[^A-Za-z0-9]/.test(pw));
      });

      // ========================================================================
      // == 4. EL CONTROLADOR MAESTRO DE LA APLICACIÓN ==
      // ========================================================================
      onAuthStateChanged(auth, async (user) => {
          if (user) {
              // Si hay un usuario, verificar su estado en Firestore
              const userDocRef = doc(db, "users", user.uid);
              const userDocSnap = await getDoc(userDocRef);

              if (userDocSnap.exists() && userDocSnap.data().status === 'approved') {
                  // APROBADO: Iniciar el CRM
                  authOverlay.classList.add('hidden'); // Ocultar login
                  crmWrapper.classList.remove('hidden'); // Mostrar CRM
                  
                  // Crear e inicializar la instancia del CRM
                  window.crm = new CRMApp(user, userDocSnap.data());
                  await window.crm.initializeApp();
              } else {
                  // NO APROBADO: Expulsar al usuario
                  await signOut(auth);
                  // El siguiente `else` se encargará de mostrar el login con un mensaje
                  showAuthMessage('login-message', 'Tu cuenta está pendiente de aprobación.');
              }
          } else {
              // NO HAY USUARIO: Asegurarse de que el login esté visible
              authOverlay.classList.remove('hidden');
              crmWrapper.classList.add('hidden');
              window.crm = null; // Limpiar la instancia anterior
          }
      });

    </script>
</body>
</html>
