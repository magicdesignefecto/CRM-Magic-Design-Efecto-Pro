<!DOCTYPE html>
<html lang="es" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(29, 111, 182, 1);
          --color-teal-600: rgba(26, 98, 161, 1);
          --color-teal-700: rgba(23, 86, 140, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);
          --color-blue-400: rgba(59, 130, 246, 1);
          --color-blue-500: rgba(37, 99, 235, 1);
          --color-blue-600: rgba(29, 78, 216, 1);
          --color-green-500: rgba(34, 197, 94, 1);
          --color-green-400: rgba(52, 211, 153, 1);


          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 29, 111, 182;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;
          --color-blue-400-rgb: 59, 130, 246;
          --color-green-500-rgb: 34, 197, 94;
          --color-green-400-rgb: 52, 211, 153;

          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
          --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
          --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
          --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
          --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
          --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
          --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
          --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-green-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
          --color-success-rgb: var(--color-green-500-rgb);

          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

          /* RGB versions for opacity control */
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;

          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
            Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;

          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;

          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;

          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
            inset 0 -1px 0 rgba(0, 0, 0, 0.03);

          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

          /* Layout */
          --container-sm: 640px;
          --container-md: 768px;
          --container-lg: 1024px;
          --container-xl: 1280px;
        }

        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
          :root {
            /* RGB versions for opacity control (Dark Mode) */
            --color-gray-400-rgb: 119, 124, 124;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;
            --color-blue-400-rgb: 59, 130, 246;
            --color-green-400-rgb: 52, 211, 153;


            /* Background color tokens (Dark Mode) */
            --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
            --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
            --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
            --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
            --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
            --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
            --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
            --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

            /* Semantic Color Tokens (Dark Mode) */
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-blue-400);
            --color-primary-hover: var(--color-blue-500);
            --color-primary-active: var(--color-blue-600);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-green-400);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-blue-400-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
              inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
            --color-success-rgb: var(--color-green-400-rgb);

            /* Common style patterns - updated for dark mode */
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;
            --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            
            /* RGB versions for dark mode */
            --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb);
            --color-info-rgb: var(--color-gray-300-rgb);
          }
        }

        /* Data attribute for manual theme switching */
        [data-color-scheme="dark"] {
          /* RGB versions for opacity control (dark mode) */
          --color-gray-400-rgb: 119, 124, 124;
          --color-gray-300-rgb: 167, 169, 169;
          --color-gray-200-rgb: 245, 245, 245;
          --color-blue-400-rgb: 59, 130, 246;
          --color-green-400-rgb: 52, 211, 153;

          /* Colorful background palette - Dark Mode */
          --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
          --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
          --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
          --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
          --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
          --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
          --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
          --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

          /* Semantic Color Tokens (Dark Mode) */
          --color-background: var(--color-charcoal-700);
          --color-surface: var(--color-charcoal-800);
          --color-text: var(--color-gray-200);
          --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
          --color-primary: var(--color-blue-400);
          --color-primary-hover: var(--color-blue-500);
          --color-primary-active: var(--color-blue-600);
          --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
          --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
          --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
          --color-border: rgba(var(--color-gray-400-rgb), 0.3);
          --color-error: var(--color-red-400);
          --color-success: var(--color-green-400);
          --color-warning: var(--color-orange-400);
          --color-info: var(--color-gray-300);
          --color-focus-ring: rgba(var(--color-blue-400-rgb), 0.4);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
          --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
            inset 0 -1px 0 rgba(0, 0, 0, 0.15);
          --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
          --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
          --color-success-rgb: var(--color-green-400-rgb);

          /* Common style patterns - updated for dark mode */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          
          /* RGB versions for dark mode */
          --color-error-rgb: var(--color-red-400-rgb);
          --color-warning-rgb: var(--color-orange-400-rgb);
          --color-info-rgb: var(--color-gray-300-rgb);
        }

        [data-color-scheme="light"] {
          /* RGB versions for opacity control (light mode) */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-green-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-success-rgb: var(--color-green-500-rgb);

          /* RGB versions for light mode */
          --color-error-rgb: var(--color-red-500-rgb);
          --color-warning-rgb: var(--color-orange-500-rgb);
          --color-info-rgb: var(--color-slate-500-rgb);
        }

        /* Base styles */
        html {
          font-size: var(--font-size-base);
          font-family: var(--font-family-base);
          line-height: var(--line-height-normal);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }

        body {
          margin: 0;
          padding: 0;
          overflow-x: hidden;
        }

        *,
        *::before,
        *::after {
          box-sizing: inherit;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          margin: 0;
          font-weight: var(--font-weight-semibold);
          line-height: var(--line-height-tight);
          color: var(--color-text);
          letter-spacing: var(--letter-spacing-tight);
        }

        h1 {
          font-size: var(--font-size-4xl);
        }
        h2 {
          font-size: var(--font-size-3xl);
        }
        h3 {
          font-size: var(--font-size-2xl);
        }
        h4 {
          font-size: var(--font-size-xl);
        }
        h5 {
          font-size: var(--font-size-lg);
        }
        h6 {
          font-size: var(--font-size-md);
        }

        p {
          margin: 0 0 var(--space-16) 0;
        }

        a {
          color: var(--color-primary);
          text-decoration: none;
          transition: color var(--duration-fast) var(--ease-standard);
        }

        a:hover {
          color: var(--color-primary-hover);
        }

        code,
        pre {
          font-family: var(--font-family-mono);
          font-size: calc(var(--font-size-base) * 0.95);
          background-color: var(--color-secondary);
          border-radius: var(--radius-sm);
        }

        code {
          padding: var(--space-1) var(--space-4);
        }

        pre {
          padding: var(--space-16);
          margin: var(--space-16) 0;
          overflow: auto;
          border: 1px solid var(--color-border);
        }

        pre code {
          background: none;
          padding: 0;
        }

        /* Buttons */
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-8) var(--space-16);
          border-radius: var(--radius-base);
          font-size: var(--font-size-base);
          font-weight: 500;
          line-height: 1.5;
          cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none;
          text-decoration: none;
          position: relative;
        }

        .btn:focus-visible {
          outline: none;
          box-shadow: var(--focus-ring);
        }

        .btn--primary {
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
          background: var(--color-primary-hover);
        }

        .btn--primary:active {
          background: var(--color-primary-active);
        }

        .btn--secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }

        .btn--secondary:hover {
          background: var(--color-secondary-hover);
        }

        .btn--secondary:active {
          background: var(--color-secondary-active);
        }

        .btn--outline {
          background: transparent;
          border: 1px solid var(--color-border);
          color: var(--color-text);
        }
        
        .btn--danger {
            background-color: var(--color-error);
            color: white;
        }

        .btn--danger:hover {
            background-color: rgba(var(--color-red-500-rgb), 0.8);
        }


        .btn--outline:hover {
          background: var(--color-secondary);
        }

        .btn--sm {
          padding: var(--space-4) var(--space-12);
          font-size: var(--font-size-sm);
          border-radius: var(--radius-sm);
        }

        .btn--lg {
          padding: var(--space-10) var(--space-20);
          font-size: var(--font-size-lg);
          border-radius: var(--radius-md);
        }

        .btn--full-width {
          width: 100%;
        }

        .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        /* Form elements */
        .form-control {
          display: block;
          width: 100%;
          padding: var(--space-8) var(--space-12);
          font-size: var(--font-size-md);
          line-height: 1.5;
          color: var(--color-text);
          background-color: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          transition: border-color var(--duration-fast) var(--ease-standard),
            box-shadow var(--duration-fast) var(--ease-standard);
        }

        textarea.form-control {
          font-family: var(--font-family-base);
          font-size: var(--font-size-base);
        }

        select.form-control {
          padding: var(--space-8) var(--space-12);
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: var(--select-caret-light);
          background-repeat: no-repeat;
          background-position: right var(--space-12) center;
          background-size: 16px;
          padding-right: var(--space-32);
        }

        /* Add a dark mode specific caret */
        @media (prefers-color-scheme: dark) {
          select.form-control {
            background-image: var(--select-caret-dark);
          }
        }

        /* Also handle data-color-scheme */
        [data-color-scheme="dark"] select.form-control {
          background-image: var(--select-caret-dark);
        }

        [data-color-scheme="light"] select.form-control {
          background-image: var(--select-caret-light);
        }

        .form-control:focus {
          border-color: var(--color-primary);
          outline: var(--focus-outline);
        }

        .form-label {
          display: block;
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }

        .form-group {
          margin-bottom: var(--space-16);
        }

        /* Card component */
        .card {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          border: 1px solid var(--color-card-border);
          box-shadow: var(--shadow-sm);
          overflow: hidden;
          transition: box-shadow var(--duration-normal) var(--ease-standard);
        }

        .card:hover {
          box-shadow: var(--shadow-md);
        }

        .card__body {
          padding: var(--space-16);
        }

        .card__header,
        .card__footer {
          padding: var(--space-16);
          border-bottom: 1px solid var(--color-card-border-inner);
        }

        /* Status indicators - simplified with CSS variables */
        .status {
          display: inline-flex;
          align-items: center;
          padding: var(--space-6) var(--space-12);
          border-radius: var(--radius-full);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }

        .status--success {
          background-color: rgba(
            var(--color-success-rgb, 33, 128, 141),
            var(--status-bg-opacity)
          );
          color: var(--color-success);
          border: 1px solid
            rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));
        }

        .status--error {
          background-color: rgba(
            var(--color-error-rgb, 192, 21, 47),
            var(--status-bg-opacity)
          );
          color: var(--color-error);
          border: 1px solid
            rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));
        }

        .status--warning {
          background-color: rgba(
            var(--color-warning-rgb, 168, 75, 47),
            var(--status-bg-opacity)
          );
          color: var(--color-warning);
          border: 1px solid
            rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));
        }

        .status--info {
          background-color: rgba(
            var(--color-info-rgb, 98, 108, 113),
            var(--status-bg-opacity)
          );
          color: var(--color-info);
          border: 1px solid
            rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));
        }

        /* Container layout */
        .container {
          width: 100%;
          margin-right: auto;
          margin-left: auto;
          padding-right: var(--space-16);
          padding-left: var(--space-16);
        }

        @media (min-width: 640px) {
          .container {
            max-width: var(--container-sm);
          }
        }
        @media (min-width: 768px) {
          .container {
            max-width: var(--container-md);
          }
        }
        @media (min-width: 1024px) {
          .container {
            max-width: var(--container-lg);
          }
        }
        @media (min-width: 1280px) {
          .container {
            max-width: var(--container-xl);
          }
        }

        /* Utility classes */
        .flex {
          display: flex;
        }
        .flex-col {
          flex-direction: column;
        }
        .items-center {
          align-items: center;
        }
        .justify-center {
          justify-content: center;
        }
        .justify-between {
          justify-content: space-between;
        }
        .gap-4 {
          gap: var(--space-4);
        }
        .gap-8 {
          gap: var(--space-8);
        }
        .gap-16 {
          gap: var(--space-16);
        }

        .m-0 {
          margin: 0;
        }
        .mt-8 {
          margin-top: var(--space-8);
        }
        .mb-8 {
          margin-bottom: var(--space-8);
        }
        .mx-8 {
          margin-left: var(--space-8);
          margin-right: var(--space-8);
        }
        .my-8 {
          margin-top: var(--space-8);
          margin-bottom: var(--space-8);
        }

        .p-0 {
          padding: 0;
        }
        .py-8 {
          padding-top: var(--space-8);
          padding-bottom: var(--space-8);
        }
        .px-8 {
          padding-left: var(--space-8);
          padding-right: var(--space-8);
        }
        .py-16 {
          padding-top: var(--space-16);
          padding-bottom: var(--space-16);
        }
        .px-16 {
          padding-left: var(--space-16);
          padding-right: var(--space-16);
        }

        .block {
          display: block;
        }
        .hidden {
          display: none;
        }

        /* Accessibility */
        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border-width: 0;
        }

        :focus-visible {
          outline: var(--focus-outline);
          outline-offset: 2px;
        }

        /* Dark mode specifics */
        [data-color-scheme="dark"] .btn--outline {
          border: 1px solid var(--color-border-secondary);
        }

        @font-face {
          font-family: 'FKGroteskNeue';
          src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
            format('woff2');
        }

        /* END PERPLEXITY DESIGN SYSTEM */
        /* CRM Dashboard Styles */
        body {
            margin: 0;
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            transition: width var(--duration-normal) var(--ease-standard);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: var(--space-20);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-xl);
            color: var(--color-primary);
        }

        .sidebar.collapsed .logo-text {
            display: none;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-8);
            border-radius: var(--radius-base);
            transition: background-color var(--duration-fast) var(--ease-standard);
        }

        .sidebar-toggle:hover {
            background-color: var(--color-secondary);
        }

        .sidebar-menu {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-16);
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            text-decoration: none;
            color: var(--color-text-secondary);
            transition: all var(--duration-fast) var(--ease-standard);
            font-weight: var(--font-weight-medium);
        }

        .menu-item:hover {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .menu-item.active {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .sidebar-footer {
            padding: var(--space-16);
            border-top: 1px solid var(--color-border);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--space-12);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .user-role {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .sidebar.collapsed .user-info {
            display: none;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: margin-left var(--duration-normal) var(--ease-standard);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            max-width: 100%;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 70px;
        }

        /* Header Styles */
        .header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16) var(--space-24);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left h1 {
            margin: 0 0 var(--space-4) 0;
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-16);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: var(--space-8) var(--space-12) var(--space-8) var(--space-32);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background-color: var(--color-background);
            color: var(--color-text);
            font-size: var(--font-size-sm);
            width: 250px;
        }

        .search-box i {
            position: absolute;
            left: var(--space-12);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-8);
            cursor: pointer;
            color: var(--color-text-secondary);
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .theme-toggle:hover {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        /* Views */
        .view {
            flex: 1;
            padding: var(--space-24);
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-20);
            margin-bottom: var(--space-32);
        }

        .metric-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            display: flex;
            align-items: center;
            gap: var(--space-16);
            transition: box-shadow var(--duration-normal) var(--ease-standard);
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            color: white;
        }

        .metric-icon.sales {
            background: linear-gradient(135deg, var(--color-teal-500), var(--color-teal-600));
        }

        .metric-icon.deals {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
        }

        .metric-icon.contacts {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .metric-icon.conversion {
            background: linear-gradient(135deg, #F59E0B, #D97706);
        }

        .metric-content h3 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin: 0 0 var(--space-4) 0;
        }

        .metric-content p {
            color: var(--color-text-secondary);
            margin: 0 0 var(--space-8) 0;
            font-size: var(--font-size-sm);
        }

        .metric-change {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            padding: var(--space-2) var(--space-8);
            border-radius: var(--radius-full);
        }

        .metric-change.positive {
            background-color: rgba(var(--color-success-rgb), 0.1);
            color: var(--color-success);
        }

        .metric-change.negative {
            background-color: rgba(var(--color-error-rgb), 0.1);
            color: var(--color-error);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-24);
        }

        .chart-card {
            height: 400px;
        }

        .chart-container {
            width: 100%;
            height: 100%;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: var(--space-12);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            background-color: var(--color-background);
        }

        .activity-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: var(--font-size-sm);
            margin: 0 0 var(--space-4) 0;
        }

        .activity-time {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Pipeline Board */
        .pipeline-header {
            margin-bottom: var(--space-24);
        }

        .pipeline-filters {
            display: flex;
            gap: var(--space-16);
            align-items: center;
        }

        .pipeline-filters .form-control {
            width: auto;
            min-width: 200px;
        }

        .pipeline-board {
            display: flex;
            gap: var(--space-20);
            overflow-x: auto;
            padding-bottom: var(--space-16);
        }

        .pipeline-column {
            min-width: 300px;
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            flex-shrink: 0;
        }

        .pipeline-column-header {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-card-border-inner);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .column-indicator {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
        }

        .column-count {
            background-color: var(--color-secondary);
            color: var(--color-text);
            border-radius: var(--radius-full);
            padding: var(--space-2) var(--space-8);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .pipeline-column-body {
            padding: var(--space-16);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }

        .deal-card {
            background-color: var(--color-background);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            cursor: move;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .deal-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .deal-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .deal-title {
            font-weight: var(--font-weight-semibold);
            margin: 0 0 var(--space-8) 0;
            font-size: var(--font-size-base);
        }

        .deal-amount {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin: 0 0 var(--space-8) 0;
        }

        .deal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .deal-contact {
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }

        .deal-probability {
            background-color: var(--color-secondary);
            padding: var(--space-2) var(--space-6);
            border-radius: var(--radius-base);
            font-size: var(--font-size-xs);
        }

        /* Contacts/Companies/Deals Grids */
        .view-header {
            margin-bottom: var(--space-24);
        }

        .view-filters {
            display: flex;
            gap: var(--space-16);
            align-items: center;
        }

        .view-filters .form-control {
            width: auto;
            min-width: 200px;
        }

        .contacts-grid,
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-20);
        }

        .contact-card,
        .company-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            transition: all var(--duration-normal) var(--ease-standard);
            cursor: pointer;
        }

        .contact-card:hover,
        .company-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .contact-header,
        .company-header {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            margin-bottom: var(--space-16);
        }

        .contact-avatar,
        .company-avatar {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
        }

        .contact-info h3,
        .company-info h3 {
            margin: 0 0 var(--space-4) 0;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }

        .contact-email,
        .company-industry {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .contact-details,
        .company-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .contact-detail,
        .company-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
        }

        .contact-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-6);
            margin-top: var(--space-12);
        }

        .tag {
            background-color: var(--color-secondary);
            color: var(--color-text);
            padding: var(--space-2) var(--space-8);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Deals Table */
        .deals-table-container {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            overflow: hidden;
        }

        .deals-table {
            width: 100%;
            border-collapse: collapse;
        }

        .deals-table th {
            background-color: var(--color-background);
            padding: var(--space-16);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-card-border-inner);
        }

        .deals-table td {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-card-border-inner);
            font-size: var(--font-size-sm);
        }

        .deals-table tbody tr:hover {
            background-color: var(--color-background);
        }

        .stage-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-6);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-base);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .stage-indicator {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
        }

        .probability-bar {
            width: 60px;
            height: 6px;
            background-color: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            background-color: var(--color-primary);
            border-radius: var(--radius-full);
            transition: width var(--duration-normal) var(--ease-standard);
        }

        .deal-actions {
            display: flex;
            gap: var(--space-8);
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .btn-icon:hover {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-20);
            border-bottom: 1px solid var(--color-card-border-inner);
        }

        .modal-header h2 {
            margin: 0;
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--font-size-lg);
            padding: var(--space-8);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .modal-close:hover {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .modal-body {
            padding: var(--space-20);
        }

        .modal-footer {
            display: flex;
            gap: var(--space-12);
            justify-content: flex-end;
            padding: var(--space-20);
            border-top: 1px solid var(--color-card-border-inner);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: var(--space-20);
            right: var(--space-20);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .toast {
            background-color: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-base);
            padding: var(--space-12) var(--space-16);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: var(--space-12);
            min-width: 300px;
            animation: slideInRight var(--duration-normal) var(--ease-standard);
        }

        .toast.success {
            border-left: 4px solid var(--color-success);
        }

        .toast.error {
            border-left: 4px solid var(--color-error);
        }

        .toast.info {
            border-left: 4px solid var(--color-info);
        }

        .toast-icon {
            font-size: var(--font-size-lg);
        }

        .toast.success .toast-icon {
            color: var(--color-success);
        }

        .toast.error .toast-icon {
            color: var(--color-error);
        }

        .toast.info .toast-icon {
            color: var(--color-info);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: var(--font-weight-semibold);
            margin: 0 0 var(--space-2) 0;
            font-size: var(--font-size-sm);
        }

        .toast-message {
            margin: 0;
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: var(--space-2);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Drag and Drop */
        .pipeline-column.drag-over {
            border: 2px dashed var(--color-primary);
            background-color: rgba(var(--color-teal-500-rgb), 0.05);
        }

        .deal-card.placeholder {
            border: 2px dashed var(--color-border);
            background-color: transparent;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: var(--space-24);
            }
            .chart-card {
                height: 350px; /* Adjust height for stacked view */
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .logo-text,
            .sidebar .menu-item span,
            .sidebar .user-info {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .header {
                padding: var(--space-12) var(--space-16);
                flex-direction: column;
                gap: var(--space-12);
                align-items: stretch;
            }
            
            .header-left {
                width: 100%;
                text-align: center;
            }

            .breadcrumb {
                justify-content: center;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-box {
                flex-grow: 1;
            }

            .search-box input {
                width: 100%;
            }

            #addNewBtn span {
                display: none;
            }
            #addNewBtn {
                padding: var(--space-8) var(--space-12);
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .pipeline-board {
                flex-direction: column;
                overflow-x: hidden;
                gap: var(--space-16);
            }
            
            .pipeline-column {
                min-width: 100%;
            }
            
            .contacts-grid,
            .companies-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: var(--space-16);
                width: calc(100% - 32px);
            }
            
            .view-filters,
            .pipeline-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .view-filters .form-control,
            .pipeline-filters .form-control {
                width: 100%;
                min-width: unset;
            }
            .deals-table-container {
                overflow-x: hidden;
            }
            .deals-table {
                border: none;
            }

            .deals-table thead {
                display: none;
            }

            .deals-table tr {
                display: block;
                margin-bottom: var(--space-16);
                border: 1px solid var(--color-border);
                border-radius: var(--radius-base);
                padding: var(--space-8);
            }

            .deals-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: var(--space-8) 0;
                border-bottom: 1px solid var(--color-border);
                text-align: right;
            }

            .deals-table td:last-child {
                border-bottom: none;
            }

            .deals-table td::before {
                content: attr(data-label);
                font-weight: var(--font-weight-medium);
                text-align: left;
                padding-right: var(--space-16);
            }

            .deals-table td .deal-actions {
                justify-content: flex-end;
            }
        }

        @media (max-width: 480px) {
            .view {
                padding: var(--space-16);
            }
            
            .metrics-grid {
                gap: var(--space-12);
            }
            
            .metric-card {
                padding: var(--space-16);
            }
            
            .pipeline-column {
                min-width: 100%;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-32);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-secondary);
            border-top: 3px solid var(--color-primary);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .empty-state i {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-16);
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 var(--space-8) 0;
            font-size: var(--font-size-xl);
            color: var(--color-text);
        }

        .empty-state p {
            margin: 0;
            font-size: var(--font-size-base);
        }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <span class="logo-text">CRM Pro</span>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="#" class="menu-item active" data-view="dashboard">
                        <i class="fas fa-chart-pie"></i>
                        <span>Tablero</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-view="pipeline">
                        <i class="fas fa-columns"></i>
                        <span>Embudo de Ventas</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-view="contacts">
                        <i class="fas fa-users"></i>
                        <span>Contactos</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-view="companies">
                        <i class="fas fa-building"></i>
                        <span>Empresas</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-view="deals">
                        <i class="fas fa-handshake"></i>
                        <span>Negocios</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="sidebar-footer">
            <a href="#" class="menu-item" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </nav>

    <main class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <h1 class="page-title" id="pageTitle">Tablero</h1>
                <div class="breadcrumb">
                    <span>CRM</span>
                    <i class="fas fa-chevron-right"></i>
                    <span id="breadcrumbCurrent">Tablero</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="search-box">
                    <input type="text" placeholder="Buscar..." id="globalSearch">
                    <i class="fas fa-search"></i>
                </div>
                
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                
                <button class="btn btn--primary" id="addNewBtn">
                    <i class="fas fa-plus"></i>
                    <span>Agregar</span>
                </button>
            </div>
        </header>

        <div class="view active" id="dashboard-view">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon sales">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="metric-content">
                        <h3 id="totalRevenue">$0</h3>
                        <p>Ingresos Totales</p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon deals">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="metric-content">
                        <h3 id="activeDeals">0</h3>
                        <p>Negocios Activos</p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon contacts">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-content">
                        <h3 id="totalContacts">0</h3>
                        <p>Contactos</p>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-icon conversion">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="metric-content">
                        <h3 id="conversionRate">0%</h3>
                        <p>Tasa de Conversión</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card chart-card">
                    <div class="card__header">
                        <h3>Embudo por Etapa</h3>
                    </div>
                    <div class="card__body">
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="pipelineChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card chart-card">
                    <div class="card__header">
                        <h3>Actividad Reciente</h3>
                    </div>
                    <div class="card__body">
                        <div class="activity-feed" id="activityFeed">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view" id="pipeline-view">
            <div class="pipeline-header">
                <div class="pipeline-filters">
                    <select id="ownerFilter" class="form-control">
                        <option value="">Todos los propietarios</option>
                    </select>
                    <input type="text" placeholder="Buscar negocios..." id="pipelineSearch" class="form-control">
                </div>
            </div>
            
            <div class="pipeline-board" id="pipelineBoard">
                </div>
        </div>

        <div class="view" id="contacts-view">
            <div class="view-header">
                <div class="view-filters">
                    <input type="text" placeholder="Buscar contactos..." id="contactsSearch" class="form-control">
                    <select id="contactsCompanyFilter" class="form-control">
                        <option value="">Todas las empresas</option>
                    </select>
                </div>
            </div>
            
            <div class="contacts-grid" id="contactsGrid">
                </div>
        </div>

        <div class="view" id="companies-view">
            <div class="view-header">
                <div class="view-filters">
                    <input type="text" placeholder="Buscar empresas..." id="companiesSearch" class="form-control">
                    <select id="companiesIndustryFilter" class="form-control">
                        <option value="">Todas las industrias</option>
                    </select>
                </div>
            </div>
            
            <div class="companies-grid" id="companiesGrid">
                </div>
        </div>

        <div class="view" id="deals-view">
            <div class="view-header">
                <div class="view-filters">
                    <input type="text" placeholder="Buscar negocios..." id="dealsSearch" class="form-control">
                    <select id="dealsStageFilter" class="form-control">
                        <option value="">Todas las etapas</option>
                    </select>
                </div>
            </div>
            
            <div class="deals-table-container">
                <table class="deals-table" id="dealsTable">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Monto</th>
                            <th>Etapa</th>
                            <th>Probabilidad</th>
                            <th>Fecha Cierre</th>
                            <th>Contacto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="dealsTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal hidden" id="dealModal">
        <div class="modal-overlay" id="dealModalOverlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dealModalTitle">Agregar Negocio</h2>
                <button class="modal-close" id="dealModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="dealForm">
                    <div class="form-group">
                        <label class="form-label">Título</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Monto</label>
                            <input type="number" name="amount" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Moneda</label>
                            <select name="currency" class="form-control">
                                <option value="USD">$us</option>
                                <option value="BOB">BOB</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Etapa</label>
                            <select name="stage" class="form-control" required>
                                </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Probabilidad (%)</label>
                            <input type="number" name="probability" class="form-control" min="0" max="100">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Contacto</label>
                            <select name="contactId" class="form-control">
                                <option value="">Seleccionar contacto</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Cierre</label>
                            <input type="date" name="closeDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-danger hidden" id="dealDeleteBtn">Eliminar</button>
                <button type="button" class="btn btn--outline" id="dealCancelBtn">Cancelar</button>
                <button type="submit" form="dealForm" class="btn btn--primary">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="contactModal">
        <div class="modal-overlay" id="contactModalOverlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contactModalTitle">Agregar Contacto</h2>
                <button class="modal-close" id="contactModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="contactForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre</label>
                            <input type="text" name="firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Apellido</label>
                            <input type="text" name="lastName" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Correo Electrónico</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Empresa</label>
                            <select name="companyId" class="form-control">
                                <option value="">Seleccionar empresa</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Puntuación</label>
                            <input type="number" name="score" class="form-control" min="0" max="100" value="50">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Etiquetas (separadas por comas)</label>
                        <input type="text" name="tags" class="form-control" placeholder="ej: Tomador de decisiones, Gerente de TI">
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary hidden" id="contactHistoryBtn" style="margin-right: auto;">Ver Historial</button>
                <button type="button" class="btn btn--danger hidden" id="contactDeleteBtn" style="margin-right: 10px;">Eliminar</button>
                <button type="button" class="btn btn--outline" id="contactCancelBtn">Cancelar</button>
                <button type="submit" form="contactForm" class="btn btn--primary">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="companyModal">
        <div class="modal-overlay" id="companyModalOverlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="companyModalTitle">Agregar Empresa</h2>
                <button class="modal-close" id="companyModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="companyForm">
                    <div class="form-group">
                        <label class="form-label">Nombre de la Empresa</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Industria</label>
                            <input type="text" name="industry" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tamaño</label>
                            <select name="size" class="form-control" required>
                                <option value="">Seleccionar tamaño</option>
                                <option value="1-10">1-10 empleados</option>
                                <option value="10-50">10-50 empleados</option>
                                <option value="50-200">50-200 empleados</option>
                                <option value="200-500">200-500 empleados</option>
                                <option value="500+">500+ empleados</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Sitio Web</label>
                            <input type="url" name="website" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ingresos Anuales</label>
                            <input type="number" name="revenue" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ubicación</label>
                        <input type="text" name="location" class="form-control">
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn--danger hidden" id="companyDeleteBtn" style="margin-right: auto;">Eliminar</button>
                <button type="button" class="btn btn--outline" id="companyCancelBtn">Cancelar</button>
                <button type="submit" form="companyForm" class="btn btn--primary">Guardar</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="historyModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">Historial del Cliente</h2>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="historyModalBody">
                </div>
            <div class="modal-footer">
                 <button type="button" class="btn btn--outline" id="historyCancelBtn">Cerrar</button>
            </div>
        </div>
    </div>


    <div class="toast-container" id="toastContainer">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // CRM Dashboard Application
        class CRMApp {
            constructor() {
                this.currentView = 'dashboard';
                this.currentUser = { id: 1, name: 'Alex Rodriguez', role: 'Gerente de Ventas' };
                this.isDarkMode = false;
                this.sidebarCollapsed = false;
                this.editingDealId = null;
                this.editingContactId = null;
                this.editingCompanyId = null;
                
                // Initialize data from provided JSON or localStorage
                this.initializeData();
                this.bindEvents();
                this.initializeApp();
            }

            initializeData() {
                const savedData = localStorage.getItem('crmData');
                
                this.users = [
                    {
                        id: 1,
                        name: "Alex Rodriguez",
                        email: "alex@company.com",
                        role: "Gerente de Ventas",
                        avatar: "AR"
                    },
                    {
                        id: 2,
                        name: "Maria Garcia",
                        email: "maria@company.com",
                        role: "Representante de Ventas Senior",
                        avatar: "MG"
                    }
                ];

                this.pipelineStages = [
                    {
                        id: "lead",
                        name: "Cliente Potencial",
                        color: "#6B7280",
                        defaultProbability: 10,
                        order: 1
                    },
                    {
                        id: "qualified",
                        name: "Calificado",
                        color: "#3B82F6",
                        defaultProbability: 25,
                        order: 2
                    },
                    {
                        id: "proposal",
                        name: "Propuesta",
                        color: "#E68161",
                        defaultProbability: 50,
                        order: 3
                    },
                    {
                        id: "negotiation",
                        name: "Negociación",
                        color: "#F59E0B",
                        defaultProbability: 75,
                        order: 4
                    },
                    {
                        id: "closed-won",
                        name: "Cerrado Ganado",
                        color: "#1d6fb6",
                        defaultProbability: 100,
                        order: 5
                    },
                    {
                        id: "closed-lost",
                        name: "Cerrado Perdido",
                        color: "#EF4444",
                        defaultProbability: 0,
                        order: 6
                    }
                ];

                if (savedData) {
                    const data = JSON.parse(savedData);
                    this.deals = data.deals || [];
                    this.contacts = data.contacts || [];
                    this.companies = data.companies || [];
                } else {
                    this.deals = [];
                    this.contacts = [];
                    this.companies = [];
                }
            }

            saveData() {
                const data = {
                    deals: this.deals,
                    contacts: this.contacts,
                    companies: this.companies,
                    users: this.users,
                    pipelineStages: this.pipelineStages
                };
                localStorage.setItem('crmData', JSON.stringify(data));
            }

            bindEvents() {
                // Use event delegation for navigation
                document.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) {
                        e.preventDefault();
                        const view = menuItem.getAttribute('data-view');
                        if (view) {
                            this.switchView(view);
                        }
                        return;
                    }

                    // Handle other clicks
                    if (e.target.id === 'sidebarToggle' || e.target.closest('#sidebarToggle')) {
                        this.toggleSidebar();
                        return;
                    }

                    if (e.target.id === 'themeToggle' || e.target.closest('#themeToggle')) {
                        this.toggleTheme();
                        return;
                    }

                    if (e.target.id === 'addNewBtn' || e.target.closest('#addNewBtn')) {
                        this.handleAddNew();
                        return;
                    }

                    // Modal close events
                    if (e.target.classList.contains('modal-close') || 
                        e.target.classList.contains('modal-overlay') ||
                        e.target.id.includes('CancelBtn')) {
                        const modal = e.target.closest('.modal');
                        if (modal) {
                            this.closeModal(modal.id);
                        }
                        return;
                    }

                    // Deal card clicks
                    if (e.target.closest('.deal-card')) {
                        const dealCard = e.target.closest('.deal-card');
                        const dealId = parseInt(dealCard.getAttribute('data-deal-id'));
                        this.editDeal(dealId);
                        return;
                    }

                    // Contact card clicks
                    if (e.target.closest('.contact-card')) {
                        const contactCard = e.target.closest('.contact-card');
                        const onclick = contactCard.getAttribute('onclick');
                        if (onclick) {
                            const match = onclick.match(/editContact\((\d+)\)/);
                            if (match) {
                                this.editContact(parseInt(match[1]));
                            }
                        }
                        return;
                    }

                    // Company card clicks
                    if (e.target.closest('.company-card')) {
                        const companyCard = e.target.closest('.company-card');
                        const onclick = companyCard.getAttribute('onclick');
                        if (onclick) {
                            const match = onclick.match(/editCompany\((\d+)\)/);
                            if (match) {
                                this.editCompany(parseInt(match[1]));
                            }
                        }
                        return;
                    }

                    // Deal action buttons
                    if (e.target.closest('.btn-icon')) {
                        e.stopPropagation();
                        const btn = e.target.closest('.btn-icon');
                        const onclick = btn.getAttribute('onclick');
                        if (onclick) {
                            if (onclick.includes('editDeal')) {
                                const match = onclick.match(/editDeal\((\d+)\)/);
                                if (match) {
                                    this.editDeal(parseInt(match[1]));
                                }
                            } else if (onclick.includes('deleteDeal')) {
                                const match = onclick.match(/deleteDeal\((\d+)\)/);
                                if (match) {
                                    this.deleteDeal(parseInt(match[1]));
                                }
                            }
                        }
                        return;
                    }
                });

                // Global search
                const globalSearch = document.getElementById('globalSearch');
                if (globalSearch) {
                    globalSearch.addEventListener('input', (e) => {
                        this.handleGlobalSearch(e.target.value);
                    });
                }

                // Pipeline search and filters
                const pipelineSearch = document.getElementById('pipelineSearch');
                if (pipelineSearch) {
                    pipelineSearch.addEventListener('input', () => {
                        this.filterPipeline();
                    });
                }

                const ownerFilter = document.getElementById('ownerFilter');
                if (ownerFilter) {
                    ownerFilter.addEventListener('change', () => {
                        this.filterPipeline();
                    });
                }

                // Contact filters
                const contactsSearch = document.getElementById('contactsSearch');
                if (contactsSearch) {
                    contactsSearch.addEventListener('input', () => {
                        this.filterContacts();
                    });
                }

                const contactsCompanyFilter = document.getElementById('contactsCompanyFilter');
                if (contactsCompanyFilter) {
                    contactsCompanyFilter.addEventListener('change', () => {
                        this.filterContacts();
                    });
                }

                // Company filters
                const companiesSearch = document.getElementById('companiesSearch');
                if (companiesSearch) {
                    companiesSearch.addEventListener('input', () => {
                        this.filterCompanies();
                    });
                }

                const companiesIndustryFilter = document.getElementById('companiesIndustryFilter');
                if (companiesIndustryFilter) {
                    companiesIndustryFilter.addEventListener('change', () => {
                        this.filterCompanies();
                    });
                }

                // Deal filters
                const dealsSearch = document.getElementById('dealsSearch');
                if (dealsSearch) {
                    dealsSearch.addEventListener('input', () => {
                        this.filterDeals();
                    });
                }

                const dealsStageFilter = document.getElementById('dealsStageFilter');
                if (dealsStageFilter) {
                    dealsStageFilter.addEventListener('change', () => {
                        this.filterDeals();
                    });
                }

                // Form submissions
                this.bindFormEvents();
            }

            bindFormEvents() {
                // Deal form
                const dealForm = document.getElementById('dealForm');
                if (dealForm) {
                    dealForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleDealSubmit(e.target);
                    });
                }

                const dealDeleteBtn = document.getElementById('dealDeleteBtn');
                if (dealDeleteBtn) {
                    dealDeleteBtn.addEventListener('click', () => {
                        if (this.editingDealId) {
                            this.deleteDeal(this.editingDealId);
                        }
                    });
                }

                // Contact form
                const contactForm = document.getElementById('contactForm');
                if (contactForm) {
                    contactForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleContactSubmit(e.target);
                    });
                }

                const contactDeleteBtn = document.getElementById('contactDeleteBtn');
                if(contactDeleteBtn){
                    contactDeleteBtn.addEventListener('click', ()=>{
                        if(this.editingContactId){
                            this.deleteContact(this.editingContactId);
                        }
                    })
                }

                const contactHistoryBtn = document.getElementById('contactHistoryBtn');
                if(contactHistoryBtn){
                    contactHistoryBtn.addEventListener('click', ()=>{
                        if(this.editingContactId){
                            this.showContactHistory(this.editingContactId);
                        }
                    })
                }

                // Company form
                const companyForm = document.getElementById('companyForm');
                if (companyForm) {
                    companyForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCompanySubmit(e.target);
                    });
                }
                
                const companyDeleteBtn = document.getElementById('companyDeleteBtn');
                if(companyDeleteBtn){
                    companyDeleteBtn.addEventListener('click', ()=>{
                        if(this.editingCompanyId){
                            this.deleteCompany(this.editingCompanyId);
                        }
                    })
                }
            }

            initializeApp() {
                this.populateDropdowns();
                this.switchView('dashboard');
            }

            populateDropdowns() {
                // Populate stage options in deal form
                const stageSelect = document.querySelector('#dealForm select[name="stage"]');
                if (stageSelect) {
                    stageSelect.innerHTML = this.pipelineStages.map(stage => 
                        `<option value="${stage.id}">${stage.name}</option>`
                    ).join('');
                }

                // Populate contact options in deal form
                const contactSelect = document.querySelector('#dealForm select[name="contactId"]');
                if (contactSelect) {
                    contactSelect.innerHTML = '<option value="">Seleccionar contacto</option>' +
                        this.contacts.map(contact => 
                            `<option value="${contact.id}">${contact.firstName} ${contact.lastName}</option>`
                        ).join('');
                }

                // Populate company options in contact form
                const companySelect = document.querySelector('#contactForm select[name="companyId"]');
                if (companySelect) {
                    companySelect.innerHTML = '<option value="">Seleccionar empresa</option>' +
                        this.companies.map(company => 
                            `<option value="${company.id}">${company.name}</option>`
                        ).join('');
                }

                // Populate filter dropdowns
                this.populateFilterDropdowns();
            }

            populateFilterDropdowns() {
                // Owner filter
                const ownerFilter = document.getElementById('ownerFilter');
                if (ownerFilter) {
                    ownerFilter.innerHTML = '<option value="">Todos los propietarios</option>' +
                        this.users.map(user => 
                            `<option value="${user.id}">${user.name}</option>`
                        ).join('');
                }

                // Company filter for contacts
                const contactsCompanyFilter = document.getElementById('contactsCompanyFilter');
                if (contactsCompanyFilter) {
                    contactsCompanyFilter.innerHTML = '<option value="">Todas las empresas</option>' +
                        this.companies.map(company => 
                            `<option value="${company.id}">${company.name}</option>`
                        ).join('');
                }

                // Industry filter for companies
                const companiesIndustryFilter = document.getElementById('companiesIndustryFilter');
                if (companiesIndustryFilter) {
                    const industries = [...new Set(this.companies.map(c => c.industry))];
                    companiesIndustryFilter.innerHTML = '<option value="">Todas las industrias</option>' +
                        industries.map(industry => 
                            `<option value="${industry}">${industry}</option>`
                        ).join('');
                }

                // Stage filter for deals
                const dealsStageFilter = document.getElementById('dealsStageFilter');
                if (dealsStageFilter) {
                    dealsStageFilter.innerHTML = '<option value="">Todas las etapas</option>' +
                        this.pipelineStages.map(stage => 
                            `<option value="${stage.id}">${stage.name}</option>`
                        ).join('');
                }
            }

            switchView(viewName) {
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeMenuItem = document.querySelector(`[data-view="${viewName}"]`);
                if (activeMenuItem) {
                    activeMenuItem.classList.add('active');
                }

                // Hide all views
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.remove('active');
                });

                // Show selected view
                const targetView = document.getElementById(`${viewName}-view`);
                if (targetView) {
                    targetView.classList.add('active');
                }

                // Update header
                const titles = {
                    dashboard: 'Tablero',
                    pipeline: 'Embudo de Ventas',
                    contacts: 'Contactos',
                    companies: 'Empresas',
                    deals: 'Negocios'
                };

                const pageTitle = document.getElementById('pageTitle');
                const breadcrumbCurrent = document.getElementById('breadcrumbCurrent');
                
                if (pageTitle) pageTitle.textContent = titles[viewName] || viewName;
                if (breadcrumbCurrent) breadcrumbCurrent.textContent = titles[viewName] || viewName;

                this.currentView = viewName;

                // Load view-specific content
                switch (viewName) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'pipeline':
                        this.loadPipeline();
                        break;
                    case 'contacts':
                        this.loadContacts();
                        break;
                    case 'companies':
                        this.loadCompanies();
                        break;
                    case 'deals':
                        this.loadDeals();
                        break;
                }
            }

            loadDashboard() {
                this.updateMetrics();
                setTimeout(() => {
                    this.loadPipelineChart();
                }, 100);
                this.loadActivityFeed();
            }

            updateMetrics() {
                const totalRevenueUSD = this.deals
                    .filter(deal => deal.stage === 'closed-won' && deal.currency === 'USD')
                    .reduce((sum, deal) => sum + deal.amount, 0);
                
                const totalRevenueBOB = this.deals
                    .filter(deal => deal.stage === 'closed-won' && deal.currency === 'BOB')
                    .reduce((sum, deal) => sum + deal.amount, 0);

                const activeDeals = this.deals.filter(deal => 
                    !['closed-won', 'closed-lost'].includes(deal.stage)
                ).length;

                const totalContacts = this.contacts.length;

                const closedWonDeals = this.deals.filter(deal => deal.stage === 'closed-won').length;
                const totalDealsWithStage = this.deals.filter(deal => 
                    !['lead'].includes(deal.stage)
                ).length;
                const conversionRate = totalDealsWithStage > 0 ? 
                    ((closedWonDeals / totalDealsWithStage) * 100).toFixed(1) : 0;

                const totalRevenueEl = document.getElementById('totalRevenue');
                const activeDealsEl = document.getElementById('activeDeals');
                const totalContactsEl = document.getElementById('totalContacts');
                const conversionRateEl = document.getElementById('conversionRate');

                let revenueString = '';
                if (totalRevenueUSD > 0) {
                    revenueString += this.formatCurrency(totalRevenueUSD, 'USD');
                }
                if (totalRevenueBOB > 0) {
                    if (revenueString) {
                        revenueString += ' / ';
                    }
                    revenueString += this.formatCurrency(totalRevenueBOB, 'BOB');
                }

                if (totalRevenueEl) {
                    totalRevenueEl.textContent = revenueString || '$0.00';
                }
                if (activeDealsEl) activeDealsEl.textContent = activeDeals;
                if (totalContactsEl) totalContactsEl.textContent = totalContacts;
                if (conversionRateEl) conversionRateEl.textContent = `${conversionRate}%`;
            }

            loadPipelineChart() {
                const chartCanvas = document.getElementById('pipelineChart');
                if (!chartCanvas) return;

                const ctx = chartCanvas.getContext('2d');
                
                const stageData = this.pipelineStages.map(stage => {
                    const stageDeals = this.deals.filter(deal => deal.stage === stage.id);
                    return {
                        stage: stage.name,
                        count: stageDeals.length,
                        value: stageDeals.reduce((sum, deal) => sum + deal.amount, 0),
                        color: stage.color
                    };
                });

                // Destroy existing chart if it exists
                if (window.pipelineChart && typeof window.pipelineChart.destroy === 'function') {
                    window.pipelineChart.destroy();
                }

                window.pipelineChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: stageData.map(d => d.stage),
                        datasets: [{
                            data: stageData.map(d => d.count),
                            backgroundColor: this.pipelineStages.map(s => s.color),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            loadActivityFeed() {
                const activities = [];

                const activityFeed = document.getElementById('activityFeed');
                if (activityFeed) {
                    if(activities.length === 0){
                        activityFeed.innerHTML = `<div class="empty-state" style="padding: 16px;"><i class="fas fa-history"></i><p>No hay actividad reciente.</p></div>`;
                        return;
                    }
                    activityFeed.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-avatar">${activity.user}</div>
                            <div class="activity-content">
                                <p class="activity-text">${activity.text}</p>
                                <span class="activity-time">${activity.time}</span>
                            </div>
                        </div>
                    `).join('');
                }
            }

            loadPipeline() {
                const pipelineBoard = document.getElementById('pipelineBoard');
                if (!pipelineBoard) return;
                
                pipelineBoard.innerHTML = '';

                this.pipelineStages.forEach(stage => {
                    const stageDeals = this.deals.filter(deal => deal.stage === stage.id);

                    const column = document.createElement('div');
                    column.className = 'pipeline-column';
                    column.setAttribute('data-stage', stage.id);

                    column.innerHTML = `
                        <div class="pipeline-column-header">
                            <div class="column-title">
                                <div class="column-indicator" style="background-color: ${stage.color}"></div>
                                ${stage.name}
                            </div>
                            <div class="column-count">${stageDeals.length}</div>
                        </div>
                        <div class="pipeline-column-body" data-stage="${stage.id}">
                            ${stageDeals.length > 0 ? stageDeals.map(deal => this.createDealCard(deal)).join('') : '<div class="empty-state" style="padding: 16px;"><i class="fas fa-folder-open"></i><p>No hay negocios en esta etapa.</p></div>'}
                        </div>
                    `;

                    pipelineBoard.appendChild(column);
                });

                this.setupDragAndDrop();
            }

            formatCurrency(amount, currency) {
                if (currency === 'BOB') {
                    return new Intl.NumberFormat('es-BO', { style: 'currency', currency: 'BOB' }).format(amount);
                }
                // Default to USD
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            }

            createDealCard(deal) {
                const contact = this.contacts.find(c => c.id === deal.contactId);
                const contactName = contact ? `${contact.firstName} ${contact.lastName}` : 'Sin contacto';

                return `
                    <div class="deal-card" draggable="true" data-deal-id="${deal.id}">
                        <h4 class="deal-title">${deal.title}</h4>
                        <p class="deal-amount">${this.formatCurrency(deal.amount, deal.currency)}</p>
                        <div class="deal-meta">
                            <span class="deal-contact">
                                <i class="fas fa-user"></i>
                                ${contactName}
                            </span>
                            <span class="deal-probability">${deal.probability}%</span>
                        </div>
                    </div>
                `;
            }

            setupDragAndDrop() {
                // Remove existing event listeners
                const dealCards = document.querySelectorAll('.deal-card');
                const columns = document.querySelectorAll('.pipeline-column-body');

                dealCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', card.getAttribute('data-deal-id'));
                        card.classList.add('dragging');
                    });

                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                    });
                });

                columns.forEach(column => {
                    column.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        column.parentElement.classList.add('drag-over');
                    });

                    column.addEventListener('dragleave', (e) => {
                        if (!column.contains(e.relatedTarget)) {
                            column.parentElement.classList.remove('drag-over');
                        }
                    });

                    column.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const dealId = parseInt(e.dataTransfer.getData('text/plain'));
                        const newStage = column.getAttribute('data-stage');
                        
                        this.moveDeal(dealId, newStage);
                        column.parentElement.classList.remove('drag-over');
                    });
                });
            }

            moveDeal(dealId, newStage) {
                const deal = this.deals.find(d => d.id === dealId);
                if (!deal) return;

                const stage = this.pipelineStages.find(s => s.id === newStage);
                if (!stage) return;

                const oldStage = this.pipelineStages.find(s => s.id === deal.stage);
                
                deal.stage = newStage;
                deal.probability = stage.defaultProbability;

                this.saveData();
                this.loadPipeline();
                this.showToast('success', 'Negocio movido', `"${deal.title}" movido de ${oldStage.name} a ${stage.name}`);
            }

            loadContacts() {
                this.renderContacts(this.contacts);
            }

            renderContacts(contacts) {
                const contactsGrid = document.getElementById('contactsGrid');
                if (!contactsGrid) return;
                
                if (contacts.length === 0) {
                    contactsGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No hay contactos</h3>
                            <p>Comienza agregando tu primer contacto</p>
                        </div>
                    `;
                    return;
                }

                contactsGrid.innerHTML = contacts.map(contact => {
                    const company = this.companies.find(c => c.id === contact.companyId);
                    const companyName = company ? company.name : 'Sin empresa';

                    return `
                        <div class="contact-card" onclick="crm.editContact(${contact.id})">
                            <div class="contact-header">
                                <div class="contact-avatar">${contact.firstName[0]}${contact.lastName[0]}</div>
                                <div class="contact-info">
                                    <h3>${contact.firstName} ${contact.lastName}</h3>
                                    <p class="contact-email">${contact.email}</p>
                                </div>
                            </div>
                            <div class="contact-details">
                                <div class="contact-detail">
                                    <span>Empresa:</span>
                                    <span>${companyName}</span>
                                </div>
                                <div class="contact-detail">
                                    <span>Teléfono:</span>
                                    <span>${contact.phone || 'N/A'}</span>
                                </div>
                                <div class="contact-detail">
                                    <span>Puntuación:</span>
                                    <span>${contact.score}/100</span>
                                </div>
                            </div>
                            ${contact.tags && contact.tags.length > 0 ? `
                                <div class="contact-tags">
                                    ${contact.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            loadCompanies() {
                this.renderCompanies(this.companies);
            }

            renderCompanies(companies) {
                const companiesGrid = document.getElementById('companiesGrid');
                if (!companiesGrid) return;
                
                if (companies.length === 0) {
                    companiesGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-building"></i>
                            <h3>No hay empresas</h3>
                            <p>Comienza agregando tu primera empresa</p>
                        </div>
                    `;
                    return;
                }

                companiesGrid.innerHTML = companies.map(company => {
                    const contactsCount = this.contacts.filter(c => c.companyId === company.id).length;
                    const dealsCount = this.deals.filter(d => d.companyId === company.id).length;

                    return `
                        <div class="company-card" onclick="crm.editCompany(${company.id})">
                            <div class="company-header">
                                <div class="company-avatar">${company.name[0]}</div>
                                <div class="company-info">
                                    <h3>${company.name}</h3>
                                    <p class="company-industry">${company.industry}</p>
                                </div>
                            </div>
                            <div class="company-details">
                                <div class="company-detail">
                                    <span>Tamaño:</span>
                                    <span>${company.size}</span>
                                </div>
                                <div class="company-detail">
                                    <span>Ubicación:</span>
                                    <span>${company.location}</span>
                                </div>
                                <div class="company-detail">
                                    <span>Contactos:</span>
                                    <span>${contactsCount}</span>
                                </div>
                                <div class="company-detail">
                                    <span>Negocios:</span>
                                    <span>${dealsCount}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            loadDeals() {
                this.renderDeals(this.deals);
            }

            renderDeals(deals) {
                const dealsTableBody = document.getElementById('dealsTableBody');
                if (!dealsTableBody) return;
                
                if (deals.length === 0) {
                    dealsTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-handshake"></i>
                                <h3>No hay negocios</h3>
                                <p>Comienza agregando tu primer negocio</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                dealsTableBody.innerHTML = deals.map(deal => {
                    const contact = this.contacts.find(c => c.id === deal.contactId);
                    const contactName = contact ? `${contact.firstName} ${contact.lastName}` : 'Sin contacto';
                    const stage = this.pipelineStages.find(s => s.id === deal.stage);

                    return `
                        <tr>
                            <td data-label="Título">${deal.title}</td>
                            <td data-label="Monto">${this.formatCurrency(deal.amount, deal.currency)}</td>
                            <td data-label="Etapa">
                                <span class="stage-badge">
                                    <div class="stage-indicator" style="background-color: ${stage.color}"></div>
                                    ${stage.name}
                                </span>
                            </td>
                            <td data-label="Probabilidad">
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${deal.probability}%"></div>
                                </div>
                                ${deal.probability}%
                            </td>
                            <td data-label="Fecha Cierre">${new Date(deal.closeDate).toLocaleDateString('es-ES')}</td>
                            <td data-label="Contacto">${contactName}</td>
                            <td data-label="Acciones">
                                <div class="deal-actions">
                                    <button class="btn-icon" onclick="crm.editDeal(${deal.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="crm.deleteDeal(${deal.id})" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Filter functions
            filterPipeline() {
                const searchEl = document.getElementById('pipelineSearch');
                const ownerEl = document.getElementById('ownerFilter');
                
                const search = searchEl ? searchEl.value.toLowerCase() : '';
                const ownerId = ownerEl ? ownerEl.value : '';

                let filteredDeals = this.deals;

                if (search) {
                    filteredDeals = filteredDeals.filter(deal => 
                        deal.title.toLowerCase().includes(search)
                    );
                }

                if (ownerId) {
                    filteredDeals = filteredDeals.filter(deal => 
                        deal.ownerId == ownerId
                    );
                }

                // Re-render pipeline with filtered deals
                const pipelineBoard = document.getElementById('pipelineBoard');
                if (!pipelineBoard) return;
                
                pipelineBoard.innerHTML = '';

                this.pipelineStages.forEach(stage => {
                    const stageDeals = filteredDeals.filter(deal => deal.stage === stage.id);

                    const column = document.createElement('div');
                    column.className = 'pipeline-column';
                    column.setAttribute('data-stage', stage.id);

                    column.innerHTML = `
                        <div class="pipeline-column-header">
                            <div class="column-title">
                                <div class="column-indicator" style="background-color: ${stage.color}"></div>
                                ${stage.name}
                            </div>
                            <div class="column-count">${stageDeals.length}</div>
                        </div>
                        <div class="pipeline-column-body" data-stage="${stage.id}">
                            ${stageDeals.map(deal => this.createDealCard(deal)).join('')}
                        </div>
                    `;

                    pipelineBoard.appendChild(column);
                });

                this.setupDragAndDrop();
            }

            filterContacts() {
                const searchEl = document.getElementById('contactsSearch');
                const companyEl = document.getElementById('contactsCompanyFilter');
                
                const search = searchEl ? searchEl.value.toLowerCase() : '';
                const companyId = companyEl ? companyEl.value : '';

                let filteredContacts = this.contacts;

                if (search) {
                    filteredContacts = filteredContacts.filter(contact => 
                        contact.firstName.toLowerCase().includes(search) ||
                        contact.lastName.toLowerCase().includes(search) ||
                        contact.email.toLowerCase().includes(search)
                    );
                }

                if (companyId) {
                    filteredContacts = filteredContacts.filter(contact => 
                        contact.companyId == companyId
                    );
                }

                this.renderContacts(filteredContacts);
            }

            filterCompanies() {
                const searchEl = document.getElementById('companiesSearch');
                const industryEl = document.getElementById('companiesIndustryFilter');
                
                const search = searchEl ? searchEl.value.toLowerCase() : '';
                const industry = industryEl ? industryEl.value : '';

                let filteredCompanies = this.companies;

                if (search) {
                    filteredCompanies = filteredCompanies.filter(company => 
                        company.name.toLowerCase().includes(search) ||
                        company.location.toLowerCase().includes(search)
                    );
                }

                if (industry) {
                    filteredCompanies = filteredCompanies.filter(company => 
                        company.industry === industry
                    );
                }

                this.renderCompanies(filteredCompanies);
            }

            filterDeals() {
                const searchEl = document.getElementById('dealsSearch');
                const stageEl = document.getElementById('dealsStageFilter');
                
                const search = searchEl ? searchEl.value.toLowerCase() : '';
                const stage = stageEl ? stageEl.value : '';

                let filteredDeals = this.deals;

                if (search) {
                    filteredDeals = filteredDeals.filter(deal => 
                        deal.title.toLowerCase().includes(search)
                    );
                }

                if (stage) {
                    filteredDeals = filteredDeals.filter(deal => 
                        deal.stage === stage
                    );
                }

                this.renderDeals(filteredDeals);
            }

            handleGlobalSearch(query) {
                if (!query) return;

                query = query.toLowerCase();
                const results = [];

                // Search in deals
                this.deals.forEach(deal => {
                    if (deal.title.toLowerCase().includes(query)) {
                        results.push({ type: 'deal', item: deal });
                    }
                });

                // Search in contacts
                this.contacts.forEach(contact => {
                    if (contact.firstName.toLowerCase().includes(query) ||
                        contact.lastName.toLowerCase().includes(query) ||
                        contact.email.toLowerCase().includes(query)) {
                        results.push({ type: 'contact', item: contact });
                    }
                });

                // Search in companies
                this.companies.forEach(company => {
                    if (company.name.toLowerCase().includes(query)) {
                        results.push({ type: 'company', item: company });
                    }
                });

                if (results.length > 0) {
                    this.showToast('info', 'Búsqueda', `${results.length} resultados encontrados para "${query}"`);
                } else {
                    this.showToast('info', 'Búsqueda', `No se encontraron resultados para "${query}"`);
                }
            }

            handleAddNew() {
                switch (this.currentView) {
                    case 'deals':
                    case 'pipeline':
                        this.openModal('dealModal');
                        break;
                    case 'contacts':
                        this.openModal('contactModal');
                        break;
                    case 'companies':
                        this.openModal('companyModal');
                        break;
                    default:
                        this.openModal('dealModal');
                        break;
                }
            }

            // CRUD operations
            handleDealSubmit(form) {
                const formData = new FormData(form);
                
                if (this.editingDealId) {
                    // Update existing deal
                    const deal = this.deals.find(d => d.id === this.editingDealId);
                    if (deal) {
                        deal.title = formData.get('title');
                        deal.amount = parseFloat(formData.get('amount'));
                        deal.currency = formData.get('currency');
                        deal.stage = formData.get('stage');
                        deal.probability = parseInt(formData.get('probability'));
                        deal.closeDate = formData.get('closeDate');
                        deal.contactId = formData.get('contactId') ? parseInt(formData.get('contactId')) : null;
                        deal.notes = formData.get('notes');

                        // Set company based on contact
                        if (deal.contactId) {
                            const contact = this.contacts.find(c => c.id === deal.contactId);
                            if (contact) {
                                deal.companyId = contact.companyId;
                            }
                        }

                        this.showToast('success', 'Negocio actualizado', `"${deal.title}" actualizado exitosamente`);
                    }
                } else {
                    // Create new deal
                    const deal = {
                        id: Date.now(),
                        title: formData.get('title'),
                        amount: parseFloat(formData.get('amount')),
                        currency: formData.get('currency'),
                        stage: formData.get('stage'),
                        probability: parseInt(formData.get('probability')),
                        closeDate: formData.get('closeDate'),
                        contactId: formData.get('contactId') ? parseInt(formData.get('contactId')) : null,
                        companyId: null,
                        ownerId: this.currentUser.id,
                        createdAt: new Date().toISOString(),
                        notes: formData.get('notes')
                    };

                    // Set company based on contact
                    if (deal.contactId) {
                        const contact = this.contacts.find(c => c.id === deal.contactId);
                        if (contact) {
                            deal.companyId = contact.companyId;
                        }
                    }

                    this.deals.push(deal);
                    this.showToast('success', 'Negocio creado', `"${deal.title}" agregado exitosamente`);
                }

                this.saveData();
                this.closeModal('dealModal');
                this.switchView(this.currentView);
                this.editingDealId = null;
            }

            handleContactSubmit(form) {
                const formData = new FormData(form);
                
                if (this.editingContactId) {
                    // Update existing contact
                    const contact = this.contacts.find(c => c.id === this.editingContactId);
                    if (contact) {
                        contact.firstName = formData.get('firstName');
                        contact.lastName = formData.get('lastName');
                        contact.email = formData.get('email');
                        contact.phone = formData.get('phone');
                        contact.companyId = formData.get('companyId') ? parseInt(formData.get('companyId')) : null;
                        contact.score = parseInt(formData.get('score'));
                        contact.tags = formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [];

                        this.showToast('success', 'Contacto actualizado', `"${contact.firstName} ${contact.lastName}" actualizado exitosamente`);
                    }
                } else {
                    // Create new contact
                    const contact = {
                        id: Date.now(),
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        companyId: formData.get('companyId') ? parseInt(formData.get('companyId')) : null,
                        ownerId: this.currentUser.id,
                        score: parseInt(formData.get('score')),
                        tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [],
                        createdAt: new Date().toISOString()
                    };

                    this.contacts.push(contact);
                    this.showToast('success', 'Contacto creado', `"${contact.firstName} ${contact.lastName}" agregado exitosamente`);
                }

                this.saveData();
                this.closeModal('contactModal');
                this.switchView(this.currentView);
                this.populateDropdowns();
                this.editingContactId = null;
            }

            handleCompanySubmit(form) {
                const formData = new FormData(form);
                
                if (this.editingCompanyId) {
                    // Update existing company
                    const company = this.companies.find(c => c.id === this.editingCompanyId);
                    if (company) {
                        company.name = formData.get('name');
                        company.industry = formData.get('industry');
                        company.size = formData.get('size');
                        company.website = formData.get('website');
                        company.revenue = formData.get('revenue') ? parseFloat(formData.get('revenue')) : 0;
                        company.location = formData.get('location');

                        this.showToast('success', 'Empresa actualizada', `"${company.name}" actualizada exitosamente`);
                    }
                } else {
                    // Create new company
                    const company = {
                        id: Date.now(),
                        name: formData.get('name'),
                        industry: formData.get('industry'),
                        size: formData.get('size'),
                        website: formData.get('website'),
                        revenue: formData.get('revenue') ? parseFloat(formData.get('revenue')) : 0,
                        location: formData.get('location')
                    };

                    this.companies.push(company);
                    this.showToast('success', 'Empresa creada', `"${company.name}" agregada exitosamente`);
                }

                this.saveData();
                this.closeModal('companyModal');
                this.switchView(this.currentView);
                this.populateDropdowns();
                this.editingCompanyId = null;
            }

            editDeal(dealId) {
                const deal = this.deals.find(d => d.id === dealId);
                if (!deal) return;

                this.openModal('dealModal');
                document.getElementById('dealModalTitle').textContent = 'Editar Negocio';
                document.getElementById('dealDeleteBtn').classList.remove('hidden');
                
                const form = document.getElementById('dealForm');
                form.querySelector('[name="title"]').value = deal.title;
                form.querySelector('[name="amount"]').value = deal.amount;
                form.querySelector('[name="currency"]').value = deal.currency;
                form.querySelector('[name="stage"]').value = deal.stage;
                form.querySelector('[name="probability"]').value = deal.probability;
                form.querySelector('[name="closeDate"]').value = deal.closeDate;
                form.querySelector('[name="contactId"]').value = deal.contactId || '';
                form.querySelector('[name="notes"]').value = deal.notes || '';

                this.editingDealId = dealId;
            }

            editContact(contactId) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (!contact) return;

                this.openModal('contactModal');
                document.getElementById('contactModalTitle').textContent = 'Editar Contacto';
                const historyBtn = document.getElementById('contactHistoryBtn');
                historyBtn.classList.remove('hidden');
                historyBtn.onclick = () => this.showContactHistory(contactId);
                
                document.getElementById('contactDeleteBtn').classList.remove('hidden');
                
                const form = document.getElementById('contactForm');
                form.querySelector('[name="firstName"]').value = contact.firstName;
                form.querySelector('[name="lastName"]').value = contact.lastName;
                form.querySelector('[name="email"]').value = contact.email;
                form.querySelector('[name="phone"]').value = contact.phone || '';
                form.querySelector('[name="companyId"]').value = contact.companyId || '';
                form.querySelector('[name="score"]').value = contact.score;
                form.querySelector('[name="tags"]').value = contact.tags ? contact.tags.join(', ') : '';

                this.editingContactId = contactId;
            }

            editCompany(companyId) {
                const company = this.companies.find(c => c.id === companyId);
                if (!company) return;

                this.openModal('companyModal');
                document.getElementById('companyModalTitle').textContent = 'Editar Empresa';
                document.getElementById('companyDeleteBtn').classList.remove('hidden');
                
                const form = document.getElementById('companyForm');
                form.querySelector('[name="name"]').value = company.name;
                form.querySelector('[name="industry"]').value = company.industry;
                form.querySelector('[name="size"]').value = company.size;
                form.querySelector('[name="website"]').value = company.website || '';
                form.querySelector('[name="revenue"]').value = company.revenue || '';
                form.querySelector('[name="location"]').value = company.location || '';

                this.editingCompanyId = companyId;
            }

            deleteDeal(dealId) {
                if (!confirm('¿Estás seguro de que quieres eliminar este negocio?')) return;

                const deal = this.deals.find(d => d.id === dealId);
                const dealTitle = deal ? deal.title : 'Negocio';
                
                this.deals = this.deals.filter(d => d.id !== dealId);
                this.saveData();
                this.showToast('success', 'Negocio eliminado', `"${dealTitle}" ha sido eliminado exitosamente`);
                
                this.closeModal('dealModal');
                this.switchView(this.currentView);
            }
            
            deleteContact(contactId) {
                if (!confirm('¿Estás seguro de que quieres eliminar este contacto?')) return;

                const contact = this.contacts.find(c => c.id === contactId);
                const contactName = contact ? `${contact.firstName} ${contact.lastName}`: 'Contacto';

                // Remove contact
                this.contacts = this.contacts.filter(c => c.id !== contactId);

                // Update deals that were associated with this contact
                this.deals.forEach(deal => {
                    if (deal.contactId === contactId) {
                        deal.contactId = null;
                    }
                });

                this.saveData();
                this.showToast('success', 'Contacto Eliminado', `"${contactName}" ha sido eliminado.`);
                
                this.closeModal('contactModal');
                this.switchView(this.currentView);
                this.populateDropdowns();
            }

            deleteCompany(companyId) {
                if (!confirm('¿Estás seguro de que quieres eliminar esta empresa? Se desvincularán los contactos asociados.')) return;
                
                const company = this.companies.find(c => c.id === companyId);
                const companyName = company ? company.name : 'Empresa';

                // Remove company
                this.companies = this.companies.filter(c => c.id !== companyId);

                // Update contacts that were associated with this company
                this.contacts.forEach(contact => {
                    if (contact.companyId === companyId) {
                        contact.companyId = null;
                    }
                });

                this.saveData();
                this.showToast('success', 'Empresa Eliminada', `"${companyName}" ha sido eliminada.`);
                
                this.closeModal('companyModal');
                this.switchView(this.currentView);
                this.populateDropdowns();
            }
            
            showContactHistory(contactId) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (!contact) return;

                const historyModalTitle = document.getElementById('historyModalTitle');
                const historyModalBody = document.getElementById('historyModalBody');
                
                historyModalTitle.textContent = `Historial de ${contact.firstName} ${contact.lastName}`;

                const associatedDeals = this.deals.filter(deal => deal.contactId === contactId);

                let dealsHtml = '<h4>Negocios Asociados</h4>';
                if (associatedDeals.length > 0) {
                    dealsHtml += '<ul>';
                    associatedDeals.forEach(deal => {
                        const stage = this.pipelineStages.find(s => s.id === deal.stage);
                        dealsHtml += `<li><strong>${deal.title}</strong> - ${this.formatCurrency(deal.amount, deal.currency)} (${stage.name})</li>`;
                    });
                    dealsHtml += '</ul>';
                } else {
                    dealsHtml += '<p>No hay negocios asociados a este contacto.</p>';
                }

                historyModalBody.innerHTML = `
                    <p><strong>Correo:</strong> ${contact.email}</p>
                    <p><strong>Teléfono:</strong> ${contact.phone || 'N/A'}</p>
                    <hr>
                    ${dealsHtml}
                `;

                this.openModal('historyModal');
            }


            // UI helper functions
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    if(modal.querySelector('form')){
                      this.resetForm(modal.querySelector('form').id);
                    }
                    // Hide delete buttons by default
                    modal.querySelectorAll('.btn--danger, .btn--secondary').forEach(btn => btn.classList.add('hidden'));

                    if (modalId === 'dealModal') {
                        document.getElementById('dealModalTitle').textContent = 'Agregar Negocio';
                        this.editingDealId = null;
                    } else if (modalId === 'contactModal') {
                        document.getElementById('contactModalTitle').textContent = 'Agregar Contacto';
                        this.editingContactId = null;
                    } else if (modalId === 'companyModal') {
                        document.getElementById('companyModalTitle').textContent = 'Agregar Empresa';
                        this.editingCompanyId = null;
                    }

                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                }
            }

            resetForm(formId) {
                const form = document.getElementById(formId);
                if (form) {
                    form.reset();
                }
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('collapsed');
                    this.sidebarCollapsed = !this.sidebarCollapsed;
                }
            }

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                const html = document.documentElement;
                const themeToggle = document.getElementById('themeToggle');
                
                if (this.isDarkMode) {
                    html.setAttribute('data-color-scheme', 'dark');
                    if (themeToggle) {
                        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    }
                } else {
                    html.setAttribute('data-color-scheme', 'light');
                    if (themeToggle) {
                        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                    }
                }
            }

            showToast(type, title, message) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const iconMap = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    info: 'fas fa-info-circle'
                };

                toast.innerHTML = `
                    <i class="toast-icon ${iconMap[type]}"></i>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                const container = document.getElementById('toastContainer');
                if (container) {
                    container.appendChild(toast);
                }

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 5000);

                // Manual close
                const closeBtn = toast.querySelector('.toast-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    });
                }
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.crm = new CRMApp();
        });
    </script>
</body>
</html>
