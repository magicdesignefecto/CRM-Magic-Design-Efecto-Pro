<!DOCTYPE html>
<html lang="es" data-color-scheme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Autenticaci√≥n CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
      /* * INICIO: ESTILOS CSS COMPLETOS
       * (Incluye variables :root, modo claro/oscuro, layout, componentes y estilos de login)
       */
       
      :root {
       /* Primitive Color Tokens */
       --color-white: rgba(255, 255, 255, 1);
       --color-black: rgba(0, 0, 0, 1);
       --color-cream-50: rgba(252, 252, 249, 1);
       --color-cream-100: rgba(255, 255, 253, 1);
       --color-gray-200: rgba(245, 245, 245, 1);
       --color-gray-300: rgba(167, 169, 169, 1);
       --color-gray-400: rgba(119, 124, 124, 1);
       --color-slate-500: rgba(98, 108, 113, 1);
       --color-brown-600: rgba(94, 82, 64, 1);
       --color-charcoal-700: rgba(31, 33, 33, 1);
       --color-charcoal-800: rgba(38, 40, 40, 1);
       --color-slate-900: rgba(19, 52, 59, 1);
       --color-teal-300: rgba(50, 184, 198, 1);
       --color-teal-400: rgba(45, 166, 178, 1);
       --color-teal-500: rgba(29, 111, 182, 1);
       --color-teal-600: rgba(26, 98, 161, 1);
       --color-teal-700: rgba(23, 86, 140, 1);
       --color-teal-800: rgba(41, 150, 161, 1);
       --color-red-400: rgba(255, 84, 89, 1);
       --color-red-500: rgba(192, 21, 47, 1);
       --color-orange-400: rgba(230, 129, 97, 1);
       --color-orange-500: rgba(168, 75, 47, 1);
       --color-blue-400: rgba(59, 130, 246, 1);
       --color-blue-500: rgba(37, 99, 235, 1);
       --color-blue-600: rgba(29, 78, 216, 1);
       --color-green-500: rgba(34, 197, 94, 1);
       --color-green-400: rgba(52, 211, 153, 1);

       /* RGB versions */
       --color-brown-600-rgb: 94, 82, 64;
       --color-teal-500-rgb: 29, 111, 182;
       --color-slate-900-rgb: 19, 52, 59;
       --color-slate-500-rgb: 98, 108, 113;
       --color-red-500-rgb: 192, 21, 47;
       --color-red-400-rgb: 255, 84, 89;
       --color-orange-500-rgb: 168, 75, 47;
       --color-orange-400-rgb: 230, 129, 97;
       --color-blue-400-rgb: 59, 130, 246;
       --color-green-500-rgb: 34, 197, 94;
       --color-green-400-rgb: 52, 211, 153;

       /* Background color tokens (Light Mode) */
       --color-bg-1: rgba(59, 130, 246, 0.08); 
       --color-bg-2: rgba(245, 158, 11, 0.08); 
       --color-bg-3: rgba(34, 197, 94, 0.08);
       --color-bg-4: rgba(239, 68, 68, 0.08);
       --color-bg-5: rgba(147, 51, 234, 0.08);
       --color-bg-6: rgba(249, 115, 22, 0.08);
       --color-bg-7: rgba(236, 72, 153, 0.08);
       --color-bg-8: rgba(6, 182, 212, 0.08); 

       /* Semantic Color Tokens (Light Mode) */
       --color-background: var(--color-cream-50);
       --color-surface: var(--color-cream-100);
       --color-text: var(--color-slate-900);
       --color-text-secondary: var(--color-slate-500);
       --color-primary: var(--color-teal-500);
       --color-primary-hover: var(--color-teal-600);
       --color-primary-active: var(--color-teal-700);
       --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
       --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
       --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
       --color-border: rgba(var(--color-brown-600-rgb), 0.2);
       --color-btn-primary-text: var(--color-cream-50);
       --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
       --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
       --color-error: var(--color-red-500);
       --color-success: var(--color-green-500);
       --color-warning: var(--color-orange-500);
       --color-info: var(--color-slate-500);
       --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
       --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
       --color-success-rgb: var(--color-green-500-rgb);

       /* Common style patterns */
       --focus-ring: 0 0 0 3px var(--color-focus-ring);
       --focus-outline: 2px solid var(--color-primary);
       --status-bg-opacity: 0.15;
       --status-border-opacity: 0.25;
       --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
       --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

       /* RGB versions for opacity control */
       --color-error-rgb: 192, 21, 47;
       --color-warning-rgb: 168, 75, 47;
       --color-info-rgb: 98, 108, 113;

       /* Typography */
       --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
         BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
       --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
         Monaco, Consolas, monospace;
       --font-size-xs: 11px;
       --font-size-sm: 12px;
       --font-size-base: 14px;
       --font-size-md: 14px;
       --font-size-lg: 16px;
       --font-size-xl: 18px;
       --font-size-2xl: 20px;
       --font-size-3xl: 24px;
       --font-size-4xl: 30px;
       --font-weight-normal: 400;
       --font-weight-medium: 500;
       --font-weight-semibold: 550;
       --font-weight-bold: 600;
       --line-height-tight: 1.2;
       --line-height-normal: 1.5;
       --letter-spacing-tight: -0.01em;

       /* Spacing */
       --space-0: 0;
       --space-1: 1px;
       --space-2: 2px;
       --space-4: 4px;
       --space-6: 6px;
       --space-8: 8px;
       --space-10: 10px;
       --space-12: 12px;
       --space-16: 16px;
       --space-20: 20px;
       --space-24: 24px;
       --space-32: 32px;

       /* Border Radius */
       --radius-sm: 6px;
       --radius-base: 8px;
       --radius-md: 10px;
       --radius-lg: 12px;
       --radius-full: 9999px;

       /* Shadows */
       --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
       --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
       --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
         0 2px 4px -1px rgba(0, 0, 0, 0.02);
       --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
         0 4px 6px -2px rgba(0, 0, 0, 0.02);
       --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
         inset 0 -1px 0 rgba(0, 0, 0, 0.03);

       /* Animation */
       --duration-fast: 150ms;
       --duration-normal: 250ms;
       --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

       /* Layout */
       --container-sm: 640px;
       --container-md: 768px;
       --container-lg: 1024px;
       --container-xl: 1280px;
      }

      /* Dark mode colors */
      @media (prefers-color-scheme: dark) {
       :root {
         /* RGB versions (Dark Mode) */
         --color-gray-400-rgb: 119, 124, 124;
         --color-gray-300-rgb: 167, 169, 169;
         --color-gray-200-rgb: 245, 245, 245;
         --color-blue-400-rgb: 59, 130, 246;
         --color-green-400-rgb: 52, 211, 153;

         /* Background color tokens (Dark Mode) */
         --color-bg-1: rgba(29, 78, 216, 0.15); 
         --color-bg-2: rgba(180, 83, 9, 0.15); 
         --color-bg-3: rgba(21, 128, 61, 0.15); 
         --color-bg-4: rgba(185, 28, 28, 0.15);
         --color-bg-5: rgba(107, 33, 168, 0.15);
         --color-bg-6: rgba(194, 65, 12, 0.15);
         --color-bg-7: rgba(190, 24, 93, 0.15);
         --color-bg-8: rgba(8, 145, 178, 0.15);

         /* Semantic Color Tokens (Dark Mode) */
         --color-background: var(--color-charcoal-700);
         --color-surface: var(--color-charcoal-800);
         --color-text: var(--color-gray-200);
         --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
         --color-primary: var(--color-blue-400);
         --color-primary-hover: var(--color-blue-500);
         --color-primary-active: var(--color-blue-600);
         --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
         --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
         --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
         --color-border: rgba(var(--color-gray-400-rgb), 0.3);
         --color-error: var(--color-red-400);
         --color-success: var(--color-green-400);
         --color-warning: var(--color-orange-400);
         --color-info: var(--color-gray-300);
         --color-focus-ring: rgba(var(--color-blue-400-rgb), 0.4);
         --color-btn-primary-text: var(--color-slate-900);
         --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
         --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
         --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
           inset 0 -1px 0 rgba(0, 0, 0, 0.15);
         --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
         --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
         --color-success-rgb: var(--color-green-400-rgb);

         /* RGB versions (Dark Mode) */
         --color-error-rgb: var(--color-red-400-rgb);
         --color-warning-rgb: var(--color-orange-400-rgb);
         --color-info-rgb: var(--color-gray-300-rgb);
       }
      }

      /* Data attribute for manual theme switching */
      [data-color-scheme="dark"] {
       --color-gray-400-rgb: 119, 124, 124;
       --color-gray-300-rgb: 167, 169, 169;
       --color-gray-200-rgb: 245, 245, 245;
       --color-blue-400-rgb: 59, 130, 246;
       --color-green-400-rgb: 52, 211, 153;
       --color-bg-1: rgba(29, 78, 216, 0.15);
       --color-bg-2: rgba(180, 83, 9, 0.15);
       --color-bg-3: rgba(21, 128, 61, 0.15);
       --color-bg-4: rgba(185, 28, 28, 0.15);
       --color-bg-5: rgba(107, 33, 168, 0.15);
       --color-bg-6: rgba(194, 65, 12, 0.15);
       --color-bg-7: rgba(190, 24, 93, 0.15);
       --color-bg-8: rgba(8, 145, 178, 0.15);
       --color-background: var(--color-charcoal-700);
       --color-surface: var(--color-charcoal-800);
       --color-text: var(--color-gray-200);
       --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
       --color-primary: var(--color-blue-400);
       --color-primary-hover: var(--color-blue-500);
       --color-primary-active: var(--color-blue-600);
       --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
       --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
       --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
       --color-border: rgba(var(--color-gray-400-rgb), 0.3);
       --color-error: var(--color-red-400);
       --color-success: var(--color-green-400);
       --color-warning: var(--color-orange-400);
       --color-info: var(--color-gray-300);
       --color-focus-ring: rgba(var(--color-blue-400-rgb), 0.4);
       --color-btn-primary-text: var(--color-cream-50);
       --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
       --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
       --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
         inset 0 -1px 0 rgba(0, 0, 0, 0.15);
       --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
       --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
       --color-success-rgb: var(--color-green-400-rgb);
       --color-error-rgb: var(--color-red-400-rgb);
       --color-warning-rgb: var(--color-orange-400-rgb);
       --color-info-rgb: var(--color-gray-300-rgb);
      }

      [data-color-scheme="light"] {
       --color-brown-600-rgb: 94, 82, 64;
       --color-teal-500-rgb: 33, 128, 141;
       --color-slate-900-rgb: 19, 52, 59;
       --color-background: var(--color-cream-50);
       --color-surface: var(--color-cream-100);
       --color-text: var(--color-slate-900);
       --color-text-secondary: var(--color-slate-500);
       --color-primary: var(--color-teal-500);
       --color-primary-hover: var(--color-teal-600);
       --color-primary-active: var(--color-teal-700);
       --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
       --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
       --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
       --color-border: rgba(var(--color-brown-600-rgb), 0.2);
       --color-btn-primary-text: var(--color-cream-50);
       --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
       --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
       --color-error: var(--color-red-500);
       --color-success: var(--color-green-500);
       --color-warning: var(--color-orange-500);
       --color-info: var(--color-slate-500);
       --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
       --color-success-rgb: var(--color-green-500-rgb);
       --color-error-rgb: var(--color-red-500-rgb);
       --color-warning-rgb: var(--color-orange-500-rgb);
       --color-info-rgb: var(--color-slate-500-rgb);
      }

      /* Base <html> style (del CRM) */
      html {
       font-size: var(--font-size-base);
       font-family: var(--font-family-base);
       line-height: var(--line-height-normal);
       color: var(--color-text);
       background-color: var(--color-background);
       -webkit-font-smoothing: antialiased;
       box-sizing: border-box;
      }

      /* Base <body> (necesario para resetear) */
      body {
       margin: 0;
       padding: 0;
       font-family: var(--font-family-base); /* Coherencia de fuente */
      }

      *,
      *::before,
      *::after {
       box-sizing: inherit;
      }

      /*
       * INICIO: L√ìGICA DE CONTENEDORES DE INTEGRACI√ìN
       * Aqu√≠ resolvemos el conflicto de layout.
       */

      /* Estilos del <body> del CRM aplicados a #crmWrapper */
      #crmWrapper {
         margin: 0;
         background-color: var(--color-background);
         color: var(--color-text);
         display: flex; /* <-- CR√çTICO para layout sidebar+main */
         min-height: 100vh;
         overflow-x: hidden;
      }

      /* Estilos del <body> del Login aplicados a #authWrapper */
      #authWrapper {
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
         background-color: #f0f2f5;
         display: flex; /* <-- CR√çTICO para centrar el form */
         justify-content: center;
         align-items: center;
         min-height: 100vh;
         width: 100%;
         margin: 0;
         padding: 1rem;
         box-sizing: border-box;
      }
      
      /*
       * FIN: L√ìGICA DE CONTENEDORES DE INTEGRACI√ìN
       */


      /* Typography (CRM) */
      h1, h2, h3, h4, h5, h6 {
       margin: 0;
       font-weight: var(--font-weight-semibold);
       line-height: var(--line-height-tight);
       color: var(--color-text);
       letter-spacing: var(--letter-spacing-tight);
      }
      h1 { font-size: var(--font-size-4xl); }
      h2 { font-size: var(--font-size-3xl); }
      h3 { font-size: var(--font-size-2xl); }
      h4 { font-size: var(--font-size-xl); }
      h5 { font-size: var(--font-size-lg); }
      h6 { font-size: var(--font-size-md); }
      p { margin: 0 0 var(--space-16) 0; }
      a {
       color: var(--color-primary);
       text-decoration: none;
       transition: color var(--duration-fast) var(--ease-standard);
      }
      a:hover { color: var(--color-primary-hover); }
      code, pre {
       font-family: var(--font-family-mono);
       font-size: calc(var(--font-size-base) * 0.95);
       background-color: var(--color-secondary);
       border-radius: var(--radius-sm);
      }
      code { padding: var(--space-1) var(--space-4); }
      pre {
       padding: var(--space-16);
       margin: var(--space-16) 0;
       overflow: auto;
       border: 1px solid var(--color-border);
      }
      pre code { background: none; padding: 0; }

      /* Buttons (CRM) */
      .btn {
       display: inline-flex;
       align-items: center;
       justify-content: center;
       padding: var(--space-8) var(--space-16);
       border-radius: var(--radius-base);
       font-size: var(--font-size-base);
       font-weight: 500;
       line-height: 1.5;
       cursor: pointer;
       transition: all var(--duration-normal) var(--ease-standard);
       border: none;
       text-decoration: none;
       position: relative;
      }
      .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
      .btn--primary {
       background: var(--color-primary);
       color: var(--color-btn-primary-text);
      }
      .btn--primary:hover { background: var(--color-primary-hover); }
      .btn--primary:active { background: var(--color-primary-active); }
      .btn--secondary {
       background: var(--color-secondary);
       color: var(--color-text);
      }
      .btn--secondary:hover { background: var(--color-secondary-hover); }
      .btn--secondary:active { background: var(--color-secondary-active); }
      .btn--outline {
       background: transparent;
       border: 1px solid var(--color-border);
       color: var(--color-text);
      }
      .btn--danger {
         background-color: var(--color-error);
         color: white;
      }
      .btn--danger:hover { background-color: rgba(var(--color-red-500-rgb), 0.8); }
      .btn--outline:hover { background: var(--color-secondary); }
      .btn--sm {
       padding: var(--space-4) var(--space-12);
       font-size: var(--font-size-sm);
       border-radius: var(--radius-sm);
      }
      .btn--lg {
       padding: var(--space-10) var(--space-20);
       font-size: var(--font-size-lg);
       border-radius: var(--radius-md);
      }
      .btn--full-width { width: 100%; }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }

      /* Form elements (CRM) */
      .form-control {
       display: block;
       width: 100%;
       padding: var(--space-8) var(--space-12);
       font-size: var(--font-size-md);
       line-height: 1.5;
       color: var(--color-text);
       background-color: var(--color-surface);
       border: 1px solid var(--color-border);
       border-radius: var(--radius-base);
       transition: border-color var(--duration-fast) var(--ease-standard),
         box-shadow var(--duration-fast) var(--ease-standard);
      }
      textarea.form-control {
       font-family: var(--font-family-base);
       font-size: var(--font-size-base);
      }
      select.form-control {
       padding: var(--space-8) var(--space-12);
       -webkit-appearance: none;
       -moz-appearance: none;
       appearance: none;
       background-image: var(--select-caret-light);
       background-repeat: no-repeat;
       background-position: right var(--space-12) center;
       background-size: 16px;
       padding-right: var(--space-32);
      }
      @media (prefers-color-scheme: dark) {
       select.form-control { background-image: var(--select-caret-dark); }
      }
      [data-color-scheme="dark"] select.form-control { background-image: var(--select-caret-dark); }
      [data-color-scheme="light"] select.form-control { background-image: var(--select-caret-light); }
      .form-control:focus {
       border-color: var(--color-primary);
       outline: var(--focus-outline);
      }
      .form-label {
       display: block;
       margin-bottom: var(--space-8);
       font-weight: var(--font-weight-medium);
       font-size: var(--font-size-sm);
      }
      .form-group { margin-bottom: var(--space-16); }

      /* Card component (CRM) */
      .card {
       background-color: var(--color-surface);
       border-radius: var(--radius-lg);
       border: 1px solid var(--color-card-border);
       box-shadow: var(--shadow-sm);
       overflow: hidden;
       transition: box-shadow var(--duration-normal) var(--ease-standard);
      }
      .card:hover { box-shadow: var(--shadow-md); }
      .card__body { padding: var(--space-16); }
      .card__header,
      .card__footer {
       padding: var(--space-16);
       border-bottom: 1px solid var(--color-card-border-inner);
      }

      /* Status indicators (CRM) */
      .status {
       display: inline-flex;
       align-items: center;
       padding: var(--space-6) var(--space-12);
       border-radius: var(--radius-full);
       font-weight: var(--font-weight-medium);
       font-size: var(--font-size-sm);
      }
      .status--success {
       background-color: rgba(var(--color-success-rgb), var(--status-bg-opacity));
       color: var(--color-success);
       border: 1px solid rgba(var(--color-success-rgb), var(--status-border-opacity));
      }
      .status--error {
       background-color: rgba(var(--color-error-rgb), var(--status-bg-opacity));
       color: var(--color-error);
       border: 1px solid rgba(var(--color-error-rgb), var(--status-border-opacity));
      }
      .status--warning {
       background-color: rgba(var(--color-warning-rgb), var(--status-bg-opacity));
       color: var(--color-warning);
       border: 1px solid rgba(var(--color-warning-rgb), var(--status-border-opacity));
      }
      .status--info {
       background-color: rgba(var(--color-info-rgb), var(--status-bg-opacity));
       color: var(--color-info);
       border: 1px solid rgba(var(--color-info-rgb), var(--status-border-opacity));
      }

      /* Container layout (CRM) */
      .container {
       width: 100%;
       margin-right: auto;
       margin-left: auto;
       padding-right: var(--space-16);
       padding-left: var(--space-16);
      }
      @media (min-width: 640px) { .container { max-width: var(--container-sm); } }
      @media (min-width: 768px) { .container { max-width: var(--container-md); } }
      @media (min-width: 1024px) { .container { max-width: var(--container-lg); } }
      @media (min-width: 1280px) { .container { max-width: var(--container-xl); } }

      /* Utility classes (CRM) */
      .flex { display: flex; }
      .flex-col { flex-direction: column; }
      .items-center { align-items: center; }
      .justify-center { justify-content: center; }
      .justify-between { justify-content: space-between; }
      .gap-4 { gap: var(--space-4); }
      .gap-8 { gap: var(--space-8); }
      .gap-16 { gap: var(--space-16); }
      .m-0 { margin: 0; }
      .mt-8 { margin-top: var(--space-8); }
      .mb-8 { margin-bottom: var(--space-8); }
      .mx-8 { margin-left: var(--space-8); margin-right: var(--space-8); }
      .my-8 { margin-top: var(--space-8); margin-bottom: var(--space-8); }
      .p-0 { padding: 0; }
      .py-8 { padding-top: var(--space-8); padding-bottom: var(--space-8); }
      .px-8 { padding-left: var(--space-8); padding-right: var(--space-8); }
      .py-16 { padding-top: var(--space-16); padding-bottom: var(--space-16); }
      .px-16 { padding-left: var(--space-16); padding-right: var(--space-16); }
      .block { display: block; }
      
      /* .hidden debe ser espec√≠fico para que funcione */
      .hidden { display: none !important; }

      /* Accessibility (CRM) */
      .sr-only {
       position: absolute;
       width: 1px;
       height: 1px;
       padding: 0;
       margin: -1px;
       overflow: hidden;
       clip: rect(0, 0, 0, 0);
       white-space: nowrap;
       border-width: 0;
      }
      :focus-visible {
       outline: var(--focus-outline);
       outline-offset: 2px;
      }

      /* Dark mode specifics (CRM) */
      [data-color-scheme="dark"] .btn--outline {
       border: 1px solid var(--color-border-secondary);
      }
      @font-face {
       font-family: 'FKGroteskNeue';
       src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
         format('woff2');
      }

      /* Sidebar Styles (CRM) */
      .sidebar {
         width: 280px;
         background-color: var(--color-surface);
         border-right: 1px solid var(--color-border);
         display: flex;
         flex-direction: column;
         transition: width var(--duration-normal) var(--ease-standard);
         position: fixed;
         left: 0;
         top: 0;
         height: 100vh;
         z-index: 1000;
      }
      .sidebar.collapsed { width: 70px; }
      .sidebar-header {
         padding: var(--space-20);
         border-bottom: 1px solid var(--color-border);
         display: flex;
         align-items: center;
         justify-content: space-between;
      }
      .logo {
         display: flex;
         align-items: center;
         gap: var(--space-12);
         font-weight: var(--font-weight-bold);
         font-size: var(--font-size-xl);
         color: var(--color-primary);
      }
      .sidebar.collapsed .logo-text { display: none; }
      .sidebar-toggle {
         background: none;
         border: none;
         color: var(--color-text-secondary);
         cursor: pointer;
         padding: var(--space-8);
         border-radius: var(--radius-base);
         transition: background-color var(--duration-fast) var(--ease-standard);
      }
      .sidebar-toggle:hover { background-color: var(--color-secondary); }
      .sidebar-menu {
         flex-grow: 1;
         overflow-y: auto;
         padding: var(--space-16);
      }
      .sidebar-menu ul {
         list-style: none;
         padding: 0;
         margin: 0;
         display: flex;
         flex-direction: column;
         gap: var(--space-4);
      }
      .menu-item {
         display: flex;
         align-items: center;
         gap: var(--space-12);
         padding: var(--space-12) var(--space-16);
         border-radius: var(--radius-base);
         text-decoration: none;
         color: var(--color-text-secondary);
         transition: all var(--duration-fast) var(--ease-standard);
         font-weight: var(--font-weight-medium);
      }
      .menu-item:hover {
         background-color: var(--color-secondary);
         color: var(--color-text);
      }
      .menu-item.active {
         background-color: var(--color-primary);
         color: var(--color-btn-primary-text);
      }
      .menu-item i { width: 20px; text-align: center; }
      .sidebar.collapsed .menu-item span { display: none; }
      
      /* Sidebar Footer (Perfil y Logout) */
      .sidebar-footer {
         display: flex;
         align-items: center;
         justify-content: space-between;
         padding: var(--space-16);
         border-top: 1px solid var(--color-border);
      }
      .user-profile {
         display: flex;
         align-items: center;
         gap: var(--space-12);
         flex-grow: 1; 
         min-width: 0; 
      }
      .user-avatar {
         width: 40px;
         height: 40px;
         border-radius: var(--radius-full);
         background-color: var(--color-primary);
         color: var(--color-btn-primary-text);
         display: flex;
         align-items: center;
         justify-content: center;
         font-weight: var(--font-weight-bold);
         font-size: var(--font-size-sm);
         flex-shrink: 0; 
      }
      .user-info { 
         display: flex; 
         flex-direction: column; 
         white-space: nowrap;
         overflow: hidden;
         text-overflow: ellipsis;
      }
      .user-name {
         font-weight: var(--font-weight-medium);
         font-size: var(--font-size-sm);
      }
      .user-role {
         font-size: var(--font-size-xs);
         color: var(--color-text-secondary);
      }
      .sidebar.collapsed .user-info { display: none; }
      
      .btn-logout {
         background: none;
         border: none;
         color: var(--color-text-secondary);
         font-size: var(--font-size-lg);
         cursor: pointer;
         padding: var(--space-8);
         border-radius: var(--radius-base);
         transition: all var(--duration-fast) var(--ease-standard);
         flex-shrink: 0; 
         margin-left: var(--space-8);
      }
      .btn-logout:hover {
         background-color: var(--color-secondary);
         color: var(--color-text);
      }

      .sidebar.collapsed .sidebar-footer {
         flex-direction: column;
         align-items: center;
         gap: var(--space-12);
      }
      .sidebar.collapsed .user-profile {
         flex-grow: 0;
      }
      .sidebar.collapsed .btn-logout {
         margin: 0;
         width: 100%;
      }

      /* Main Content Styles (CRM) */
      .main-content {
         flex: 1;
         margin-left: 280px;
         transition: margin-left var(--duration-normal) var(--ease-standard);
         display: flex;
         flex-direction: column;
         overflow-x: hidden;
         max-width: 100%;
      }
      .sidebar.collapsed + .main-content { margin-left: 70px; }

      /* Header Styles (CRM) */
      .header {
         background-color: var(--color-surface);
         border-bottom: 1px solid var(--color-border);
         padding: var(--space-16) var(--space-24);
         display: flex;
         justify-content: space-between;
         align-items: center;
         position: sticky;
         top: 0;
         z-index: 100;
      }
      .header-left h1 {
         margin: 0 0 var(--space-4) 0;
         font-size: var(--font-size-3xl);
         font-weight: var(--font-weight-bold);
      }
      .breadcrumb {
         display: flex;
         align-items: center;
         gap: var(--space-8);
         font-size: var(--font-size-sm);
         color: var(--color-text-secondary);
      }
      .header-right {
         display: flex;
         align-items: center;
         gap: var(--space-16);
      }
      .search-box { position: relative; }
      .search-box input {
         padding: var(--space-8) var(--space-12) var(--space-8) var(--space-32);
         border: 1px solid var(--color-border);
         border-radius: var(--radius-base);
         background-color: var(--color-background);
         color: var(--color-text);
         font-size: var(--font-size-sm);
         width: 250px;
      }
      .search-box i {
         position: absolute;
         left: var(--space-12);
         top: 50%;
         transform: translateY(-50%);
         color: var(--color-text-secondary);
      }
      .theme-toggle {
         background: none;
         border: 1px solid var(--color-border);
         border-radius: var(--radius-base);
         padding: var(--space-8);
         cursor: pointer;
         color: var(--color-text-secondary);
         transition: all var(--duration-fast) var(--ease-standard);
      }
      .theme-toggle:hover {
         background-color: var(--color-secondary);
         color: var(--color-text);
      }

      /* Views (CRM) */
      .view {
         flex: 1;
         padding: var(--space-24);
         display: none;
      }
      .view.active { display: block; }

      /* Metrics Cards (CRM) */
      .metrics-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
         gap: var(--space-20);
         margin-bottom: var(--space-32);
      }
      .metric-card {
         background-color: var(--color-surface);
         border: 1px solid var(--color-card-border);
         border-radius: var(--radius-lg);
         padding: var(--space-20);
         display: flex;
         align-items: center;
         gap: var(--space-16);
         transition: box-shadow var(--duration-normal) var(--ease-standard);
      }
      .metric-card:hover { box-shadow: var(--shadow-md); }
      .metric-icon {
         width: 60px;
         height: 60px;
         border-radius: var(--radius-lg);
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: var(--font-size-xl);
         color: white;
      }
      .metric-icon.sales { background: linear-gradient(135deg, var(--color-teal-500), var(--color-teal-600)); }
      .metric-icon.deals { background: linear-gradient(135deg, #3B82F6, #2563EB); }
      .metric-icon.contacts { background: linear-gradient(135deg, #10B981, #059669); }
      .metric-icon.conversion { background: linear-gradient(135deg, #F59E0B, #D97706); }
      .metric-content h3 {
         font-size: var(--font-size-3xl);
         font-weight: var(--font-weight-bold);
         margin: 0 0 var(--space-4) 0;
      }
      .metric-content p {
         color: var(--color-text-secondary);
         margin: 0 0 var(--space-8) 0;
         font-size: var(--font-size-sm);
      }
      .metric-change {
         font-size: var(--font-size-sm);
         font-weight: var(--font-weight-medium);
         padding: var(--space-2) var(--space-8);
         border-radius: var(--radius-full);
      }
      .metric-change.positive {
         background-color: rgba(var(--color-success-rgb), 0.1);
         color: var(--color-success);
      }
      .metric-change.negative {
         background-color: rgba(var(--color-error-rgb), 0.1);
         color: var(--color-error);
      }

      /* Dashboard Grid (CRM) */
      .dashboard-grid {
         display: grid;
         grid-template-columns: 2fr 1fr;
         gap: var(--space-24);
      }
      .chart-card { height: 400px; }
      .chart-container { width: 100%; height: 100%; }
      .activity-feed {
         display: flex;
         flex-direction: column;
         gap: var(--space-16);
         max-height: 300px;
         overflow-y: auto;
      }
      .activity-item {
         display: flex;
         gap: var(--space-12);
         padding: var(--space-12);
         border-radius: var(--radius-base);
         background-color: var(--color-background);
      }
      .activity-avatar {
         width: 32px;
         height: 32px;
         border-radius: var(--radius-full);
         background-color: var(--color-primary);
         color: var(--color-btn-primary-text);
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: var(--font-size-xs);
         font-weight: var(--font-weight-bold);
         flex-shrink: 0;
      }
      .activity-content { flex: 1; }
      .activity-text {
         font-size: var(--font-size-sm);
         margin: 0 0 var(--space-4) 0;
      }
      .activity-time {
         font-size: var(--font-size-xs);
         color: var(--color-text-secondary);
      }

      /* Pipeline Board (CRM) */
      .pipeline-header { margin-bottom: var(--space-24); }
      .pipeline-filters {
         display: flex;
         gap: var(--space-16);
         align-items: center;
      }
      .pipeline-filters .form-control {
         width: auto;
         min-width: 200px;
      }
      .pipeline-board {
         display: flex;
         gap: var(--space-20);
         overflow-x: auto;
         padding-bottom: var(--space-16);
      }
      .pipeline-column {
         min-width: 300px;
         background-color: var(--color-surface);
         border-radius: var(--radius-lg);
         border: 1px solid var(--color-card-border);
         flex-shrink: 0;
      }
      .pipeline-column-header {
         padding: var(--space-16);
         border-bottom: 1px solid var(--color-card-border-inner);
         display: flex;
         justify-content: space-between;
         align-items: center;
      }
      .column-title {
         font-weight: var(--font-weight-semibold);
         display: flex;
         align-items: center;
         gap: var(--space-8);
      }
      .column-indicator {
         width: 12px;
         height: 12px;
         border-radius: var(--radius-full);
      }
      .column-count {
         background-color: var(--color-secondary);
         color: var(--color-text);
         border-radius: var(--radius-full);
         padding: var(--space-2) var(--space-8);
         font-size: var(--font-size-xs);
         font-weight: var(--font-weight-medium);
      }
      .pipeline-column-body {
         padding: var(--space-16);
         min-height: 400px;
         display: flex;
         flex-direction: column;
         gap: var(--space-12);
      }
      .deal-card {
         background-color: var(--color-background);
         border: 1px solid var(--color-card-border);
         border-radius: var(--radius-base);
         padding: var(--space-16);
         cursor: move;
         transition: all var(--duration-fast) var(--ease-standard);
      }
      .deal-card:hover {
         box-shadow: var(--shadow-md);
         transform: translateY(-2px);
      }
      .deal-card.dragging { opacity: 0.5; transform: rotate(5deg); }
      .deal-title {
         font-weight: var(--font-weight-semibold);
         margin: 0 0 var(--space-8) 0;
         font-size: var(--font-size-base);
      }
      .deal-amount {
         font-size: var(--font-size-lg);
         font-weight: var(--font-weight-bold);
         color: var(--color-primary);
         margin: 0 0 var(--space-8) 0;
      }
      .deal-meta {
         display: flex;
         justify-content: space-between;
         align-items: center;
         font-size: var(--font-size-sm);
         color: var(--color-text-secondary);
      }
      .deal-contact {
         display: flex;
         align-items: center;
         gap: var(--space-6);
      }
      .deal-probability {
         background-color: var(--color-secondary);
         padding: var(--space-2) var(--space-6);
         border-radius: var(--radius-base);
         font-size: var(--font-size-xs);
      }

      /* Contacts/Companies/Deals Grids (CRM) */
      .view-header { margin-bottom: var(--space-24); }
      .view-filters {
         display: flex;
         gap: var(--space-16);
         align-items: center;
      }
      .view-filters .form-control {
         width: auto;
         min-width: 200px;
      }
      .contacts-grid,
      .companies-grid {
         display: grid;
         grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
         gap: var(--space-20);
      }
      .contact-card,
      .company-card {
         background-color: var(--color-surface);
         border: 1px solid var(--color-card-border);
         border-radius: var(--radius-lg);
         padding: var(--space-20);
         transition: all var(--duration-normal) var(--ease-standard);
         cursor: pointer;
      }
      .contact-card:hover,
      .company-card:hover {
         box-shadow: var(--shadow-md);
         transform: translateY(-2px);
      }
      .contact-header,
      .company-header {
         display: flex;
         align-items: center;
         gap: var(--space-12);
         margin-bottom: var(--space-16);
      }
      .contact-avatar,
      .company-avatar {
         width: 50px;
         height: 50px;
         border-radius: var(--radius-full);
         background-color: var(--color-primary);
         color: var(--color-btn-primary-text);
         display: flex;
         align-items: center;
         justify-content: center;
         font-weight: var(--font-weight-bold);
         font-size: var(--font-size-lg);
      }
      .contact-info h3,
      .company-info h3 {
         margin: 0 0 var(--space-4) 0;
         font-size: var(--font-size-lg);
         font-weight: var(--font-weight-semibold);
      }
      .contact-email,
      .company-industry {
         color: var(--color-text-secondary);
         font-size: var(--font-size-sm);
      }
      .contact-details,
      .company-details {
         display: flex;
         flex-direction: column;
         gap: var(--space-8);
      }
      .contact-detail,
      .company-detail {
         display: flex;
         justify-content: space-between;
         align-items: center;
         font-size: var(--font-size-sm);
      }
      .contact-tags {
         display: flex;
         flex-wrap: wrap;
         gap: var(--space-6);
         margin-top: var(--space-12);
      }
      .tag {
         background-color: var(--color-secondary);
         color: var(--color-text);
         padding: var(--space-2) var(--space-8);
         border-radius: var(--radius-full);
         font-size: var(--font-size-xs);
         font-weight: var(--font-weight-medium);
      }

      /* Deals Table (CRM) */
      .deals-table-container {
         background-color: var(--color-surface);
         border-radius: var(--radius-lg);
         border: 1px solid var(--color-card-border);
         overflow: hidden;
      }
      .deals-table {
         width: 100%;
         border-collapse: collapse;
      }
      .deals-table th {
         background-color: var(--color-background);
         padding: var(--space-16);
         text-align: left;
         font-weight: var(--font-weight-semibold);
         font-size: var(--font-size-sm);
         color: var(--color-text-secondary);
         border-bottom: 1px solid var(--color-card-border-inner);
      }
      .deals-table td {
         padding: var(--space-16);
         border-bottom: 1px solid var(--color-card-border-inner);
         font-size: var(--font-size-sm);
      }
      .deals-table tbody tr:hover { background-color: var(--color-background); }
      .stage-badge {
         display: inline-flex;
         align-items: center;
         gap: var(--space-6);
         padding: var(--space-4) var(--space-8);
         border-radius: var(--radius-base);
         font-size: var(--font-size-xs);
         font-weight: var(--font-weight-medium);
      }
      .stage-indicator {
         width: 8px;
         height: 8px;
         border-radius: var(--radius-full);
      }
      .probability-bar {
         width: 60px;
         height: 6px;
         background-color: var(--color-secondary);
         border-radius: var(--radius-full);
         overflow: hidden;
      }
      .probability-fill {
         height: 100%;
         background-color: var(--color-primary);
         border-radius: var(--radius-full);
         transition: width var(--duration-normal) var(--ease-standard);
      }
      .deal-actions { display: flex; gap: var(--space-8); }
      .btn-icon {
         background: none;
         border: none;
         color: var(--color-text-secondary);
         padding: var(--space-4);
         border-radius: var(--radius-sm);
         cursor: pointer;
         transition: all var(--duration-fast) var(--ease-standard);
      }
      .btn-icon:hover {
         background-color: var(--color-secondary);
         color: var(--color-text);
      }

      /* Modal Styles (CRM) */
      .modal {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         z-index: 10000;
         display: flex;
         align-items: center;
         justify-content: center;
      }
      /* .modal.hidden se maneja con .hidden */
      .modal-overlay {
         position: absolute;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.5);
         backdrop-filter: blur(4px);
      }
      .modal-content {
         background-color: var(--color-surface);
         border-radius: var(--radius-lg);
         box-shadow: var(--shadow-lg);
         max-width: 500px;
         width: 90%;
         max-height: 90vh;
         overflow-y: auto;
         position: relative;
         z-index: 1;
      }
      .modal-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         padding: var(--space-20);
         border-bottom: 1px solid var(--color-card-border-inner);
      }
      .modal-header h2 {
         margin: 0;
         font-size: var(--font-size-2xl);
         font-weight: var(--font-weight-semibold);
      }
      .modal-close {
         background: none;
         border: none;
         color: var(--color-text-secondary);
         font-size: var(--font-size-lg);
         padding: var(--space-8);
         border-radius: var(--radius-base);
         cursor: pointer;
         transition: all var(--duration-fast) var(--ease-standard);
      }
      .modal-close:hover {
         background-color: var(--color-secondary);
         color: var(--color-text);
      }
      .modal-body { padding: var(--space-20); }
      .modal-footer {
         display: flex;
         gap: var(--space-12);
         justify-content: flex-end;
         padding: var(--space-20);
         border-top: 1px solid var(--color-card-border-inner);
      }
      .form-row {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: var(--space-16);
      }

      /* Toast Notifications (CRM) */
      .toast-container {
         position: fixed;
         top: var(--space-20);
         right: var(--space-20);
         z-index: 10001;
         display: flex;
         flex-direction: column;
         gap: var(--space-8);
      }
      .toast {
         background-color: var(--color-surface);
         border: 1px solid var(--color-card-border);
         border-radius: var(--radius-base);
         padding: var(--space-12) var(--space-16);
         box-shadow: var(--shadow-md);
         display: flex;
         align-items: center;
         gap: var(--space-12);
         min-width: 300px;
         animation: slideInRight var(--duration-normal) var(--ease-standard);
      }
      .toast.success { border-left: 4px solid var(--color-success); }
      .toast.error { border-left: 4px solid var(--color-error); }
      .toast.info { border-left: 4px solid var(--color-info); }
      .toast-icon { font-size: var(--font-size-lg); }
      .toast.success .toast-icon { color: var(--color-success); }
      .toast.error .toast-icon { color: var(--color-error); }
      .toast.info .toast-icon { color: var(--color-info); }
      .toast-content { flex: 1; }
      .toast-title {
         font-weight: var(--font-weight-semibold);
         margin: 0 0 var(--space-2) 0;
         font-size: var(--font-size-sm);
      }
      .toast-message {
         margin: 0;
         font-size: var(--font-size-xs);
         color: var(--color-text-secondary);
      }
      .toast-close {
         background: none;
         border: none;
         color: var(--color-text-secondary);
         cursor: pointer;
         padding: var(--space-2);
      }
      @keyframes slideInRight {
         from { transform: translateX(100%); opacity: 0; }
         to { transform: translateX(0); opacity: 1; }
      }

      /* Drag and Drop (CRM) */
      .pipeline-column.drag-over {
         border: 2px dashed var(--color-primary);
         background-color: rgba(var(--color-teal-500-rgb), 0.05);
      }
      .deal-card.placeholder {
         border: 2px dashed var(--color-border);
         background-color: transparent;
         height: 100px;
         display: flex;
         align-items: center;
         justify-content: center;
         color: var(--color-text-secondary);
         font-style: italic;
      }

      /* Responsive Design (CRM) */
      @media (max-width: 1024px) {
         .dashboard-grid {
             grid-template-columns: 1fr;
             gap: var(--space-24);
         }
         .chart-card { height: 350px; }
      }
      @media (max-width: 768px) {
         .sidebar { width: 70px; }
         .sidebar .menu-item span { display: none; }
         
         /* --- INICIO DE LA CORRECCI√ìN --- */
         /* Ocultamos el texto del logo y la info de usuario en la vista m√≥vil (70px) */
         /* para que coincida con el estado colapsado. */
         .sidebar .logo-text { display: none; }
         .sidebar .user-info { display: none; }
         /* --- FIN DE LA CORRECCI√ìN --- */
         
         .main-content { margin-left: 70px; }
         .header {
             padding: var(--space-12) var(--space-16);
             flex-direction: column;
             gap: var(--space-12);
             align-items: stretch;
         }
         .header-left { width: 100%; text-align: center; }
         .breadcrumb { justify-content: center; }
         .header-right {
             width: 100%;
             justify-content: space-between;
         }
         .search-box { flex-grow: 1; }
         .search-box input { width: 100%; }
         #addNewBtn span { display: none; }
         #addNewBtn { padding: var(--space-8) var(--space-12); }
         .metrics-grid { grid-template-columns: 1fr; }
         .pipeline-board {
             flex-direction: column;
             overflow-x: hidden;
             gap: var(--space-16);
         }
         .pipeline-column { min-width: 100%; }
         .contacts-grid,
         .companies-grid { grid-template-columns: 1fr; }
         .form-row { grid-template-columns: 1fr; }
         .modal-content {
             margin: var(--space-16);
             width: calc(100% - 32px);
         }
         .view-filters,
         .pipeline-filters {
             flex-direction: column;
             align-items: stretch;
         }
         .view-filters .form-control,
         .pipeline-filters .form-control {
             width: 100%;
             min-width: unset;
         }
         .deals-table-container { overflow-x: hidden; }
         .deals-table { border: none; }
         .deals-table thead { display: none; }
         .deals-table tr {
             display: block;
             margin-bottom: var(--space-16);
             border: 1px solid var(--color-border);
             border-radius: var(--radius-base);
             padding: var(--space-8);
         }
         .deals-table td {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: var(--space-8) 0;
             border-bottom: 1px solid var(--color-border);
             text-align: right;
         }
         .deals-table td:last-child { border-bottom: none; }
         .deals-table td::before {
             content: attr(data-label);
             font-weight: var(--font-weight-medium);
             text-align: left;
             padding-right: var(--space-16);
         }
         .deals-table td .deal-actions { justify-content: flex-end; }
      }
      @media (max-width: 480px) {
         .view { padding: var(--space-16); }
         .metrics-grid { gap: var(--space-12); }
         .metric-card { padding: var(--space-16); }
         .pipeline-column { min-width: 100%; }
      }

      /* Loading States (CRM) */
      .loading {
         display: flex;
         align-items: center;
         justify-content: center;
         padding: var(--space-32);
      }
      .spinner {
         width: 32px;
         height: 32px;
         border: 3px solid var(--color-secondary);
         border-top: 3px solid var(--color-primary);
         border-radius: var(--radius-full);
         animation: spin 1s linear infinite;
      }
      @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
      }

      /* Empty States (CRM) */
      .empty-state {
         text-align: center;
         padding: var(--space-32);
         color: var(--color-text-secondary);
      }
      .empty-state i {
         font-size: var(--font-size-4xl);
         margin-bottom: var(--space-16);
         opacity: 0.5;
      }
      .empty-state h3 {
         margin: 0 0 var(--space-8) 0;
         font-size: var(--font-size-xl);
         color: var(--color-text);
      }
      .empty-state p {
         margin: 0;
         font-size: var(--font-size-base);
      }
      /* FIN: Estilos del CRM */


      /* INICIO: Estilos del Login (login.html) */
      
      /* Contenedor principal del formulario (Login) */
      .form-container {
         width: 100%;
         max-width: 400px;
         border-radius: 0.75rem;
         background-color: #ffffff;
         padding: 2rem;
         color: #1c1e21;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
         box-sizing: border-box;
         transition: all 0.3s ease;
      }

      /* Estilo para el logo (Login) */
      .form-logo {
         display: block;
         margin: 0 auto 1.5rem auto;
         height: 70px;
         width: auto;
      }

      /* T√≠tulo principal (Login) */
      #authWrapper .title {
         text-align: center;
         font-size: 1.5rem;
         line-height: 2rem;
         font-weight: 600;
         margin-bottom: 1.5rem;
      }
      
      /* Subt√≠tulo (Login) */
      #authWrapper .subtitle {
         text-align: center;
         color: #606770;
         margin-bottom: 1.5rem;
         font-size: 0.95rem;
         margin-top: 0; /* Reseteo */
      }
      
      #authWrapper .form { margin-top: 1rem; }
      
      #authWrapper .input-group { margin-bottom: 1.25rem; }

      #authWrapper .input-group label {
         display: block;
         color: #333333;
         margin-bottom: 8px;
         font-weight: 500;
      }

      /* Estilo de input espec√≠fico para el login */
      #authWrapper .input-group input {
         width: 100%;
         border-radius: 0.375rem;
         border: 1px solid #dddfe2;
         outline: 0;
         background-color: #ffffff;
         padding: 0.85rem 1rem;
         color: #1c1e21;
         box-sizing: border-box;
         font-size: 1rem;
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      /* Espacio para el icono de ver/ocultar contrase√±a */
      #login-password {
         padding-right: 3rem; 
      }

      #authWrapper .input-group input::placeholder { color: #90949c; }

      #authWrapper .input-group input:focus {
         border-color: #1877f2;
         box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
      }

      /* Validador de contrase√±a (Login) */
      #password-requirements {
         font-size: 0.8rem;
         margin-top: 0.5rem;
         color: #606770;
         line-height: 1.4;
      }
      #password-requirements span { transition: color 0.3s ease; }
      .invalid { color: #fa383e; }
      .valid { color: #00a400; }
      
      /* Bot√≥n .sign (Login) */
      .sign {
         display: block;
         width: 100%;
         background-color: #1c2b4c;
         padding: 0.85rem;
         text-align: center;
         color: #ffffff;
         border: none;
         border-radius: 0.375rem;
         font-weight: 600;
         font-size: 1.05rem;
         cursor: pointer;
         transition: background-color 0.2s ease-in-out;
         margin-top: 1.5rem;
      }
      .sign:hover { background-color: #2a3f6d; }
      .sign:disabled { background-color: #a0aec0; cursor: not-allowed; }
      
      #authWrapper .actions {
         text-align: center;
         font-size: 0.9rem;
         line-height: 1rem;
         color: #606770;
         margin-top: 1.5rem;
      }
      #authWrapper .actions a {
         color: #1877f2;
         text-decoration: none;
         font-weight: 500;
         cursor: pointer;
      }
      #authWrapper .actions a:hover { text-decoration: underline; }
      #authWrapper .actions p { margin-bottom: 0.5rem; }
      
      /* Mensajes de error/√©xito (Login) */
      .message {
         text-align: center;
         padding: 1rem;
         margin-bottom: 1rem;
         border-radius: 0.375rem;
         font-size: 0.95rem;
      }
      .message-error {
         background-color: #f8d7da;
         color: #721c24;
         border: 1px solid #f5c6cb;
      }
      .message-success {
         background-color: #d4edda;
         color: #155724;
         border: 1px solid #c3e6cb;
      }

      #register-success-view { cursor: pointer; }

      @media (min-width: 768px) {
         .form-container {
             max-width: 440px;
             padding: 2.5rem;
         }
         #authWrapper .title { font-size: 1.75rem; }
      }
      /* FIN: Estilos del Login */
    </style>
</head>
<body>

    <div id="authWrapper">
        <div class="form-container">

            <div id="login-view">
                <img src="https://cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">Iniciar Sesi√≥n</p>
                <div id="login-message" class="message hidden"></div>
                <form class="form" id="login-form">
                    <div class="input-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" name="email" placeholder="Tu email" required>
                    </div>

                    <div class="input-group">
                        <label for="login-password">Contrase√±a</label>
                        <div style="position: relative;">
                            <input type="password" id="login-password" name="password" placeholder="Tu contrase√±a" required>
                            <i class="fas fa-eye" id="toggle-password" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; color: #606770;"></i>
                        </div>
                    </div>
                    <button type="submit" class="sign">Iniciar Sesi√≥n</button>
                </form>
                <div class="actions">
                    <p><a id="show-forgot-password-link">¬øOlvidaste tu contrase√±a?</a></p>
                    <p>¬øNo tienes una cuenta? <a id="show-register-link">Reg√≠strate</a></p>
                </div>
            </div>

            <div id="register-view" class="hidden">
                 <img src="https://cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">Estudio de Estrategia Digital</p>
                <div id="register-message" class="message hidden"></div>
                <form class="form" id="register-form">
                     <div class="input-group">
                         <label for="nombre">Nombre</label>
                         <input type="text" id="nombre" name="nombre" placeholder="Tu nombre" required>
                    </div>
                     <div class="input-group">
                         <label for="apellido">Apellido</label>
                         <input type="text" id="apellido" name="apellido" placeholder="Tu apellido" required>
                    </div>
                     <div class="input-group">
                         <label for="cargo">Cargo</label>
                         <input type="text" id="cargo" name="cargo" placeholder="Ej: CEO, Gerente de Ventas">
                    </div>
                     <div class="input-group">
                         <label for="register-email">Email</label>
                         <input type="email" id="register-email" name="email" placeholder="Tu email" required>
                    </div>
                     <div class="input-group">
                         <label for="register-password">Contrase√±a</label>
                         <input type="password" id="register-password" name="password" placeholder="Crea una contrase√±a" required>
                          <p id="password-requirements">
                             La contrase√±a debe tener al menos 
                             <span id="length" class="invalid">8 caracteres,</span> 
                             <span id="uppercase" class="invalid">una may√∫scula,</span> 
                             <span id="lowercase" class="invalid">una min√∫scula,</span> 
                             <span id="number" class="invalid">un n√∫mero</span> y 
                             <span id="special" class="invalid">un s√≠mbolo.</span>
                         </p>
                    </div>
                    <button type="submit" class="sign">Registrarse</button>
                </form>
                <div class="actions">
                    <p>¬øYa tienes una cuenta? <a class="show-login-link">Inicia Sesi√≥n</a></p>
                </div>
            </div>

            <div id="forgot-password-view" class="hidden">
                 <img src="https://cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">Recuperar Contrase√±a</p>
                <p class="subtitle">Ingresa tu email para recibir un enlace de recuperaci√≥n.</p>
                <div id="forgot-message" class="message hidden"></div>
                <form class="form" id="forgot-form">
                    <div class="input-group">
                        <label for="forgot-email">Email</label>
                        <input type="email" id="forgot-email" name="email" placeholder="Tu email" required>
                    </div>
                    <button type="submit" class="sign">Enviar Enlace</button>
                </form>
                <div class="actions">
                    <p><a class="show-login-link">Volver a Inicio de Sesi√≥n</a></p>
                </div>
            </div>
            
            <div id="login-welcome-view" class="hidden">
                <img src="https.cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">¬°Bienvenido!</p>
                <p class="subtitle" id="welcome-message">Has iniciado sesi√≥n correctamente.</p>
                <p style="text-align:center;">Cargando CRM...</p>
            </div>
            
            <div id="register-success-view" class="hidden">
                <img src="https.cdn.jsdelivr.net/gh/magicdesignefecto/Magic-Design-Efecto-Servicios-Gestion-de-Redes-Sociales/logo%20svg%20magic%20design%20efecto.svg" alt="Logo Magic Design" class="form-logo">
                <p class="title">¬°Registro Exitoso!</p>
                <p class="subtitle">Tu cuenta est√° pendiente de aprobaci√≥n por un administrador.</p>
                <p style="text-align:center; font-size: 0.8rem; color: #606770;">(Haz clic en este cuadro para volver o espera 5 segundos)</p>
            </div>
        </div>
    </div>  
    <div id="crmWrapper" style="display: none;">
         
         <nav class="sidebar" id="sidebar">
              <div class="sidebar-header">
                 <div class="logo">
                     <i class="fas fa-chart-line"></i>
                     <span class="logo-text">CRM Pro</span>
                 </div>
                 <button class="sidebar-toggle" id="sidebarToggle">
                     <i class="fas fa-bars"></i>
                 </button>
             </div>
             <div class="sidebar-menu">
                 <ul>
                     <li><a href="#" class="menu-item active" data-view="dashboard"><i class="fas fa-chart-pie"></i><span>Tablero</span></a></li>
                     <li><a href="#" class="menu-item" data-view="pipeline"><i class="fas fa-columns"></i><span>Embudo de Ventas</span></a></li>
                     <li><a href="#" class="menu-item" data-view="contacts"><i class="fas fa-users"></i><span>Contactos</span></a></li>
                     <li><a href="#" class="menu-item" data-view="companies"><i class="fas fa-building"></i><span>Empresas</span></a></li>
                     <li><a href="#" class="menu-item" data-view="deals"><i class="fas fa-handshake"></i><span>Negocios</span></a></li>
                 </ul>
             </div>

             <div class="sidebar-footer">
                 <div class="user-profile">
                     <div class="user-avatar">...</div>
                     <div class="user-info">
                         <span class="user-name">Cargando...</span>
                         <span class="user-role">...</span>
                     </div>
                 </div>
                 <button class="btn-logout" id="logoutButton" title="Cerrar Sesi√≥n">
                     <i class="fas fa-sign-out-alt"></i>
                 </button>
             </div>
          </nav>

        <main class="main-content" id="mainContent">
           
            <header class="header">
                 <div class="header-left">
                     <h1 class="page-title" id="pageTitle">Tablero</h1>
                     <div class="breadcrumb">
                         <span>CRM</span> <i class="fas fa-chevron-right"></i> <span id="breadcrumbCurrent">Tablero</span>
                     </div>
                 </div>
                 <div class="header-right">
                     <div class="search-box">
                         <input type="text" placeholder="Buscar..." id="globalSearch"><i class="fas fa-search"></i>
                     </div>
                     <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
                     <button class="btn btn--primary" id="addNewBtn"><i class="fas fa-plus"></i><span>Agregar</span></button>
                 </div>
            </header>

            <div class="view active" id="dashboard-view">
                 <div class="metrics-grid">
                     <div class="metric-card"><div class="metric-icon sales"><i class="fas fa-dollar-sign"></i></div><div class="metric-content"><h3 id="totalRevenue">$0</h3><p>Ingresos Totales</p></div></div>
                     <div class="metric-card"><div class="metric-icon deals"><i class="fas fa-handshake"></i></div><div class="metric-content"><h3 id="activeDeals">0</h3><p>Negocios Activos</p></div></div>
                     <div class="metric-card"><div class="metric-icon contacts"><i class="fas fa-users"></i></div><div class="metric-content"><h3 id="totalContacts">0</h3><p>Contactos</p></div></div>
                     <div class="metric-card"><div class="metric-icon conversion"><i class="fas fa-chart-line"></i></div><div class="metric-content"><h3 id="conversionRate">0%</h3><p>Tasa de Conversi√≥n</p></div></div>
                 </div>
                 <div class="dashboard-grid">
                     <div class="card chart-card"><div class="card__header"><h3>Embudo por Etapa</h3></div><div class="card__body"><div class="chart-container" style="position: relative; height: 300px;"><canvas id="pipelineChart"></canvas></div></div></div>
                     <div class="card chart-card"><div class="card__header"><h3>Actividad Reciente</h3></div><div class="card__body"><div class="activity-feed" id="activityFeed"><div class="loading"><div class="spinner"></div></div></div></div></div>
                 </div>
            </div>

            <div class="view" id="pipeline-view">
                 <div class="pipeline-header"><div class="pipeline-filters"><select id="ownerFilter" class="form-control"><option value="">Todos los propietarios</option></select><input type="text" placeholder="Buscar negocios..." id="pipelineSearch" class="form-control"></div></div>
                 <div class="pipeline-board" id="pipelineBoard"><div class="loading"><div class="spinner"></div></div></div>
            </div>

            <div class="view" id="contacts-view">
                 <div class="view-header"><div class="view-filters"><input type="text" placeholder="Buscar contactos..." id="contactsSearch" class="form-control"><select id="contactsCompanyFilter" class="form-control"><option value="">Todas las empresas</option></select></div></div>
                 <div class="contacts-grid" id="contactsGrid"><div class="loading"><div class="spinner"></div></div></div>
            </div>

            <div class="view" id="companies-view">
                 <div class="view-header"><div class="view-filters"><input type="text" placeholder="Buscar empresas..." id="companiesSearch" class="form-control"><select id="companiesIndustryFilter" class="form-control"><option value="">Todas las industrias</option></select></div></div>
                 <div class="companies-grid" id="companiesGrid"><div class="loading"><div class="spinner"></div></div></div>
            </div>

            <div class="view" id="deals-view">
                 <div class="view-header"><div class="view-filters"><input type="text" placeholder="Buscar negocios..." id="dealsSearch" class="form-control"><select id="dealsStageFilter" class="form-control"><option value="">Todas las etapas</option></select></div></div>
                 <div class="deals-table-container">
                     <table class="deals-table" id="dealsTable">
                         <thead>
                             <tr><th>T√≠tulo</th><th>Monto</th><th>Etapa</th><th>Probabilidad</th><th>Fecha Cierre</th><th>Contacto</th><th>Acciones</th></tr>
                         </thead>
                         
                         <tbody id="dealsTableBody">
                             <tr id="deals-loading-row">
                                 <td colspan="7" class="loading">
                                     <div class="spinner"></div>
                                 </td>
                             </tr>
                         </tbody>
                         </table>
                 </div>
            </div>
        </main>
        <div class="modal hidden" id="dealModal">
            <div class="modal-overlay" id="dealModalOverlay"></div>
            <div class="modal-content">
                <div class="modal-header"><h2 id="dealModalTitle">Agregar Negocio</h2><button class="modal-close" id="dealModalClose"><i class="fas fa-times"></i></button></div>
                <div class="modal-body">
                    <form id="dealForm">
                         <div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" name="title" class="form-control" required></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Monto</label><input type="number" name="amount" class="form-control" required></div><div class="form-group"><label class="form-label">Moneda</label><select name="currency" class="form-control"><option value="USD">$us</option><option value="BOB">BOB</option></select></div></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Etapa</label><select name="stage" class="form-control" required></select></div><div class="form-group"><label class="form-label">Probabilidad (%)</label><input type="number" name="probability" class="form-control" min="0" max="100"></div></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Contacto</label><select name="contactId" class="form-control"><option value="">Seleccionar contacto</option></select></div><div class="form-group"><label class="form-label">Fecha de Cierre</label><input type="date" name="closeDate" class="form-control"></div></div>
                         <div class="form-group"><label class="form-label">Notas</label><textarea name="notes" class="form-control" rows="3"></textarea></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-danger hidden" id="dealDeleteBtn">Eliminar</button><button type="button" class="btn btn--outline" id="dealCancelBtn">Cancelar</button><button type="submit" form="dealForm" class="btn btn--primary">Guardar</button></div>
            </div>
        </div>

        <div class="modal hidden" id="contactModal">
             <div class="modal-overlay" id="contactModalOverlay"></div>
            <div class="modal-content">
                 <div class="modal-header"><h2 id="contactModalTitle">Agregar Contacto</h2><button class="modal-close" id="contactModalClose"><i class="fas fa-times"></i></button></div>
                <div class="modal-body">
                    <form id="contactForm">
                         <div class="form-row"><div class="form-group"><label class="form-label">Nombre</label><input type="text" name="firstName" class="form-control" required></div><div class="form-group"><label class="form-label">Apellido</label><input type="text" name="lastName" class="form-control" required></div></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Correo Electr√≥nico</label><input type="email" name="email" class="form-control" required></div><div class="form-group"><label class="form-label">Tel√©fono</label><input type="tel" name="phone" class="form-control"></div></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Empresa</label><select name="companyId" class="form-control"><option value="">Seleccionar empresa</option></select></div><div class="form-group"><label class="form-label">Puntuaci√≥n</label><input type="number" name="score" class="form-control" min="0" max="100" value="50"></div></div>
                         <div class="form-group"><label class="form-label">Etiquetas (separadas por comas)</label><input type="text" name="tags" class="form-control" placeholder="ej: Tomador de decisiones, Gerente de TI"></div>
                    </form>
                </div>
                 <div class="modal-footer"><button type="button" class="btn btn--secondary hidden" id="contactHistoryBtn" style="margin-right: auto;">Ver Historial</button><button type="button" class="btn btn--danger hidden" id="contactDeleteBtn" style="margin-right: 10px;">Eliminar</button><button type="button" class="btn btn--outline" id="contactCancelBtn">Cancelar</button><button type="submit" form="contactForm" class="btn btn--primary">Guardar</button></div>
            </div>
        </div>

        <div class="modal hidden" id="companyModal">
            <div class="modal-overlay" id="companyModalOverlay"></div>
            <div class="modal-content">
                <div class="modal-header"><h2 id="companyModalTitle">Agregar Empresa</h2><button class="modal-close" id="companyModalClose"><i class="fas fa-times"></i></button></div>
                <div class="modal-body">
                    <form id="companyForm">
                         <div class="form-group"><label class="form-label">Nombre de la Empresa</label><input type="text" name="name" class="form-control" required></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Industria</label><input type="text" name="industry" class="form-control" required></div><div class="form-group"><label class="form-label">Tama√±o</label><select name="size" class="form-control" required><option value="">Seleccionar tama√±o</option><option value="1-10">1-10</option><option value="10-50">10-50</option><option value="50-200">50-200</option><option value="200-500">200-500</option><option value="500+">500+</option></select></div></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Sitio Web</label><input type="url" name="website" class="form-control"></div><div class="form-group"><label class="form-label">Ingresos Anuales</label><input type="number" name="revenue" class="form-control"></div></div>
                         <div class="form-group"><label class="form-label">Ubicaci√≥n</label><input type="text" name="location" class="form-control"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn--danger hidden" id="companyDeleteBtn" style="margin-right: auto;">Eliminar</button><button type="button" class="btn btn--outline" id="companyCancelBtn">Cancelar</button><button type="submit" form="companyForm" class="btn btn--primary">Guardar</button></div>
            </div>
        </div>

        <div class="modal hidden" id="historyModal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header"><h2 id="historyModalTitle">Historial</h2><button class="modal-close"><i class="fas fa-times"></i></button></div>
                <div class="modal-body" id="historyModalBody"></div>
                <div class="modal-footer"><button type="button" class="btn btn--outline" id="historyCancelBtn">Cerrar</button></div>
            </div>
        </div>

        <div class="toast-container" id="toastContainer"></div>
        
    </div> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        // [ SCRIPT DE FIREBASE ]
         import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
         import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
         
         // Importar todas las funciones de Firestore necesarias
         import { 
             getFirestore, 
             doc, 
             setDoc, 
             getDoc,
             collection,
             query,
             where,
             getDocs,
             addDoc,
             updateDoc,
             deleteDoc
         } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

         // Configuraci√≥n de Firebase (reemplazar con tus claves)
         const firebaseConfig = {
           apiKey: "AIzaSyAKCQv65xdkBjt4Fv9afKNBFxwUQXuYXqA",
           authDomain: "crm-2025-octubre-mde.firebaseapp.com",
           projectId: "crm-2025-octubre-mde",
           storageBucket: "crm-2025-octubre-mde.firebasestorage.app",
           messagingSenderId: "906917861641",
           appId: "1:906917861641:web:0b81a671d966ed10699bd8"
         };
         
         // Inicializar Firebase
         const app = initializeApp(firebaseConfig);
         const auth = getAuth(app);
         const db = getFirestore(app); // Instancia de Firestore

       // Crear un objeto con las funciones de Firestore para pasarlas a CRMApp
       const firestoreFunctions = {
           collection,
           query,
           where,
           getDocs,
           addDoc,
           updateDoc,
           deleteDoc,
           doc,
           setDoc, 
           getDoc
       };

         // Referencias a los elementos HTML principales
         const authWrapper = document.getElementById('authWrapper');
         const crmWrapper = document.getElementById('crmWrapper');
         const loginView = document.getElementById('login-view');
         const registerView = document.getElementById('register-view');
         const forgotPasswordView = document.getElementById('forgot-password-view');
         const loginWelcomeView = document.getElementById('login-welcome-view'); 
         const registerSuccessView = document.getElementById('register-success-view');

         // Links para cambiar entre vistas de autenticaci√≥n
         const showRegisterLink = document.getElementById('show-register-link');
         const showForgotPasswordLink = document.getElementById('show-forgot-password-link');
         const showLoginLinks = document.querySelectorAll('.show-login-link');
         
         // Funci√≥n para ocultar todas las vistas de autenticaci√≥n
         const hideAllViews = () => [loginView, registerView, forgotPasswordView, loginWelcomeView, registerSuccessView].forEach(v => v.classList.add('hidden'));

         // Funci√≥n para mostrar una vista espec√≠fica
         const showView = (view) => { hideAllViews(); view.classList.remove('hidden'); };
         
         // Listeners para los links de navegaci√≥n de autenticaci√≥n
         showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showView(registerView); });
         showForgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showView(forgotPasswordView); });
         showLoginLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showView(loginView); }));
         
         // L√≥gica para ver/ocultar contrase√±a en el login
         const togglePassword = document.getElementById('toggle-password');
         const passwordInput = document.getElementById('login-password');
         if (togglePassword && passwordInput) {
             togglePassword.addEventListener('click', function() {
                 const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                 passwordInput.setAttribute('type', type);
                 this.classList.toggle('fa-eye');
                 this.classList.toggle('fa-eye-slash');
             });
         }

         // L√≥gica de Logout (Cerrar Sesi√≥n)
         const logoutButton = document.getElementById('logoutButton');
         if (logoutButton) {
             logoutButton.addEventListener('click', async () => {
                 if (!confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                     return;
                 }
                 try {
                     await auth.signOut();
                     window.location.reload(); // Recarga la p√°gina para volver al login
                 } catch (error) {
                     console.error("Error al cerrar sesi√≥n:", error);
                     alert("No se pudo cerrar la sesi√≥n. Intenta de nuevo.");
                 }
             });
         }

         // Funci√≥n para mostrar mensajes de error/√©xito en los formularios de autenticaci√≥n
         const showMessage = (elementId, message, isError = true) => {
             const el = document.getElementById(elementId);
             el.textContent = message;
             el.classList.remove('hidden', 'message-error', 'message-success');
             el.classList.add(isError ? 'message-error' : 'message-success');
         };

         // Manejador del formulario de Registro
         document.getElementById('register-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const btn = e.target.querySelector('button'); btn.disabled = true; btn.textContent = 'Registrando...';
             const { nombre, apellido, cargo, email, password } = e.target.elements;
             try {
                 // 1. Crear usuario en Firebase Auth
                 const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
                 
                 // 2. Crear documento de usuario en Firestore
                 await firestoreFunctions.setDoc(firestoreFunctions.doc(db, "users", cred.user.uid), {
                     nombre: nombre.value, 
                     apellido: apellido.value, 
                     cargo: cargo.value, 
                     email: email.value, 
                     status: "pending" // Estado inicial
                 });
                 
                 e.target.reset(); 
                 showView(registerSuccessView); // Mostrar vista de √©xito
                 
                 // Volver al login despu√©s de 5 segundos
                 const timeout = setTimeout(() => showView(loginView), 5000);
                 registerSuccessView.addEventListener('click', () => { clearTimeout(timeout); showView(loginView); }, { once: true });
             
             } catch (error) {
                 showMessage('register-message', error.code === 'auth/email-already-in-use' ? "Email ya en uso." : "Error al registrar.");
             } finally { 
                 btn.disabled = false; btn.textContent = 'Registrarse'; 
             }
         });
         
         // Manejador del formulario de Login
         document.getElementById('login-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const btn = e.target.querySelector('button'); btn.disabled = true; btn.textContent = 'Iniciando...';
             const { email, password } = e.target.elements;
             try {
                 // 1. Iniciar sesi√≥n en Firebase Auth
                 const cred = await signInWithEmailAndPassword(auth, email.value, password.value);
                 
                 // 2. Obtener documento de usuario de Firestore
                 const userDoc = await firestoreFunctions.getDoc(firestoreFunctions.doc(db, "users", cred.user.uid));
                 
                 // 3. Verificar si el usuario existe y est√° aprobado
                 if (userDoc.exists() && userDoc.data().status === 'approved') {
                     const userData = userDoc.data(); 
                     userData.uid = cred.user.uid;
                     
                     console.log("Login exitoso, mostrando CRM...");
                     authWrapper.style.display = 'none'; // Ocultar login
                     crmWrapper.style.display = 'flex';  // Mostrar CRM
                     document.title = 'Dashboard CRM'; 
                     
                     console.log("Creando instancia CRMApp...");
                     
                     // 4. Crear instancia de la App CRM, pasando la data del usuario, la BD y las funciones
                     window.crm = new CRMApp(userData, db, firestoreFunctions);
                     
                     console.log("Renderizando vista inicial..."); 
                     // 5. Cargar datos de Firestore y renderizar el dashboard
                     window.crm.renderInitialView(); 
                     
                 } else {
                     // Si el status no es "approved"
                     await auth.signOut();
                     showMessage('login-message', 'Cuenta pendiente o denegada.');
                 }
             } catch (error) { 
                 console.error("Error en login:", error);
                 showMessage('login-message', 'Email o contrase√±a incorrectos.'); 
             } 
             finally { 
                 btn.disabled = false; btn.textContent = 'Iniciar Sesi√≥n'; 
             }
         });

         // Manejador de Olvidar Contrase√±a
         document.getElementById('forgot-form').addEventListener('submit', async (e) => {
              e.preventDefault();
             const btn = e.target.querySelector('button'); btn.disabled = true; btn.textContent = 'Enviando...';
             const { email } = e.target.elements;
             try {
                 await sendPasswordResetEmail(auth, email.value);
                 showMessage('forgot-message', 'Enlace enviado a tu correo.', false); 
                 e.target.reset();
             } catch (error) { 
                 showMessage('forgot-message', 'Error al enviar correo.'); 
             } 
             finally { 
                 btn.disabled = false; btn.textContent = 'Enviar Enlace'; 
             }
         });

         // Validador visual de contrase√±a en el registro
         const pwInput = document.getElementById('register-password');
         if (pwInput) pwInput.addEventListener('input', () => {
             const pw = pwInput.value;
             const req = (id, valid) => { 
                 const el=document.getElementById(id); 
                 el.classList.toggle('valid', valid); 
                 el.classList.toggle('invalid', !valid); 
             };
             req('length', pw.length >= 8); 
             req('uppercase', /[A-Z]/.test(pw)); 
             req('lowercase', /[a-z]/.test(pw)); 
             req('number', /[0-9]/.test(pw)); 
             req('special', /[^A-Za-z0-9]/.test(pw));
         });
    </script>
    <script>
        /**
         * Clase principal de la aplicaci√≥n CRM
         * Maneja toda la l√≥gica de negocio, estado y renderizado de la UI.
         */
        class CRMApp {
           
            // 1. CONSTRUCTOR: Se ejecuta al crear la instancia (despu√©s del login)
            constructor(userData, db, firestore) { 
                console.log("CRMApp constructor iniciado"); 
                this.currentView = 'dashboard'; // Vista inicial
               
                // Referencias a Firebase (pasadas desde el script m√≥dulo)
                this.db = db;
                this.firestore = firestore; // Objeto con { collection, query, doc, etc. }
               
                // Informaci√≥n del usuario logueado
                const user = userData || { nombre: 'Invitado', apellido: '', cargo: 'Usuario', email: '', uid: 'guest' };
                const lastName = user.apellido || '';
                this.currentUser = {
                    id: user.uid,
                    name: `${user.nombre} ${lastName}`.trim(),
                    role: user.cargo || 'Usuario',
                    avatar: `${user.nombre ? user.nombre[0] : ''}${lastName ? lastName[0] : ''}`.toUpperCase() || 'GU'
                };
               
                // --- Estado Local de la App ---
                this.isDarkMode = false;
                this.sidebarCollapsed = false;
               
                // IDs para edici√≥n (se guardan al abrir un modal de edici√≥n)
                this.editingDealId = null;
                this.editingContactId = null;
                this.editingCompanyId = null;

                // Arrays locales para almacenar los datos de Firestore (cach√© local)
                this.deals = [];
                this.contacts = [];
                this.companies = [];

                // Configuraci√≥n est√°tica de las etapas del embudo
                this.pipelineStages = [
                    { id: "lead", name: "Potencial", color: "#6B7280", defaultProbability: 10, order: 1 },
                    { id: "qualified", name: "Calificado", color: "#3B82F6", defaultProbability: 25, order: 2 },
                    { id: "proposal", name: "Propuesta", color: "#E68161", defaultProbability: 50, order: 3 },
                    { id: "negotiation", name: "Negociaci√≥n", color: "#F59E0B", defaultProbability: 75, order: 4 },
                    { id: "closed-won", name: "Ganado", color: "#1d6fb6", defaultProbability: 100, order: 5 },
                    { id: "closed-lost", name: "Perdido", color: "#EF4444", defaultProbability: 0, order: 6 }
                ];
               
                // Configura la UI b√°sica (perfil, tema, listeners)
                this.initUI(); 
                console.log("CRMApp constructor finalizado"); 
            }
           
            // 2. RENDER INICIAL: Carga datos y muestra la primera vista
            async renderInitialView() {
                console.log("Ejecutando renderInitialView..."); 
               
                try {
                    console.log("Cargando datos de Firestore...");
                    // 2a. Carga todos los datos de Firestore (deals, contacts, companies)
                    await this.initializeData(); 
                    console.log("Datos cargados exitosamente.");

                    // 2b. Llena los men√∫s desplegables (ej: <select> de contactos)
                    this.populateDropdowns(); 
                   
                    // 2c. Carga la vista inicial (Dashboard)
                    this.switchView(this.currentView); 
                } catch (error) {
                    console.error("Error fatal al inicializar CRM:", error);
                    this.showToast('error', 'Error de Carga', 'No se pudieron cargar los datos de Firestore.');
                }
            }

            // 3. LECTOR DE DATOS: Lee datos de Firestore y los guarda localmente
            async initializeData() {
               
                // 3a. Crear queries seguras (filtran por ownerId del usuario actual)
                const qDeals = this.firestore.query(
                    this.firestore.collection(this.db, "deals"), 
                    this.firestore.where("ownerId", "==", this.currentUser.id)
                );
                const qContacts = this.firestore.query(
                    this.firestore.collection(this.db, "contacts"), 
                    this.firestore.where("ownerId", "==", this.currentUser.id)
                );
                const qCompanies = this.firestore.query(
                    this.firestore.collection(this.db, "companies"),
                     this.firestore.where("ownerId", "==", this.currentUser.id)
                );
               
                // 3b. Ejecutar queries en paralelo para m√°s velocidad
                const [dealsSnapshot, contactsSnapshot, companiesSnapshot] = await Promise.all([
                    this.firestore.getDocs(qDeals),
                    this.firestore.getDocs(qContacts),
                    this.firestore.getDocs(qCompanies)
                ]);

                // 3c. Poblar arrays locales con datos de Firestore
                // Guardamos el 'id' del documento junto con sus datos (...)
                this.deals = dealsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.contacts = contactsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.companies = companiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 3d. L√≥gica de limpieza (asegura que todos tengan timestamps)
                const ensureTimestamp = item => { if (!item.lastModified) item.lastModified = item.createdAt || new Date(0).toISOString(); };
                this.deals.forEach(ensureTimestamp);
                this.contacts.forEach(ensureTimestamp);
                this.companies.forEach(ensureTimestamp);
            }

            // (saveData() fue eliminada, ya no usamos localStorage)

            // 4. INICIALIZADOR DE UI: Configura listeners y UI est√°tica
            initUI() {
                console.log("Ejecutando initUI..."); 
                this.updateSidebarUser(); // Pone nombre y avatar en el perfil
                this.bindEvents();        // Activa todos los botones y listeners
                
                // Ajusta tema claro/oscuro seg√∫n preferencia del navegador
                if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
                    this.isDarkMode = false; this.toggleTheme();
                }
                console.log("initUI finalizado."); 
            }

            /**
             * 5. BIND EVENTS: El "cerebro" de todos los clics y listeners de la app.
             * (CORREGIDO para el bot√≥n "X" del modal)
             */
            bindEvents() { 
                const crmWrapper = document.getElementById('crmWrapper');
                 if (!crmWrapper) return;
                 
                 // Listener de clic principal para todo el CRM
                 crmWrapper.addEventListener('click', (e) => {
                     
                     // Navegaci√≥n Sidebar
                     const menuItem = e.target.closest('.menu-item'); 
                     if (menuItem) { 
                         e.preventDefault(); 
                         const view = menuItem.getAttribute('data-view'); 
                         if (view) this.switchView(view); 
                         return; 
                     }
                     
                     // Botones Header y Sidebar
                     if (e.target.id === 'sidebarToggle' || e.target.closest('#sidebarToggle')) { this.toggleSidebar(); return; }
                     if (e.target.id === 'themeToggle' || e.target.closest('#themeToggle')) { this.toggleTheme(); return; }
                     if (e.target.id === 'addNewBtn' || e.target.closest('#addNewBtn')) { this.handleAddNew(); return; }
                     
                     
                     // --- INICIO CORRECCI√ìN BOT√ìN MODAL "X" ---
                    
                     // 1. Cerrar Modales por Overlay o Bot√≥n "Cancelar"
                     if (e.target.classList.contains('modal-overlay') || e.target.id.includes('CancelBtn')) {
                         const modal = e.target.closest('.modal'); 
                         if (modal) this.closeModal(modal.id); 
                         return;
                     }
                    
                     // 2. CORRECCI√ìN: Usar .closest('.modal-close')
                     //    Esto funciona si se hace clic en el <button> O en el √≠cono <i> dentro de √©l.
                     if (e.target.closest('.modal-close')) {
                         const modal = e.target.closest('.modal');
                         if (modal) this.closeModal(modal.id);
                         return;
                     }
                     // --- FIN CORRECCI√ìN BOT√ìN MODAL "X" ---

                     
                     // Clics en Tarjetas para Editar (los IDs son strings de Firestore)
                     if (e.target.closest('.deal-card')) { 
                         const el = e.target.closest('.deal-card'); 
                         this.editDeal(el.getAttribute('data-deal-id')); 
                         return; 
                     }
                     if (e.target.closest('.contact-card')) { 
                         const el = e.target.closest('.contact-card'); 
                         const m = el.getAttribute('onclick')?.match(/editContact\(['"](.+?)['"]\)/); // Busca ID de string
                         if(m) this.editContact(m[1]); 
                         return; 
                     }
                     if (e.target.closest('.company-card')) { 
                         const el = e.target.closest('.company-card'); 
                         const m = el.getAttribute('onclick')?.match(/editCompany\(['"](.+?)['"]\)/); // Busca ID de string
                         if(m) this.editCompany(m[1]); 
                         return; 
                     }
                     
                     // Botones de Acci√≥n en Tablas (Editar/Eliminar)
                     if (e.target.closest('.btn-icon')) { 
                         e.stopPropagation(); 
                         const btn = e.target.closest('.btn-icon'); 
                         const oc = btn.getAttribute('onclick'); 
                         if(oc?.includes('editDeal')) { 
                             const m=oc.match(/editDeal\(['"](.+?)['"]\)/); 
                             if(m) this.editDeal(m[1]); 
                         } else if(oc?.includes('deleteDeal')) { 
                             const m=oc.match(/deleteDeal\(['"](.+?)['"]\)/); 
                             if(m) this.deleteDeal(m[1]); 
                         } 
                         return; 
                     }
                 });

                 // Listeners para Inputs de B√∫squeda y Filtros
                 const addInputListener = (id, handler) => { const el = document.getElementById(id); if (el) el.addEventListener('input', handler); };
                 const addChangeListener = (id, handler) => { const el = document.getElementById(id); if (el) el.addEventListener('change', handler); };
                 addInputListener('globalSearch', (e) => this.handleGlobalSearch(e.target.value));
                 addInputListener('pipelineSearch', () => this.filterPipeline()); 
                 addChangeListener('ownerFilter', () => this.filterPipeline());
                 addInputListener('contactsSearch', () => this.filterContacts()); 
                 addChangeListener('contactsCompanyFilter', () => this.filterContacts());
                 addInputListener('companiesSearch', () => this.filterCompanies()); 
                 addChangeListener('companiesIndustryFilter', () => this.filterCompanies());
                 addInputListener('dealsSearch', () => this.filterDeals()); 
                 addChangeListener('dealsStageFilter', () => this.filterDeals());
                 
                 // Configura listeners para submits de formularios (CRUD)
                 this.bindFormEvents();
            }

            // 5b. Binders espec√≠ficos para formularios
            bindFormEvents() { 
                 const addSubmitListener = (id, handler) => { const form = document.getElementById(id); if (form) form.addEventListener('submit', (e) => { e.preventDefault(); handler.call(this, e.target); }); };
                 const addClickListener = (id, handler) => { const btn = document.getElementById(id); if (btn) btn.addEventListener('click', handler.bind(this)); };

                 // Formulario de Negocios
                 addSubmitListener('dealForm', this.handleDealSubmit);
                 addClickListener('dealDeleteBtn', () => { if (this.editingDealId) this.deleteDeal(this.editingDealId); });
                 
                 // Formulario de Contactos
                 addSubmitListener('contactForm', this.handleContactSubmit);
                 addClickListener('contactDeleteBtn', () => { if (this.editingContactId) this.deleteContact(this.editingContactId); });
                 addClickListener('contactHistoryBtn', () => { if (this.editingContactId) this.showContactHistory(this.editingContactId); });

                 // Formulario de Empresas
                 addSubmitListener('companyForm', this.handleCompanySubmit);
                 addClickListener('companyDeleteBtn', () => { if (this.editingCompanyId) this.deleteCompany(this.editingCompanyId); });
            }


            // --- 6. FUNCIONES DE RENDERIZADO DE VISTAS ---

            // Actualiza UI del sidebar con datos del usuario
            updateSidebarUser() { 
                 const nameEl = document.querySelector('#crmWrapper .user-name');
                 const roleEl = document.querySelector('#crmWrapper .user-role');
                 const avatarEl = document.querySelector('#crmWrapper .user-avatar');
                 if (nameEl) nameEl.textContent = this.currentUser.name;
                 if (roleEl) roleEl.textContent = this.currentUser.role;
                 if (avatarEl) avatarEl.textContent = this.currentUser.avatar;
            }

            // Llena los <select> en los modales (ej: lista de contactos en modal de negocio)
            populateDropdowns() { 
                const ss = document.querySelector('#dealForm select[name="stage"]'); 
                if(ss) ss.innerHTML = this.pipelineStages.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
               
                const cs = document.querySelector('#dealForm select[name="contactId"]'); 
                if(cs) cs.innerHTML = '<option value="">Sel. contacto</option>' + this.contacts.map(c=>`<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
               
                const cos = document.querySelector('#contactForm select[name="companyId"]'); 
                if(cos) cos.innerHTML = '<option value="">Sel. empresa</option>' + this.companies.map(co=>`<option value="${co.id}">${co.name}</option>`).join('');
               
                this.populateFilterDropdowns(); // Llena los filtros de las vistas
            }

            // Llena los <select> de los filtros de las vistas
            populateFilterDropdowns() { 
                 const of = document.getElementById('ownerFilter'); 
                 if(of) of.innerHTML = '<option value="">Todos</option>'; // (Opcional: llenar con usuarios)
               
                 const ccf = document.getElementById('contactsCompanyFilter'); 
                 if(ccf) ccf.innerHTML = '<option value="">Todas</option>' + this.companies.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
               
                 const cif = document.getElementById('companiesIndustryFilter'); 
                 if(cif){ 
                     const inds=[...new Set(this.companies.map(c=>c.industry))].filter(Boolean); 
                     cif.innerHTML = '<option value="">Todas</option>' + inds.map(i=>`<option value="${i}">${i}</option>`).join(''); 
                 }
               
                 const dsf = document.getElementById('dealsStageFilter'); 
                 if(dsf) dsf.innerHTML = '<option value="">Todas</option>' + this.pipelineStages.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
            }


            // Cambia entre vistas (Dashboard, Pipeline, etc.)
            switchView(viewName) { 
                console.log(`Cambiando a vista: ${viewName}`); 
                // Actualiza men√∫ activo
                document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active')); 
                document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');
               
                // Muestra la vista correcta
                document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); 
                document.getElementById(`${viewName}-view`)?.classList.add('active');
               
                // Actualiza header y t√≠tulo de la p√°gina
                const titles = { dashboard: 'Tablero', pipeline: 'Embudo', contacts: 'Contactos', companies: 'Empresas', deals: 'Negocios' };
                const title = titles[viewName] || viewName;
                document.getElementById('pageTitle').textContent = title; 
                document.getElementById('breadcrumbCurrent').textContent = title;
                document.title = `${title} - CRM Pro`; 
                this.currentView = viewName;

                // Carga el contenido espec√≠fico de la vista
                try {
                    console.log(`Cargando contenido para ${viewName}...`); 
                    switch(viewName){ 
                        case 'dashboard': this.loadDashboard(); break; 
                        case 'pipeline': this.loadPipeline(); break; 
                        case 'contacts': this.loadContacts(); break; 
                        case 'companies': this.loadCompanies(); break; 
                        case 'deals': this.loadDeals(); break; 
                    }
                     console.log(`Contenido para ${viewName} cargado.`); 
                } catch (error) {
                    console.error(`Error cargando la vista ${viewName}:`, error);
                    this.showToast('error', 'Error', `No se pudo cargar la vista ${title}`);
                }
            }

             // Carga contenido del Dashboard
            loadDashboard() {
                console.log("Cargando Dashboard..."); 
                try {
                    this.updateMetrics();       // Actualiza tarjetas de m√©tricas
                    this.loadPipelineChart();   // Dibuja el gr√°fico
                    this.loadActivityFeed();    // Muestra actividad reciente
                    console.log("Dashboard cargado."); 
                } catch (error) {
                    console.error("Error en loadDashboard:", error);
                }
            }

            // Calcula y muestra m√©tricas (Ingresos, Negocios Activos, etc.)
            updateMetrics() { 
                 const wonDeals = this.deals.filter(d => d.stage === 'closed-won');
                 const totalRevenueUSD = wonDeals.filter(d => d.currency === 'USD').reduce((s, d) => s + (parseFloat(d.amount) || 0), 0);
                 const totalRevenueBOB = wonDeals.filter(d => d.currency === 'BOB').reduce((s, d) => s + (parseFloat(d.amount) || 0), 0);
                 const activeDeals = this.deals.filter(d => !['closed-won', 'closed-lost'].includes(d.stage)).length;
                 const totalContacts = this.contacts.length;
                 const closedDeals = this.deals.filter(d => ['closed-won', 'closed-lost'].includes(d.stage)).length; 
                 const conversionRate = closedDeals > 0 ? ((wonDeals.length / closedDeals) * 100).toFixed(1) : 0;

                 let revenueString = '';
                 if (totalRevenueUSD > 0) revenueString += this.formatCurrency(totalRevenueUSD, 'USD');
                 if (totalRevenueBOB > 0) { if (revenueString) revenueString += ' / '; revenueString += this.formatCurrency(totalRevenueBOB, 'BOB'); }

                 try {
                     document.getElementById('totalRevenue').textContent = revenueString || '$0.00';
                     document.getElementById('activeDeals').textContent = activeDeals;
                     document.getElementById('totalContacts').textContent = totalContacts;
                     document.getElementById('conversionRate').textContent = `${conversionRate}%`;
                 } catch (e) { console.warn("Error actualizando m√©tricas UI:", e); }
            }

            // Dibuja/Actualiza gr√°fico de embudo
            loadPipelineChart() { 
                console.log("Cargando gr√°fico..."); 
                const canvas = document.getElementById('pipelineChart'); 
                if (!canvas) { console.warn("Canvas no encontrado"); return; } 
                try {
                    const ctx = canvas.getContext('2d');
                    const stageCounts = this.pipelineStages.reduce((acc, stage) => { acc[stage.id] = this.deals.filter(d => d.stage === stage.id).length; return acc; }, {});
                    const chartData = this.pipelineStages
                        .filter(s => !['closed-lost'].includes(s.id)) // Ocultar perdidos del gr√°fico
                        .sort((a,b) => a.order - b.order)
                        .map(stage => ({ 
                            label: stage.name, 
                            count: stageCounts[stage.id] || 0, 
                            color: stage.color 
                        }));

                    // Destruir gr√°fico anterior si existe
                    if (window.pipelineChart?.destroy) window.pipelineChart.destroy(); 
                   
                    window.pipelineChart = new Chart(ctx, { 
                        type: 'doughnut', 
                        data: { 
                            labels: chartData.map(d => d.label), 
                            datasets: [{ 
                                data: chartData.map(d => d.count), 
                                backgroundColor: chartData.map(d=>d.color), 
                                borderWidth: 0 
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } } 
                            } 
                        } 
                    });
                    console.log("Gr√°fico cargado."); 
                } catch (error) {
                    console.error("Error al dibujar el gr√°fico:", error);
                }
            }

            // Muestra actividad reciente en el Dashboard
            loadActivityFeed() { 
                 const activityFeed = document.getElementById('activityFeed');
                 if (!activityFeed) return;

                 // Combinar todos los items (deals, contacts, companies)
                 const allItems = [
                     ...this.deals.map(d => ({ ...d, type: 'Negocio', name: d.title })),
                     ...this.contacts.map(c => ({ ...c, type: 'Contacto', name: `${c.firstName} ${c.lastName}` })),
                     ...this.companies.map(co => ({ ...co, type: 'Empresa', name: co.name }))
                 ];
                 
                 // Ordenarlos por fecha de modificaci√≥n y tomar los 5 m√°s recientes
                 const recentItems = allItems
                     .filter(item => item.lastModified) 
                     .sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified))
                     .slice(0, 5);

                 if (recentItems.length === 0) {
                     activityFeed.innerHTML = `<div class="empty-state" style="padding: 16px;"><i class="fas fa-history"></i><p>No hay actividad reciente.</p></div>`;
                     return;
                 }

                 // Renderizar HTML para cada item de actividad
                 activityFeed.innerHTML = recentItems.map(item => {
                     const timeAgo = this.formatTimeAgo(item.lastModified);
                     const action = (item.createdAt === item.lastModified) ? 'creado' : 'modificado';
                     const avatarInitials = item.name ? item.name.substring(0, 2).toUpperCase() : '??'; 

                     return `
                         <div class="activity-item">
                             <div class="activity-avatar" title="${item.type}">${avatarInitials}</div>
                             <div class="activity-content">
                                 <p class="activity-text">
                                      ${item.type} <strong>${item.name}</strong> ${action}.
                                 </p>
                                 <span class="activity-time">${timeAgo}</span>
                             </div>
                         </div>
                     `;
                 }).join('');
            }
           
            // Carga la vista de Pipeline (Kanban)
            loadPipeline() { 
                const b=document.getElementById('pipelineBoard'); 
                if (!b) return; 
                b.innerHTML = ''; // Limpiar spinner
               
                // Crear una columna por cada etapa
                this.pipelineStages.sort((a,b)=>a.order-b.order).forEach(st=>{
                    const d=this.deals.filter(dl=>dl.stage===st.id); // Negocios en esta etapa
                    const c=document.createElement('div');
                    c.className='pipeline-column';
                    c.setAttribute('data-stage',st.id);
                    c.innerHTML=`
                        <div class="pipeline-column-header">
                            <div class="column-title"><div class="column-indicator" style="background-color:${st.color}"></div> ${st.name}</div>
                            <div class="column-count">${d.length}</div>
                        </div>
                        <div class="pipeline-column-body" data-stage="${st.id}">
                            ${d.length>0 ? d.map(dl=>this.createDealCard(dl)).join('') : '<div class="empty-state" style="padding:16px"><i class="fas fa-folder-open"></i><p>No hay negocios.</p></div>'}
                        </div>`;
                    b.appendChild(c);
                }); 
                this.setupDragAndDrop(); // Activar drag-and-drop
            }

            // Crea el HTML para una tarjeta de negocio (en el Pipeline)
            createDealCard(deal) { 
                const c=this.contacts.find(co=>co.id===deal.contactId);
                const n=c?`${c.firstName} ${c.lastName}`:'Sin contacto';
                return `
                    <div class="deal-card" draggable="true" data-deal-id="${deal.id}">
                        <h4 class="deal-title">${deal.title}</h4>
                        <p class="deal-amount">${this.formatCurrency(deal.amount,deal.currency)}</p>
                        <div class="deal-meta">
                            <span class="deal-contact"><i class="fas fa-user"></i> ${n}</span>
                            <span class="deal-probability">${deal.probability}%</span>
                        </div>
                    </div>`; 
            }

            // Configura los listeners para drag-and-drop
            setupDragAndDrop() { 
                const cs=document.querySelectorAll('.deal-card');
                const cols=document.querySelectorAll('.pipeline-column-body');
                cs.forEach(c=>{
                    c.addEventListener('dragstart',e=>{ 
                        e.dataTransfer.setData('text/plain',c.getAttribute('data-deal-id')); 
                        c.classList.add('dragging'); 
                    });
                    c.addEventListener('dragend',()=>c.classList.remove('dragging'));
                });
                cols.forEach(co=>{
                    co.addEventListener('dragover',e=>{ e.preventDefault(); co.parentElement.classList.add('drag-over'); });
                    co.addEventListener('dragleave',e=>{ if(!co.contains(e.relatedTarget)) co.parentElement.classList.remove('drag-over'); });
                    co.addEventListener('drop',e=>{ 
                        e.preventDefault(); 
                        const id=e.dataTransfer.getData('text/plain'); // ID del negocio (string)
                        const ns=co.getAttribute('data-stage'); // ID de la nueva etapa
                        this.moveDeal(id,ns); // Mover el negocio
                        co.parentElement.classList.remove('drag-over'); 
                    });
                }); 
            }
           
            // Mueve un negocio a una nueva etapa (actualiza Firestore)
            async moveDeal(dealId, newStage) {
                const d = this.deals.find(dl => dl.id === dealId);
                if (!d) return;
                const s = this.pipelineStages.find(st => st.id === newStage);
                if (!s) return;
               
                // Datos a actualizar
                const updateData = {
                    stage: newStage,
                    probability: s.defaultProbability,
                    lastModified: new Date().toISOString()
                };

                try {
                    // 1. Actualizar Firestore
                    const dealRef = this.firestore.doc(this.db, "deals", dealId);
                    await this.firestore.updateDoc(dealRef, updateData);

                    // 2. Actualizar array local (cach√©)
                    Object.assign(d, updateData);
                   
                    this.loadPipeline(); // Recargar vista del pipeline
                    this.showToast('success', 'Negocio movido', `"${d.title}" movido`);
                } catch (error) {
                    console.error("Error al mover negocio:", error);
                    this.showToast('error', 'Error', 'No se pudo mover el negocio.');
                }
            }
           
            // Carga la vista de Contactos
            loadContacts() { 
                this.renderContacts(this.contacts); // Renderiza todos
            }
            // Renderiza la cuadr√≠cula de contactos
            renderContacts(contacts) { 
                const grid=document.getElementById('contactsGrid');
                if(!grid)return;
                if(contacts.length===0){
                    grid.innerHTML=`<div class="empty-state"><i class="fas fa-users"></i><h3>No hay contactos</h3><p>Agrega el primero</p></div>`;
                    return;
                }
                grid.innerHTML=contacts.map(c=>{
                    const co=this.companies.find(cp=>cp.id===c.companyId);
                    const cn=co?co.name:'Sin empresa';
                    const initials=`${c.firstName?c.firstName[0]:''}${c.lastName?c.lastName[0]:''}`.toUpperCase();
                    // Usamos ID de string en el onclick
                    return`
                    <div class="contact-card" onclick="crm.editContact('${c.id}')">
                        <div class="contact-header">
                            <div class="contact-avatar">${initials}</div>
                            <div class="contact-info">
                                <h3>${c.firstName} ${c.lastName}</h3>
                                <p class="contact-email">${c.email}</p>
                            </div>
                        </div>
                        <div class="contact-details">
                            <div class="contact-detail"><span>Empresa:</span><span>${cn}</span></div>
                            <div class="contact-detail"><span>Tel√©fono:</span><span>${c.phone||'N/A'}</span></div>
                            <div class="contact-detail"><span>Puntuaci√≥n:</span><span>${c.score}/100</span></div>
                        </div>
                        ${c.tags?.length>0?`<div class="contact-tags">${c.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>`:''}
                    </div>`;
                }).join(''); 
            }
           
            // Carga la vista de Empresas
            loadCompanies() { 
                this.renderCompanies(this.companies); // Renderiza todas
            }
            // Renderiza la cuadr√≠cula de empresas
            renderCompanies(companies) { 
                const grid=document.getElementById('companiesGrid');
                if(!grid)return;
                if(companies.length===0){
                    grid.innerHTML=`<div class="empty-state"><i class="fas fa-building"></i><h3>No hay empresas</h3><p>Agrega la primera</p></div>`;
                    return;
                }
                grid.innerHTML=companies.map(c=>{
                    const cc=this.contacts.filter(ct=>ct.companyId===c.id).length;
                    const dc=this.deals.filter(d=>this.contacts.find(ct=>ct.id===d.contactId)?.companyId===c.id).length; 
                    const initials = c.name ? c.name[0].toUpperCase() : '?'; 
                    // Usamos ID de string en el onclick
                    return`
                    <div class="company-card" onclick="crm.editCompany('${c.id}')">
                        <div class="company-header">
                            <div class="company-avatar">${initials}</div>
                            <div class="company-info">
                                <h3>${c.name}</h3>
                                <p class="company-industry">${c.industry}</p>
                            </div>
                        </div>
                        <div class="company-details">
                            <div class="company-detail"><span>Tama√±o:</span><span>${c.size}</span></div>
                            <div class="company-detail"><span>Ubicaci√≥n:</span><span>${c.location||'N/A'}</span></div>
                            <div class="company-detail"><span>Contactos:</span><span>${cc}</span></div>
                            <div class="company-detail"><span>Negocios:</span><span>${dc}</span></div>
                        </div>
                    </div>`;
                }).join(''); 
            }
           
            // Carga la vista de lista de Negocios
            loadDeals() { 
                this.renderDeals(this.deals); // Renderiza todos
            }
            // Renderiza la tabla de negocios
            renderDeals(deals) { 
                const tbody=document.getElementById('dealsTableBody');
                if(!tbody)return;
               
                // Si no hay negocios, muestra estado vac√≠o (esto reemplaza el <tr> de carga)
                if(deals.length===0){
                    tbody.innerHTML=`<tr><td colspan="7" class="empty-state"><i class="fas fa-handshake"></i><h3>No hay negocios</h3><p>Agrega el primero</p></td></tr>`;
                    return;
                }
               
                // Si hay negocios, renderiza las filas (esto reemplaza el <tr> de carga)
                tbody.innerHTML=deals.map(d=>{
                    const c=this.contacts.find(ct=>ct.id===d.contactId);
                    const cn=c?`${c.firstName} ${c.lastName}`:'Sin contacto';
                    const s=this.pipelineStages.find(st=>st.id===d.stage);
                    const closeDate = d.closeDate ? new Date(d.closeDate).toLocaleDateString('es-ES') : 'N/A'; 
                    // Usamos IDs de string en los onclick
                    return`
                    <tr>
                        <td data-label="T√≠tulo">${d.title}</td>
                        <td data-label="Monto">${this.formatCurrency(d.amount,d.currency)}</td>
                        <td data-label="Etapa"><span class="stage-badge"><div class="stage-indicator" style="background-color:${s?.color || '#ccc'}"></div> ${s?.name || d.stage}</span></td>
                        <td data-label="Probabilidad"><div class="probability-bar"><div class="probability-fill" style="width:${d.probability}%"></div></div> ${d.probability}%</td>
                        <td data-label="Fecha Cierre">${closeDate}</td>
                        <td data-label="Contacto">${cn}</td>
                        <td data-label="Acciones">
                            <div class="deal-actions">
                                <button class="btn-icon" onclick="crm.editDeal('${d.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon" onclick="crm.deleteDeal('${d.id}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                }).join(''); 
            }
           
           
            // --- 7. FILTROS Y B√öSQUEDA (Usan arrays locales) ---
           
            filterPipeline() { 
                const s=document.getElementById('pipelineSearch')?.value.toLowerCase()||'';
                const o=document.getElementById('ownerFilter')?.value||'';
                let f=this.deals;
                if(s)f=f.filter(d=>d.title.toLowerCase().includes(s));
                if(o)f=f.filter(d=>d.ownerId==o);
               
                // Re-renderizar pipeline con datos filtrados
                const b=document.getElementById('pipelineBoard');
                if(!b)return;
                b.innerHTML='';
                this.pipelineStages.sort((a,b)=>a.order-b.order).forEach(st=>{
                    const sd=f.filter(d=>d.stage===st.id);
                    const cl=document.createElement('div');
                    cl.className='pipeline-column';
                    cl.setAttribute('data-stage',st.id);
                    cl.innerHTML=`<div class="pipeline-column-header"><div class="column-title"><div class="column-indicator" style="background-color:${st.color}"></div> ${st.name}</div><div class="column-count">${sd.length}</div></div><div class="pipeline-column-body" data-stage="${st.id}">${sd.length>0?sd.map(d=>this.createDealCard(d)).join(''):'<div class="empty-state" style="padding:16px"><i class="fas fa-folder-open"></i><p>No hay negocios.</p></div>'}</div>`;
                    b.appendChild(cl);
                });
                this.setupDragAndDrop(); 
            }
            filterContacts() { 
                const s=document.getElementById('contactsSearch')?.value.toLowerCase()||'';
                const c=document.getElementById('contactsCompanyFilter')?.value||'';
                let f=this.contacts;
                if(s)f=f.filter(ct=>`${ct.firstName} ${ct.lastName} ${ct.email}`.toLowerCase().includes(s));
                if(c)f=f.filter(ct=>ct.companyId==c);
                this.renderContacts(f); 
            }
            filterCompanies() { 
                const s=document.getElementById('companiesSearch')?.value.toLowerCase()||'';
                const i=document.getElementById('companiesIndustryFilter')?.value||'';
                let f=this.companies;
                if(s)f=f.filter(c=>`${c.name} ${c.location}`.toLowerCase().includes(s));
                if(i)f=f.filter(c=>c.industry===i);
                this.renderCompanies(f); 
            }
            filterDeals() { 
                const s=document.getElementById('dealsSearch')?.value.toLowerCase()||'';
                const st=document.getElementById('dealsStageFilter')?.value||'';
                let f=this.deals;
                if(s)f=f.filter(d=>d.title.toLowerCase().includes(s));
                if(st)f=f.filter(d=>d.stage===st);
                this.renderDeals(f); 
            }
            handleGlobalSearch(q) { 
                if(!q)return;
                q=q.toLowerCase();
                const r=[];
                this.deals.forEach(d=>{if(d.title.toLowerCase().includes(q))r.push({t:'deal',i:d});});
                this.contacts.forEach(c=>{if(`${c.firstName} ${c.lastName} ${c.email}`.toLowerCase().includes(q))r.push({t:'contact',i:c});});
                this.companies.forEach(co=>{if(co.name.toLowerCase().includes(q))r.push({t:'company',i:co});});
                if(r.length>0)this.showToast('info','B√∫squeda',`${r.length} resultados`);
                else this.showToast('info','B√∫squeda',`No hay resultados`); 
            }
           
            // --- 8. FUNCIONES CRUD (Crear, Leer, Actualizar, Borrar) ---
           
            // Abre el modal correcto seg√∫n la vista actual
            handleAddNew() { 
                switch(this.currentView){
                    case 'deals':case 'pipeline':this.openModal('dealModal');break;
                    case 'contacts':this.openModal('contactModal');break;
                    case 'companies':this.openModal('companyModal');break;
                    default:this.openModal('dealModal');break;
                } 
            }

            // CREAR o ACTUALIZAR un Negocio en Firestore
            async handleDealSubmit(form) {
                const fd = new FormData(form);
                const contactId = fd.get('contactId') ? fd.get('contactId') : null; // IDs son strings
                let companyId = null; 
                if(contactId){ const c = this.contacts.find(ct=>ct.id===contactId); if(c) companyId = c.companyId; }
                const now = new Date().toISOString();
               
                // Datos del formulario
                const dealData = { 
                    title: fd.get('title'), 
                    amount: parseFloat(fd.get('amount')), 
                    currency: fd.get('currency'), 
                    stage: fd.get('stage'), 
                    probability: parseInt(fd.get('probability') || this.pipelineStages.find(s=>s.id===fd.get('stage'))?.defaultProbability || 0), 
                    closeDate: fd.get('closeDate') || null, 
                    contactId, 
                    companyId, 
                    notes: fd.get('notes'), 
                    lastModified: now 
                };

                try {
                    if (this.editingDealId) {
                        // ACTUALIZAR (Update)
                        const dealRef = this.firestore.doc(this.db, "deals", this.editingDealId);
                        await this.firestore.updateDoc(dealRef, dealData);
                       
                        // Actualizar cach√© local
                        const deal = this.deals.find(d => d.id === this.editingDealId);
                        if(deal) Object.assign(deal, dealData);
                       
                        this.showToast('success','Negocio actualizado');
                    } else {
                        // CREAR (Create)
                        const dealToCreate = {
                            ...dealData,
                            ownerId: this.currentUser.id, // A√±adir ID del propietario
                            createdAt: now
                        };
                        const docRef = await this.firestore.addDoc(this.firestore.collection(this.db, "deals"), dealToCreate);
                       
                        // A√±adir a cach√© local con el nuevo ID de Firestore
                        this.deals.push({ id: docRef.id, ...dealToCreate });
                       
                        this.showToast('success','Negocio creado');
                    }
                   
                    this.closeModal('dealModal');
                    this.switchView(this.currentView); // Recargar la vista actual
                    this.editingDealId = null; // Limpiar ID de edici√≥n

                } catch (error) {
                    console.error("Error guardando negocio:", error);
                    this.showToast('error', 'Error', 'No se pudo guardar el negocio.');
                }
            }
           
            // CREAR o ACTUALIZAR un Contacto en Firestore
            async handleContactSubmit(form) {
                const fd = new FormData(form);
                const now = new Date().toISOString();
                const contactData = { 
                    firstName: fd.get('firstName'), 
                    lastName: fd.get('lastName'), 
                    email: fd.get('email'), 
                    phone: fd.get('phone') || null, 
                    companyId: fd.get('companyId') ? fd.get('companyId') : null, // IDs son strings
                    score: parseInt(fd.get('score') || 50), 
                    tags: fd.get('tags')?.split(',').map(t=>t.trim()).filter(Boolean) || [], 
                    lastModified: now 
                };

                try {
                    if (this.editingContactId) {
                        // ACTUALIZAR
                        const contactRef = this.firestore.doc(this.db, "contacts", this.editingContactId);
                        await this.firestore.updateDoc(contactRef, contactData);
                       
                        const contact = this.contacts.find(c => c.id === this.editingContactId);
                        if(contact) Object.assign(contact, contactData);
                       
                        this.showToast('success','Contacto actualizado');
                    } else {
                        // CREAR
                        const contactToCreate = {
                            ...contactData,
                            ownerId: this.currentUser.id,
                            createdAt: now
                        };
                        const docRef = await this.firestore.addDoc(this.firestore.collection(this.db, "contacts"), contactToCreate);
                       
                        this.contacts.push({ id: docRef.id, ...contactToCreate });
                       
                        this.showToast('success','Contacto creado');
                    }
                   
                    this.closeModal('contactModal');
                    this.switchView(this.currentView);
                    this.populateDropdowns(); // Actualizar selects que dependen de contactos
                    this.editingContactId = null;

                } catch (error) {
                     console.error("Error guardando contacto:", error);
                    this.showToast('error', 'Error', 'No se pudo guardar el contacto.');
                }
            }

            // CREAR o ACTUALIZAR una Empresa en Firestore
            async handleCompanySubmit(form) {
                const fd = new FormData(form);
                const now = new Date().toISOString();
                const companyData = { 
                    name: fd.get('name'), 
                    industry: fd.get('industry'), 
                    size: fd.get('size'), 
                    website: fd.get('website') || null, 
                    revenue: parseFloat(fd.get('revenue')) || 0, 
                    location: fd.get('location') || null, 
                    lastModified: now 
                };
               
                try {
                    if (this.editingCompanyId) {
                        // ACTUALIZAR
                        const coRef = this.firestore.doc(this.db, "companies", this.editingCompanyId);
                        await this.firestore.updateDoc(coRef, companyData);
                       
                        const co = this.companies.find(c => c.id === this.editingCompanyId);
                        if(co) Object.assign(co, companyData);
                       
                        this.showToast('success','Empresa actualizada');
                    } else {
                        // CREAR
                        const companyToCreate = {
                            ...companyData,
                            ownerId: this.currentUser.id, // A√±adir ownerId (corregido)
                            createdAt: now
                        };
                        const docRef = await this.firestore.addDoc(this.firestore.collection(this.db, "companies"), companyToCreate);
                       
                        this.companies.push({ id: docRef.id, ...companyToCreate });
                       
                        this.showToast('success','Empresa creada');
                    }
                   
                    this.closeModal('companyModal');
                    this.switchView(this.currentView);
                    this.populateDropdowns(); // Actualizar selects que dependen de empresas
                    this.editingCompanyId = null;

                } catch (error)
                 {
                     console.error("Error guardando empresa:", error);
                    this.showToast('error', 'Error', 'No se pudo guardar la empresa.');
                }
            }
           
            // Abre modal para EDITAR Negocio
            editDeal(id){
                const d=this.deals.find(dl=>dl.id===id);
                if(!d)return;
                this.openModal('dealModal');
                document.getElementById('dealModalTitle').textContent='Editar Negocio';
                document.getElementById('dealDeleteBtn').classList.remove('hidden');
                const f=document.getElementById('dealForm');
                f.title.value=d.title;
                f.amount.value=d.amount;
                f.currency.value=d.currency;
                f.stage.value=d.stage;
                f.probability.value=d.probability;
                f.closeDate.value=d.closeDate;
                f.contactId.value=d.contactId||'';
                f.notes.value=d.notes||'';
                this.editingDealId=id; // Guarda el ID para el submit
            }
           
            // Abre modal para EDITAR Contacto
            editContact(id){
                const c=this.contacts.find(ct=>ct.id===id);
                if(!c)return;
                this.openModal('contactModal');
                document.getElementById('contactModalTitle').textContent='Editar Contacto';
                document.getElementById('contactHistoryBtn').classList.remove('hidden');
                document.getElementById('contactDeleteBtn').classList.remove('hidden');
                const f=document.getElementById('contactForm');
                f.firstName.value=c.firstName;
                f.lastName.value=c.lastName;
                f.email.value=c.email;
                f.phone.value=c.phone||'';
                f.companyId.value=c.companyId||'';
                f.score.value=c.score;
                f.tags.value=c.tags?.join(', ')||'';
                this.editingContactId=id; // Guarda el ID
            }
           
            // Abre modal para EDITAR Empresa
            editCompany(id){
                const c=this.companies.find(co=>co.id===id);
                if(!c)return;
                this.openModal('companyModal');
                document.getElementById('companyModalTitle').textContent='Editar Empresa';
                document.getElementById('companyDeleteBtn').classList.remove('hidden');
                const f=document.getElementById('companyForm');
                f.name.value=c.name;
                f.industry.value=c.industry;
                f.size.value=c.size;
                f.website.value=c.website||'';
                f.revenue.value=c.revenue||'';
                f.location.value=c.location||'';
                this.editingCompanyId=id; // Guarda el ID
            }
           
            // ELIMINAR un Negocio de Firestore
            async deleteDeal(id) { 
                if(!confirm('¬øEst√°s seguro de eliminar este negocio?')) return; 
                try {
                    // 1. Eliminar de Firestore
                    await this.firestore.deleteDoc(this.firestore.doc(this.db, "deals", id));
                   
                    // 2. Eliminar de cach√© local
                    this.deals = this.deals.filter(dl => dl.id !== id);
                   
                    this.showToast('success', 'Negocio eliminado');
                    this.closeModal('dealModal');
                    this.switchView(this.currentView); // Recargar vista
                } catch (error) {
                    console.error("Error eliminando negocio:", error);
                    this.showToast('error', 'Error', 'No se pudo eliminar el negocio.');
                }
            }
           
            // ELIMINAR un Contacto de Firestore
            async deleteContact(id) { 
                if(!confirm('¬øEst√°s seguro de eliminar este contacto? (Esto lo desvincular√° de negocios existentes)')) return; 
                try {
                    // 1. Eliminar de Firestore
                    await this.firestore.deleteDoc(this.firestore.doc(this.db, "contacts", id));

                    // 2. Eliminar de cach√© local
                    this.contacts = this.contacts.filter(ct => ct.id !== id);
                    // 3. Desvincular de negocios locales (opcional, se actualizar√° al guardar negocio)
                    this.deals.forEach(d => { if(d.contactId === id) d.contactId = null; }); 
                   
                    this.showToast('success', 'Contacto Eliminado');
                    this.closeModal('contactModal');
                    this.switchView(this.currentView);
                    this.populateDropdowns(); // Actualizar selects
                } catch (error) {
                    console.error("Error eliminando contacto:", error);
                    this.showToast('error', 'Error', 'No se pudo eliminar el contacto.');
                }
            }
           
            // ELIMINAR una Empresa de Firestore
            async deleteCompany(id) { 
                if(!confirm('¬øEst√°s seguro de eliminar esta empresa? (Esto la desvincular√° de contactos existentes)')) return; 
                try {
                    // 1. Eliminar de Firestore
                    await this.firestore.deleteDoc(this.firestore.doc(this.db, "companies", id));

                    // 2. Eliminar de cach√© local
                    this.companies = this.companies.filter(co => co.id !== id);
                    // 3. Desvincular de contactos locales
                    this.contacts.forEach(ct => { if(ct.companyId === id) ct.companyId = null; }); 
                   
                    this.showToast('success', 'Empresa Eliminada');
                    this.closeModal('companyModal');
                    this.switchView(this.currentView);
                    this.populateDropdowns(); // Actualizar selects
                } catch (error) {
                    console.error("Error eliminando empresa:", error);
                    this.showToast('error', 'Error', 'No se pudo eliminar la empresa.');
                }
            }
           
            // Muestra el historial de un contacto (solo lee de datos locales)
            showContactHistory(id) { 
                const c=this.contacts.find(ct=>ct.id===id);
                if(!c)return;
                document.getElementById('historyModalTitle').textContent=`Historial de ${c.firstName}`;
                const ad=this.deals.filter(d=>d.contactId===id); // Negocios asociados
                let dh='<h4>Negocios</h4>';
                if(ad.length>0){
                    dh+='<ul>';
                    ad.forEach(d=>{
                        const s=this.pipelineStages.find(st=>st.id===d.stage);
                        dh+=`<li><strong>${d.title}</strong> - ${this.formatCurrency(d.amount,d.currency)} (${s?.name||'?'})</li>`;
                    });
                    dh+='</ul>';
                }else{
                    dh+='<p>No hay negocios.</p>';
                }
                document.getElementById('historyModalBody').innerHTML=`<p><strong>Email:</strong> ${c.email}</p><p><strong>Tel√©fono:</strong> ${c.phone||'N/A'}</p><hr>${dh}`;
                this.openModal('historyModal'); 
            }
           
           
            // --- 9. FUNCIONES AUXILIARES (Helpers) ---
           
            // Abre un modal por su ID
            openModal(id){
                const m=document.getElementById(id);
                if(m){
                    // Limpia formulario si existe
                    if(m.querySelector('form')) this.resetForm(m.querySelector('form').id);
                    // Oculta botones de eliminar/historial
                    m.querySelectorAll('.btn--danger,.btn--secondary').forEach(b=>b.classList.add('hidden'));
                   
                    // Resetea t√≠tulos y IDs de edici√≥n
                    if(id==='dealModal'){
                        document.getElementById('dealModalTitle').textContent='Agregar Negocio';
                        this.editingDealId=null;
                    }else if(id==='contactModal'){
                        document.getElementById('contactModalTitle').textContent='Agregar Contacto';
                        this.editingContactId=null;
                    }else if(id==='companyModal'){
                        document.getElementById('companyModalTitle').textContent='Agregar Empresa';
                        this.editingCompanyId=null;
                    }
                   
                    m.classList.remove('hidden'); // Muestra el modal
                    document.body.style.overflow='hidden'; // Evita scroll de fondo
                }
            }
           
            // Cierra un modal por su ID
            closeModal(id){
                const m=document.getElementById(id);
                if(m){
                    m.classList.add('hidden'); // Oculta el modal
                    document.body.style.overflow='auto'; // Restaura scroll
                }
            }
           
            // Resetea un formulario por su ID
            resetForm(id){
                const f=document.getElementById(id);
                if(f) f.reset();
            }
           
            // Contrae/Expande la sidebar
            toggleSidebar(){
                const s=document.getElementById('sidebar');
                if(s){
                    s.classList.toggle('collapsed');
                    this.sidebarCollapsed=!this.sidebarCollapsed;
                }
            }
           
            // Cambia entre modo claro y oscuro
            toggleTheme(){
                this.isDarkMode=!this.isDarkMode;
                const h=document.documentElement; // <html>
                const t=document.getElementById('themeToggle');
                if(this.isDarkMode){
                    h.setAttribute('data-color-scheme','dark');
                    if(t) t.innerHTML='<i class="fas fa-sun"></i>';
                }else{
                    h.setAttribute('data-color-scheme','light');
                    if(t) t.innerHTML='<i class="fas fa-moon"></i>';
                }
            }
           
            // Muestra una notificaci√≥n (toast)
            showToast(type,title,message){
                const t=document.createElement('div');
                t.className=`toast ${type}`;
                const i={success:'fa-check-circle',error:'fa-exclamation-circle',info:'fa-info-circle'};
                t.innerHTML=`
                    <i class="toast-icon fas ${i[type]}"></i>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close"><i class="fas fa-times"></i></button>`;
                document.getElementById('toastContainer').appendChild(t);
                // Auto-cierre
                setTimeout(()=>{ if(t.parentNode) t.remove(); }, 5000);
                // Cierre manual
                t.querySelector('.toast-close').addEventListener('click',()=>{ if(t.parentNode) t.remove(); });
            }

            // Formatea "hace X tiempo"
            formatTimeAgo(isoString) { 
                const d=new Date(isoString);
                const s=Math.floor((new Date()-d)/1000);
                let i=Math.floor(s/31536000);
                if(i>1)return`hace ${i} a√±os`;
                i=Math.floor(s/2592000);
                if(i>1)return`hace ${i} meses`;
                i=Math.floor(s/86400);
                if(i>1)return`hace ${i} d√≠as`;
                i=Math.floor(s/3600);
                if(i>1)return`hace ${i} horas`;
                i=Math.floor(s/60);
                if(i>1)return`hace ${i} minutos`;
                return `hace ${Math.floor(s)} seg.`; 
            }

            // Formatea moneda
            formatCurrency(amount, currency) { 
                if(currency==='BOB') return new Intl.NumberFormat('es-BO',{style:'currency',currency:'BOB'}).format(amount);
                return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(amount); 
            }

        } // Fin clase CRMApp
    </script>
    </body>
</html>
